<script>
/* Normalizador de status do back -> UI */
const StatusMap = {
  toUi: function(val){
    var s = String(val || '').trim().toLowerCase();
    if (s === 'pendente') return 'pendente';
    if (s === 'concluida' || s === 'conclu√≠da') return 'concluida';
    return s || 'pendente';
  }
};

var API = {
  /* loginUser(login, pin) -> { ok, user:{uid,...} } */
  login: function(login, pin){
    return new Promise(function(resolve){
      google.script.run
        .withSuccessHandler(function(res){
          console.log('[API.login] success', res);
          if(res && res.ok && res.user && res.user.uid){
            State.uid = res.user.uid;
            resolve(res);
          } else {
            if (res && res.error) console.warn('[API.login] server error:', res.error);
            resolve({ ok:false });
          }
        })
        .withFailureHandler(function(err){
          console.error('[API.login] failure', err);
          resolve({ ok:false });
        })
        .loginUser(login, pin);
    });
  },

  /* listActivitiesApi() -> { ok, items:[...] } */
  listMinhasAtividades: function(){
    return new Promise(function(resolve, reject){
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.ok){
            var data = (res.items || []).map(function(a){
              return {
                id: a.id,
                titulo: a.titulo || a.descricao || '',
                descricao: a.descricao || '',
                data: a.data || '',
                categoria: a.categoria || '',
                categoriaAtividadeId: a.categoria_atividade_id || '',
                categoriaAtividadeNome: a.categoria_atividade_nome || '',
                categoriaAtividadeIcone: a.categoria_atividade_icone || '',
                categoriaAtividadeCor: a.categoria_atividade_cor || '',
                status: StatusMap.toUi(a.status),
                uid: a.atribuido_uid || '',
                usuarioNome: a.atribuido_nome || '',
                atualizadoPorNome: a.atualizado_nome || '',
                atualizadoEm: a.atualizado_em || ''
              };
            });
            resolve(data);
          } else {
            reject((res && res.error) || 'Falha na listagem');
          }
        })
        .withFailureHandler(reject)
        .listActivitiesApi();
    });
  },

  /* completeActivity(id, uid) -> { ok:true } */
  concluir: function(id){
    return new Promise(function(resolve, reject){
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.ok){
            resolve({
              ok: true,
              status: 'concluida',
              atualizadoPorNome: res.atualizadoPorNome || null
            });
          } else {
            reject((res && res.error) || 'Falha ao concluir');
          }
        })
        .withFailureHandler(reject)
        .completeActivity(id, State.uid);
    });
  },

  /* createActivity(payload, uidCriador) -> { ok, id } */
  criar: function(payload){
    return new Promise(function(resolve, reject){
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.ok){ resolve(res); } else { reject((res && res.error) || 'Falha ao criar'); }
        })
        .withFailureHandler(reject)
        .createActivity(payload, State.uid);
    });
  },

  /* listActiveUsers() -> { ok, users:[{uid,nome,login}] } */
  listarUsuariosAtivos: function(){
    return new Promise(function(resolve, reject){
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.ok){ resolve(res.users || []); }
          else { reject((res && res.error) || 'Falha ao listar usu√°rios'); }
        })
        .withFailureHandler(reject)
        .listActiveUsers();
    });
  },

  /* updateActivity(id, patch) -> { ok } */
  atualizar: function(id, patch){
    return new Promise(function(resolve, reject){
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.ok){ resolve(res); }
          else { reject((res && res.error) || 'Falha ao alterar'); }
        })
        .withFailureHandler(reject)
        .updateActivity({ id:id, patch: patch }, (window.State && State.uid));
    });
  },

  /* getActivityById(id) -> item normalizado */
  getAtividadePorId: function(id){
    return new Promise(function(resolve, reject){
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.ok && res.item){
            var a = res.item;
            resolve({
              id: a.id,
              titulo: a.titulo || a.descricao || '',
              descricao: a.descricao || '',
              data: a.data || '',
              categoria: a.categoria || '',
              categoriaAtividadeId: a.categoria_atividade_id || '',
              categoriaAtividadeNome: a.categoria_atividade_nome || '',
              categoriaAtividadeIcone: a.categoria_atividade_icone || '',
              categoriaAtividadeCor: a.categoria_atividade_cor || '',
              status: StatusMap.toUi(a.status),
              uid: a.atribuido_uid || '',
              usuarioNome: a.atribuido_nome || '',
              atualizadoPorNome: a.atualizado_nome || '',
              atualizadoEm: a.atualizado_em || ''
            });
          } else {
            reject((res && res.error) || 'N√£o encontrado');
          }
        })
        .withFailureHandler(reject)
        .getActivityById(id);
    });
  },

  /* listarCategoriasAtividades() -> [categorias] */
  listarCategoriasAtividades: function(){
    return new Promise(function(resolve, reject){
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.ok){ resolve(res.items || []); }
          else { reject((res && res.error) || 'Falha ao listar categorias de atividades'); }
        })
        .withFailureHandler(reject)
        .listCategoriasAtividadesApi();
    });
  },

  /* listMenu() -> [items] */
  listMenu: function(){
    return new Promise(function(resolve, reject){
      // Verifica se google.script.run est√° dispon√≠vel
      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        reject('Google Apps Script n√£o dispon√≠vel');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.ok){
            resolve(res.items || []);
          } else {
            reject((res && res.error) || 'Falha ao carregar menu');
          }
        })
        .withFailureHandler(function(err) {
          reject('Erro na API: ' + err);
        })
        .getMenuForUser('user'); // Por enquanto, role fixo
    });
  },

  /* ===========================
     SISTEMA DE MEMBROS - API
     =========================== */

  /* listMembers() -> [members] */
  listMembers: function() {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.listMembers chamada');
      
      // Tenta primeiro a API real
      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.listMembersApi) {
        console.log('üîó Chamando backend listMembersApi...');
        
        google.script.run
          .withSuccessHandler(function(res) {
            console.log('üì° Resposta do backend:', res);
            if (res && res.ok) {
              console.log('‚úÖ Membros carregados do backend:', (res.items || []).length);
              resolve(res.items || []);
            } else {
              console.warn('‚ö†Ô∏è Backend retornou erro:', res && res.error);
              // Fallback para dados mock
              console.log('üé≠ Usando dados mock como fallback');
              resolve(getMockMembers());
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro na chamada do backend:', err);
            // Fallback para dados mock  
            console.log('üé≠ Usando dados mock devido ao erro');
            resolve(getMockMembers());
          })
          .listMembersApi();
      } else {
        console.warn('‚ö†Ô∏è Google Apps Script ou listMembersApi n√£o dispon√≠vel');
        console.log('üîç google:', typeof google);
        console.log('üîç google.script:', typeof (google && google.script));
        console.log('üîç google.script.run:', typeof (google && google.script && google.script.run));
        console.log('üîç listMembersApi:', typeof (google && google.script && google.script.run && google.script.run.listMembersApi));
        
        console.log('üé≠ Usando dados mock');
        resolve(getMockMembers());
      }
    });
    
    function getMockMembers() {
      console.log('üé≠ Gerando dados mock para teste');
      return [
        {
          id: 'MBR-001',
          codigo_mestre: 'CM001', 
          nome: 'Jo√£o Silva',
          status: 'Ativo',
          dojo: 'Dojo Central',
          categoria_grupo: 'Adultos',
          categoria_membro: 'Regular',
          cargo: 'Instrutor',
          sexo: 'M',
          idade: 35,
          grau_omitama: 'Faixa Preta',
          buntai: 'Grupo A',
          usuario_uid: 'U001',
          ordenacao: 1
        },
        {
          id: 'MBR-002', 
          codigo_mestre: 'CM002',
          nome: 'Maria Santos',
          status: 'Ativo',
          dojo: 'Dojo Norte',
          categoria_grupo: 'Adultos', 
          categoria_membro: 'Regular',
          cargo: 'Aluna',
          sexo: 'F',
          idade: 28,
          grau_omitama: 'Faixa Marrom',
          buntai: 'Grupo B',
          usuario_uid: '',
          ordenacao: 2
        },
        {
          id: 'MBR-003',
          codigo_mestre: 'CM003', 
          nome: 'Pedro Lima',
          status: 'Inativo',
          dojo: 'Dojo Central',
          categoria_grupo: 'Juvenil',
          categoria_membro: 'Regular',
          cargo: 'Aluno', 
          sexo: 'M',
          idade: 16,
          grau_omitama: 'Faixa Verde',
          buntai: 'Grupo C',
          usuario_uid: 'U003',
          ordenacao: 3
        },
        {
          id: 'MBR-004',
          codigo_mestre: 'CM004',
          nome: 'Ana Costa',
          status: 'Ativo', 
          dojo: 'Dojo Sul',
          categoria_grupo: 'Infantil',
          categoria_membro: 'Regular',
          cargo: 'Aluna',
          sexo: 'F',
          idade: 12,
          grau_omitama: 'Faixa Azul',
          buntai: 'Grupo D',
          usuario_uid: '',
          ordenacao: 4
        },
        {
          id: 'MBR-005',
          codigo_mestre: 'CM005',
          nome: 'Carlos Oliveira',
          status: 'Ativo',
          dojo: 'Dojo Norte', 
          categoria_grupo: 'Adultos',
          categoria_membro: 'Regular',
          cargo: 'Assistente',
          sexo: 'M',
          idade: 42,
          grau_omitama: 'Faixa Preta',
          buntai: 'Grupo A',
          usuario_uid: 'U005',
          ordenacao: 5
        }
      ];
    }
  },

  /* getMember(id) -> member */
  getMember: function(id) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.getMember chamada para ID:', id);
      
      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.getMemberById) {
        google.script.run
          .withSuccessHandler(function(res) {
            console.log('üì° Resposta getMemberById:', res);
            if (res && res.ok) {
              resolve(res.item || null);
            } else {
              reject((res && res.error) || 'Membro n√£o encontrado');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro getMemberById:', err);
            reject('Erro na API: ' + err);
          })
          .getMemberById(id);
      } else {
        console.warn('‚ö†Ô∏è getMemberById n√£o dispon√≠vel, usando mock');
        // Simula busca no mock
        var mockMembers = [
          { id: 'MBR-001', nome: 'Jo√£o Silva', status: 'Ativo' },
          { id: 'MBR-002', nome: 'Maria Santos', status: 'Ativo' },
          { id: 'MBR-003', nome: 'Pedro Lima', status: 'Inativo' }
        ];
        var member = mockMembers.find(function(m) { return m.id === id; });
        if (member) {
          resolve(member);
        } else {
          reject('Membro n√£o encontrado no mock');
        }
      }
    });
  },

  /* searchMembers(filters) -> [members] */
  searchMembers: function(filters) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.searchMembers chamada com filtros:', filters);
      
      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.searchMembers) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res.items || []);
            } else {
              reject((res && res.error) || 'Falha na busca');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro searchMembers:', err);
            reject('Erro na API: ' + err);
          })
          .searchMembers(filters);
      } else {
        console.warn('‚ö†Ô∏è searchMembers n√£o dispon√≠vel, usando filtro mock');
        // Aplica filtros aos dados mock
        API.listMembers().then(function(members) {
          var filtered = members.filter(function(m) {
            if (filters.nome && m.nome.toLowerCase().indexOf(filters.nome.toLowerCase()) === -1) return false;
            if (filters.status && m.status.toLowerCase() !== filters.status.toLowerCase()) return false;
            if (filters.dojo && m.dojo.toLowerCase().indexOf(filters.dojo.toLowerCase()) === -1) return false;
            return true;
          });
          resolve(filtered);
        }).catch(reject);
      }
    });
  },

  /* linkMemberToUser(memberId, usuarioUid) -> result */
  linkMemberToUser: function(memberId, usuarioUid) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.linkMemberToUser:', memberId, '<->', usuarioUid);
      
      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.linkMemberToUser) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res);
            } else {
              reject((res && res.error) || 'Falha na vincula√ß√£o');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro linkMemberToUser:', err);
            reject('Erro na API: ' + err);
          })
          .linkMemberToUser(memberId, usuarioUid, State.uid);
      } else {
        console.warn('‚ö†Ô∏è linkMemberToUser n√£o dispon√≠vel');
        reject('Funcionalidade n√£o implementada no mock');
      }
    });
  },

  /* listActiveMembers() -> [members] */
  listActiveMembers: function() {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.listActiveMembers chamada');
      
      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.listActiveMembersApi) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res.items || []);
            } else {
              reject((res && res.error) || 'Falha ao listar membros ativos');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro listActiveMembers:', err);
            reject('Erro na API: ' + err);
          })
          .listActiveMembersApi();
      } else {
        console.warn('‚ö†Ô∏è listActiveMembersApi n√£o dispon√≠vel, filtrando mock');
        // Filtra apenas ativos dos dados mock
        API.listMembers().then(function(members) {
          var activeMembers = members.filter(function(m) {
            return m.status.toLowerCase() === 'ativo';
          });
          resolve(activeMembers);
        }).catch(reject);
      }
    });
  },

  /* === APIs DE PARTICIPA√á√ÉO === */

  /* listParticipacoes(activityId) -> { ok, items } */
  listParticipacoes: function(activityId) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.listParticipacoes:', activityId);

      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.listParticipacoes) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res);
            } else {
              reject((res && res.error) || 'Falha ao listar participa√ß√µes');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro listParticipacoes:', err);
            reject('Erro na API: ' + err);
          })
          .listParticipacoes(activityId);
      } else {
        console.warn('‚ö†Ô∏è listParticipacoes n√£o dispon√≠vel - retornando mock vazio');
        resolve({ ok: true, items: [] });
      }
    });
  },

  /* defineTargets(activityId, memberIds, uid) -> { ok, created } */
  defineTargets: function(activityId, memberIds) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.defineTargets:', activityId, memberIds);

      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.defineTargets) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res);
            } else {
              // Se erro espec√≠fico de contexto, simula sucesso para desenvolvimento
              if (res && res.error && res.error.includes('Contexto de participa√ß√µes n√£o encontrado')) {
                console.warn('‚ö†Ô∏è Contexto de participa√ß√µes n√£o encontrado - simulando sucesso para desenvolvimento');
                resolve({ ok: true, created: memberIds.length, dev_mode: true });
              } else {
                reject((res && res.error) || 'Falha ao definir alvos');
              }
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro defineTargets:', err);
            // Simula sucesso em caso de erro de rede/backend
            console.warn('‚ö†Ô∏è Erro de backend - simulando sucesso para desenvolvimento');
            resolve({ ok: true, created: memberIds.length, dev_mode: true });
          })
          .defineTargets(activityId, memberIds, State.uid);
      } else {
        console.warn('‚ö†Ô∏è defineTargets n√£o dispon√≠vel - simulando sucesso');
        resolve({ ok: true, created: memberIds.length });
      }
    });
  },

  /* markParticipacao(activityId, memberId, dados) -> { ok } */
  markParticipacao: function(activityId, memberId, dados) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.markParticipacao:', activityId, memberId, dados);

      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.markParticipacao) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res);
            } else {
              reject((res && res.error) || 'Falha ao marcar participa√ß√£o');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro markParticipacao:', err);
            reject('Erro na API: ' + err);
          })
          .markParticipacao(activityId, memberId, dados, State.uid);
      } else {
        console.warn('‚ö†Ô∏è markParticipacao n√£o dispon√≠vel');
        reject('Funcionalidade n√£o implementada no mock');
      }
    });
  },

  /* confirmarParticipacao(activityId, memberId, confirmou) -> { ok } */
  confirmarParticipacao: function(activityId, memberId, confirmou) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.confirmarParticipacao:', activityId, memberId, confirmou);

      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.confirmarParticipacao) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res);
            } else {
              reject((res && res.error) || 'Falha ao confirmar participa√ß√£o');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro confirmarParticipacao:', err);
            reject('Erro na API: ' + err);
          })
          .confirmarParticipacao(activityId, memberId, confirmou, State.uid);
      } else {
        console.warn('‚ö†Ô∏è confirmarParticipacao n√£o dispon√≠vel');
        reject('Funcionalidade n√£o implementada no mock');
      }
    });
  },

  /* searchMembersByCriteria(filters) -> { ok, items } */
  searchMembersByCriteria: function(filters) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.searchMembersByCriteria:', filters);

      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.searchMembersByCriteria) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res);
            } else {
              reject((res && res.error) || 'Falha ao buscar membros');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro searchMembersByCriteria:', err);
            reject('Erro na API: ' + err);
          })
          .searchMembersByCriteria(filters);
      } else {
        console.warn('‚ö†Ô∏è searchMembersByCriteria n√£o dispon√≠vel');
        reject('Funcionalidade n√£o implementada no mock');
      }
    });
  },

  /* getParticipacaoStats(activityId) -> { ok, stats } */
  getParticipacaoStats: function(activityId) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.getParticipacaoStats:', activityId);

      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.getParticipacaoStats) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res);
            } else {
              reject((res && res.error) || 'Falha ao obter estat√≠sticas');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro getParticipacaoStats:', err);
            reject('Erro na API: ' + err);
          })
          .getParticipacaoStats(activityId);
      } else {
        console.warn('‚ö†Ô∏è getParticipacaoStats n√£o dispon√≠vel - retornando mock');
        resolve({
          ok: true,
          stats: {
            total: 0,
            confirmados: 0,
            recusados: 0,
            participaram: 0,
            ausentes: 0,
            pendentes: 0,
            percentualParticipacao: 0
          }
        });
      }
    });
  },

  /* addExtraMember(activityId, memberId) -> { ok } */
  addExtraMember: function(activityId, memberId) {
    return new Promise(function(resolve, reject) {
      console.log('üì° API.addExtraMember:', activityId, memberId);

      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.addExtraMember) {
        google.script.run
          .withSuccessHandler(function(res) {
            if (res && res.ok) {
              resolve(res);
            } else {
              reject((res && res.error) || 'Falha ao adicionar membro extra');
            }
          })
          .withFailureHandler(function(err) {
            console.error('‚ùå Erro addExtraMember:', err);
            reject('Erro na API: ' + err);
          })
          .addExtraMember(activityId, memberId, State.uid);
      } else {
        console.warn('‚ö†Ô∏è addExtraMember n√£o dispon√≠vel');
        reject('Funcionalidade n√£o implementada no mock');
      }
    });
  }
};

/* ===========================
   Fun√ß√µes auxiliares para debug
   =========================== */

// Fun√ß√£o para verificar o estado da API
window.debugAPI = function() {
  console.log('üîç === DEBUG API ===');
  console.log('Google Apps Script dispon√≠vel:', typeof google !== 'undefined');
  console.log('google.script.run dispon√≠vel:', typeof (google && google.script && google.script.run) !== 'undefined');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    console.log('Fun√ß√µes do backend dispon√≠veis:');
    console.log('- listMembersApi:', typeof google.script.run.listMembersApi);
    console.log('- getMemberById:', typeof google.script.run.getMemberById);
    console.log('- searchMembers:', typeof google.script.run.searchMembers);
    console.log('- linkMemberToUser:', typeof google.script.run.linkMemberToUser);
    console.log('- listActiveMembersApi:', typeof google.script.run.listActiveMembersApi);
  }
  
  console.log('State.uid:', window.State && State.uid);
  console.log('üîç === FIM DEBUG ===');
};

// Fun√ß√£o para testar APIs de membros
window.testMembersAPI = function() {
  console.log('üß™ === TESTE APIs MEMBROS ===');
  
  API.listMembers().then(function(members) {
    console.log('‚úÖ listMembers funcionou:', members.length, 'membros');
    console.log('Primeiro membro:', members[0]);
    
    if (members.length > 0) {
      return API.getMember(members[0].id);
    }
  }).then(function(member) {
    if (member) {
      console.log('‚úÖ getMember funcionou:', member.nome);
    }
    
    return API.searchMembers({ status: 'ativo' });
  }).then(function(activeMembers) {
    console.log('‚úÖ searchMembers funcionou:', activeMembers.length, 'ativos');
    
    return API.listActiveMembers();
  }).then(function(activeMembers2) {
    console.log('‚úÖ listActiveMembers funcionou:', activeMembers2.length, 'ativos');
    console.log('üß™ === TODOS OS TESTES CONCLU√çDOS ===');
  }).catch(function(error) {
    console.error('‚ùå Erro no teste:', error);
  });
};

/* ===========================
   Export global
   =========================== */
window.API = API;
</script>