<script>
        // ===== FUN√á√ïES DE MULTI-SELECT FILTERS =====

        // Popular filtro multi-select com checkboxes
        function populateMultiSelectFilter(filterId, items, defaultSelectedNames = []) {
            const optionsContainer = document.getElementById(filterId + '-options');
            if (!optionsContainer) return;

            optionsContainer.innerHTML = '';

            items.forEach(item => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'filter-option';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${filterId}-${item.id}`;
                checkbox.value = item.id;
                checkbox.addEventListener('change', () => updateFilterLabel(filterId));

                // Marcar como selecionado se estiver na lista de defaults
                if (defaultSelectedNames.length > 0) {
                    const itemNomeLower = item.nome.toLowerCase();
                    if (defaultSelectedNames.some(name => itemNomeLower.includes(name.toLowerCase()))) {
                        checkbox.checked = true;
                    }
                }

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = item.nome;

                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                optionsContainer.appendChild(optionDiv);
            });

            // Inicializar label
            updateFilterLabel(filterId);
        }

        // Abrir/fechar dropdown do filtro
        function toggleFilterDropdown(filterId) {
            const optionsContainer = document.getElementById(filterId + '-options');
            const dropdown = document.querySelector(`[onclick="toggleFilterDropdown('${filterId}')"]`);

            if (!optionsContainer) return;

            // Fechar todos os outros dropdowns
            document.querySelectorAll('.filter-options').forEach(el => {
                if (el.id !== filterId + '-options') {
                    el.style.display = 'none';
                }
            });

            document.querySelectorAll('.filter-dropdown').forEach(el => {
                el.classList.remove('active');
            });

            // Toggle do dropdown atual
            if (optionsContainer.style.display === 'none' || !optionsContainer.style.display) {
                optionsContainer.style.display = 'block';
                if (dropdown) dropdown.classList.add('active');
            } else {
                optionsContainer.style.display = 'none';
                if (dropdown) dropdown.classList.remove('active');
            }
        }

        // Atualizar label do filtro com contagem de selecionados
        function updateFilterLabel(filterId) {
            const label = document.getElementById(filterId + '-label');
            const optionsContainer = document.getElementById(filterId + '-options');

            if (!label || !optionsContainer) return;

            const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
            const selected = Array.from(checkboxes).filter(cb => cb.checked);

            if (selected.length === 0) {
                label.textContent = 'Todos';
                label.style.color = '';
            } else if (selected.length === 1) {
                const selectedOption = selected[0].nextElementSibling;
                label.textContent = selectedOption.textContent;
                label.style.color = 'var(--primary)';
                label.style.fontWeight = '600';
            } else {
                label.textContent = `${selected.length} selecionados`;
                label.style.color = 'var(--primary)';
                label.style.fontWeight = '600';
            }
        }

        // Obter valores selecionados de um filtro
        function getSelectedFilterValues(filterId) {
            const optionsContainer = document.getElementById(filterId + '-options');
            if (!optionsContainer) return [];

            const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Limpar sele√ß√µes de um filtro
        function clearFilterSelections(filterId) {
            const optionsContainer = document.getElementById(filterId + '-options');
            if (!optionsContainer) return;

            const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateFilterLabel(filterId);
        }

        // Fechar dropdowns ao clicar fora (melhorado)
        document.addEventListener('click', function(event) {
            // Verifica se o clique foi dentro de algum dropdown ou op√ß√µes
            const clickedInsideFilter = event.target.closest('.filter-multiselect');

            if (!clickedInsideFilter) {
                // Clicou fora de qualquer filtro - fecha todos
                document.querySelectorAll('.filter-options').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.filter-dropdown').forEach(el => {
                    el.classList.remove('active');
                });
            }
        });

        // ===== FIM FUN√á√ïES DE MULTI-SELECT FILTERS =====

        // Carregar filtros para os selects
        async function loadTargetFilters(mode = 'create') {
            console.log('üìã Carregando filtros para alvos...');

            const prefix = mode === 'create' ? 'target' : 'edit-target';
            const loadingEl = document.getElementById(prefix + '-filters-loading');
            const contentEl = document.getElementById(prefix + '-filters-content');

            try {
                // Mostrar loading
                if (loadingEl) loadingEl.style.display = 'block';
                if (contentEl) contentEl.style.display = 'none';

                // OTIMIZA√á√ÉO: Carregar TODOS os filtros em UMA √∫nica chamada API
                const result = await apiCall('listAllFiltersApi');

                if (result && result.ok && result.filters) {
                    const filters = result.filters;

                    // Popular cada filtro com os dados retornados
                    populateMultiSelectFilter(prefix + '-dojo', filters.dojos);
                    populateMultiSelectFilter(prefix + '-status', filters.status, ['Ativo', 'Afastado']);

                    // Separar categorias: Grupo e Membro (usam a mesma tabela)
                    populateMultiSelectFilter(prefix + '-categoria-grupo', filters.categorias);
                    populateMultiSelectFilter(prefix + '-categoria-membro', filters.categorias);

                    populateMultiSelectFilter(prefix + '-cargo', filters.cargos);
                    populateMultiSelectFilter(prefix + '-omitama', filters.omitamas);
                    populateMultiSelectFilter(prefix + '-sexo', filters.sexos);
                    populateMultiSelectFilter(prefix + '-buntai', filters.buntais);

                    console.log('‚úÖ Filtros carregados com sucesso (1 chamada API)');
                } else {
                    console.warn('‚ö†Ô∏è Erro ao carregar filtros:', result);
                    showToast('‚ö†Ô∏è Erro ao carregar filtros', 'error');
                }

                // Esconder loading e mostrar filtros
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) contentEl.style.display = 'grid';

            } catch (error) {
                console.error('‚ùå Erro ao carregar filtros:', error);
                showToast('‚ö†Ô∏è Erro ao carregar filtros: ' + error.message, 'error');

                // Esconder loading em caso de erro
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) contentEl.style.display = 'grid';
            }
        }

        // Popular filtro de status baseado nos membros
        function populateTargetStatusFilter(members, mode = 'create') {
            const prefix = mode === 'create' ? 'target' : 'edit-target';
            const statusSelect = document.getElementById(prefix + '-status-filter');

            if (!statusSelect) return;

            // Obter status √∫nicos
            const statusSet = new Set();
            members.forEach(member => {
                if (member.status) statusSet.add(member.status);
            });

            // Limpar e popular select
            statusSelect.innerHTML = '<option value="">Todos os status</option>';
            Array.from(statusSet).sort().forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusSelect.appendChild(option);
            });
        }

        // Carregar alvos existentes (modo edi√ß√£o)
        async function loadExistingTargets(activityId) {
            console.log('üìã Carregando alvos existentes para:', activityId);

            try {
                const result = await apiCall('listParticipacoes', activityId);

                if (result && result.ok) {
                    await displayExistingTargets(result.items || []);
                } else {
                    console.warn('‚ö†Ô∏è Erro ao carregar alvos:', result?.error);
                    showToast('‚ö†Ô∏è Erro ao carregar alvos: ' + (result?.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('‚ùå Erro na API de alvos:', error);
                showToast('‚ùå Erro ao carregar alvos: ' + error.message, 'error');
            }
        }

        // Exibir alvos existentes
        async function displayExistingTargets(targets) {
            console.log('üéØ Carregando alvos existentes no sistema de lista dupla:', targets.length);

            // Esconder a se√ß√£o antiga de alvos atuais (n√£o usamos mais)
            const currentSection = document.getElementById('editCurrentTargets');
            if (currentSection) {
                currentSection.style.display = 'none';
            }

            if (targets.length === 0) {
                console.log('‚ö†Ô∏è Nenhum alvo existente encontrado');

                // Limpar sele√ß√µes
                selectedTargets.clear();

                // Mostrar mensagem de lista vazia (substitui o loading)
                showEmptySelectedTargetsList('edit');
                return;
            }

            // Limpar sele√ß√µes anteriores
            selectedTargets.clear();

            // Extrair IDs dos membros para buscar dados completos
            const memberIds = targets.map(target => target.id_membro);
            console.log('üîç Buscando dados completos dos membros:', memberIds);

            try {
                // Buscar dados completos dos membros via API (COM sessionId!)
                const result = await apiCall('listMembersApi');

                if (result && result.ok && result.items) {
                    console.log('‚úÖ Dados dos membros carregados:', result.items.length);

                    // Debug: verificar dados dos alvos
                    console.log('üîç DEBUG - targets recebidos:', targets);
                    console.log('üîç DEBUG - membros carregados:', result.items.length);
                    console.log('üîç DEBUG - IDs dos alvos:', targets.map(t => t.id_membro));

                    // Debug: verificar estrutura dos membros
                    if (result.items.length > 0) {
                        console.log('üîç DEBUG - Estrutura do primeiro membro:', result.items[0]);
                        console.log('üîç DEBUG - Campos dispon√≠veis:', Object.keys(result.items[0]));
                    }

                    // Adicionar alvos existentes ao selectedTargets com dados completos
                    result.items.forEach(member => {
                        // Tentar diferentes campos para o ID
                        const memberId = String(member.codigo_sequencial || member.id || member.codigo || '');

                        console.log(`üîç DEBUG - Membro processado:`, {
                            nome: member.nome,
                            codigo_sequencial: member.codigo_sequencial,
                            id: member.id,
                            codigo: member.codigo,
                            memberId: memberId
                        });

                        // Verificar se este membro estava nos alvos
                        const isTarget = targets.find(t => String(t.id_membro) === memberId);
                        console.log(`üîç DEBUG - Verificando membro ${memberId} (${member.nome}):`, isTarget ? '√â ALVO' : 'N√ÉO √© alvo');

                        if (isTarget) {
                            selectedTargets.add(memberId);

                            // Inicializar cache se necess√°rio
                            if (!window.allMembersCache) {
                                window.allMembersCache = new Map();
                            }

                            // Adicionar dados completos ao cache
                            window.allMembersCache.set(memberId, member);
                            console.log('‚úÖ Alvo existente adicionado com dados completos:', member.nome, `(#${member.codigo_sequencial})`);
                        }
                    });

                    console.log('üéØ Alvos existentes carregados:', selectedTargets.size);
                    console.log('üìã Cache final:', window.allMembersCache);

                    // Gerenciar visibilidade dos elementos UI
                    const emptyEl = document.getElementById('editTargetsEmpty');
                    const selectedContainerEl = document.getElementById('editTargetsSelectedContainer');

                    if (emptyEl) {
                        emptyEl.style.display = 'none';
                        console.log('‚úÖ Estado vazio escondido');
                    }

                    if (selectedContainerEl) {
                        selectedContainerEl.style.display = 'block';
                        console.log('‚úÖ Container de selecionados for√ßado para vis√≠vel');
                    }

                    // Atualizar lista de selecionados
                    console.log('üöÄ Chamando updateSelectedMembersList(edit)...');
                    updateSelectedMembersList('edit');
                } else {
                    console.error('‚ùå Erro ao buscar dados dos membros:', result?.error);
                    // Fallback: usar dados parciais
                    await loadTargetsWithPartialData(targets);
                }
            } catch (error) {
                console.error('‚ùå Erro na API de membros:', error);
                // Fallback: usar dados parciais
                await loadTargetsWithPartialData(targets);
            }
        }

        // Fun√ß√£o fallback melhorada para carregar alvos com dados reais
        async function loadTargetsWithPartialData(targets) {
            console.log('‚ö†Ô∏è Tentando buscar dados reais dos membros via searchMembersByCriteria...');

            try {
                // Tentar buscar dados reais via searchMembersByCriteria (COM sessionId!)
                const result = await apiCall('searchMembersByCriteria', {});

                if (result && result.ok && result.items && result.items.length > 0) {
                    console.log('‚úÖ Dados reais dos membros obtidos via fallback:', result.items.length);
                    processTargetsWithRealData(targets, result.items);
                } else {
                    console.log('‚ö†Ô∏è Fallback para dados b√°sicos - n√£o foi poss√≠vel obter dados reais');
                    processTargetsWithBasicData(targets);
                }
            } catch (error) {
                console.error('‚ùå Erro no fallback melhorado:', error);
                console.log('‚ö†Ô∏è Usando dados b√°sicos como √∫ltimo recurso');
                processTargetsWithBasicData(targets);
            }
        }

        // Processar alvos com dados reais dos membros
        function processTargetsWithRealData(targets, allMembers) {
            console.log('üéØ Processando alvos com dados reais dos membros');

            targets.forEach(target => {
                const memberId = String(target.id_membro);
                selectedTargets.add(memberId);

                // Inicializar cache se necess√°rio
                if (!window.allMembersCache) {
                    window.allMembersCache = new Map();
                }

                // Buscar dados reais do membro
                const realMember = allMembers.find(m => String(m.codigo_sequencial) === memberId);

                if (realMember) {
                    window.allMembersCache.set(memberId, realMember);
                    console.log('‚úÖ Alvo existente adicionado (dados reais):', realMember.nome, `(#${realMember.codigo_sequencial})`);
                } else {
                    // Fallback para dados b√°sicos se membro n√£o encontrado
                    const memberData = {
                        codigo_sequencial: target.id_membro,
                        nome: `Membro #${target.id_membro}`,
                        dojo: 'N/A',
                        status: 'N/A'
                    };
                    window.allMembersCache.set(memberId, memberData);
                    console.log('‚ö†Ô∏è Alvo existente adicionado (dados b√°sicos):', memberData.nome);
                }
            });

            finalizarCarregamentoAlvos();
        }

        // Processar alvos com dados b√°sicos (√∫ltimo recurso)
        function processTargetsWithBasicData(targets) {
            console.log('‚ö†Ô∏è Carregando alvos com dados b√°sicos (√∫ltimo recurso)');

            targets.forEach(target => {
                const memberId = String(target.id_membro);
                selectedTargets.add(memberId);

                // Inicializar cache se necess√°rio
                if (!window.allMembersCache) {
                    window.allMembersCache = new Map();
                }

                // Criar objeto membro b√°sico para o cache
                const memberData = {
                    codigo_sequencial: target.id_membro,
                    nome: `Membro #${target.id_membro}`,
                    dojo: 'N/A',
                    status: 'N/A'
                };

                window.allMembersCache.set(memberId, memberData);
                console.log('‚úÖ Alvo existente adicionado (dados b√°sicos):', memberData.nome);
            });

            finalizarCarregamentoAlvos();
        }

        // Finalizar carregamento de alvos (c√≥digo comum)
        function finalizarCarregamentoAlvos() {
            // Gerenciar visibilidade dos elementos UI
            const emptyEl = document.getElementById('editTargetsEmpty');
            const selectedContainerEl = document.getElementById('editTargetsSelectedContainer');

            if (emptyEl) {
                emptyEl.style.display = 'none';
                console.log('‚úÖ Estado vazio escondido (fallback)');
            }

            if (selectedContainerEl) {
                selectedContainerEl.style.display = 'block';
                console.log('‚úÖ Container de selecionados for√ßado para vis√≠vel (fallback)');
            }

            // Atualizar lista de selecionados
            console.log('üöÄ Chamando updateSelectedMembersList(edit) - fallback...');
            updateSelectedMembersList('edit');
        }

        // Fun√ß√£o removeExistingTarget removida - agora usamos o sistema de lista dupla integrado

        // Buscar membros com base nos filtros
        async function searchMembersForTargets(mode = 'create') {
            console.log('üîç Buscando membros para alvos...');

            const prefix = mode === 'create' ? 'target' : 'edit-target';

            // Obter valores de todos os filtros
            const filters = {
                nome: document.getElementById(prefix + '-name-filter')?.value || ''
            };

            // Obter valores dos filtros multi-select
            const dojoValues = getSelectedFilterValues(prefix + '-dojo');
            const statusValues = getSelectedFilterValues(prefix + '-status');
            const categoriaGrupoValues = getSelectedFilterValues(prefix + '-categoria-grupo');
            const categoriaMembroValues = getSelectedFilterValues(prefix + '-categoria-membro');
            const cargoValues = getSelectedFilterValues(prefix + '-cargo');
            const buntaiValues = getSelectedFilterValues(prefix + '-buntai');
            const omitamaValues = getSelectedFilterValues(prefix + '-omitama');
            const sexoValues = getSelectedFilterValues(prefix + '-sexo');

            // Adicionar ao objeto filters apenas se tiver sele√ß√µes
            if (dojoValues.length > 0) filters.dojo_id = dojoValues;
            if (statusValues.length > 0) filters.status_membro_id = statusValues;
            if (categoriaGrupoValues.length > 0) filters.categoria_grupo_id = categoriaGrupoValues;
            if (categoriaMembroValues.length > 0) filters.categoria_membro_id = categoriaMembroValues;
            if (cargoValues.length > 0) filters.cargo_id = cargoValues;
            if (buntaiValues.length > 0) filters.buntai_id = buntaiValues;
            if (omitamaValues.length > 0) filters.omitama_id = omitamaValues;
            if (sexoValues.length > 0) filters.sexo_id = sexoValues;

            console.log('üîç Filtros aplicados:', filters);

            // Mostrar loading
            showTargetsLoading(mode);

            try {
                const result = await apiCall('searchMembersByCriteria', filters);

                hideTargetsLoading(mode);
                console.log('‚úÖ Resposta da API:', result);

                // Verificar se o resultado √© v√°lido
                if (result && result.ok && result.items) {
                    console.log('‚úÖ Processando items:', result.items.length);
                    displayTargetsResults(result.items, mode);
                } else if (result && result.ok && Array.isArray(result)) {
                    // Fallback se retornar array direto
                    console.log('‚úÖ Processando array direto:', result.length);
                    displayTargetsResults(result, mode);
                } else if (Array.isArray(result)) {
                    // Fallback se retornar s√≥ array sem wrapper
                    console.log('‚úÖ Processando array sem wrapper:', result.length);
                    displayTargetsResults(result, mode);
                } else {
                    console.error('‚ùå Erro na busca:', result?.error || 'Resposta inv√°lida');
                    showTargetsEmpty(mode);
                    showToast('‚ö†Ô∏è Erro ao buscar membros: ' + (result?.error || 'Resposta inv√°lida'), 'error');
                }
            } catch (error) {
                hideTargetsLoading(mode);
                console.error('‚ùå Erro na API de busca:', error);
                showTargetsEmpty(mode);
                showToast('‚ùå Erro ao buscar membros: ' + error.message, 'error');
            }
        }

        // Criar item da lista de membro
        function createMemberListItem(member, isSelected, mode) {
            const bgStyle = isSelected ? 'background-color: white; border: 2px solid var(--primary);' : 'background-color: white; border: 1px solid var(--border-color);';
            const textColor = isSelected ? 'var(--primary)' : 'var(--text)';

            return `<div style="
                display: flex;
                align-items: center;
                padding: 8px 12px;
                ${bgStyle}
                border-radius: 6px;
                margin-bottom: 4px;
                cursor: pointer;
                transition: all 0.2s;
            " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" onclick="toggleTargetSelection('${member.codigo_sequencial}', '${mode}')">
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: var(--font-size-sm); color: ${textColor};">${member.nome}</div>
                    <div style="font-size: var(--font-size-xs); color: var(--text-light);">
                        #${member.codigo_sequencial} ‚Ä¢ ${member.dojo || 'N/A'} ‚Ä¢ ${member.status || 'N/A'}
                    </div>
                </div>
                <div style="color: ${textColor}; font-size: 16px;">
                    ${isSelected ? '‚ùå' : '‚ûï'}
                </div>
            </div>`;
        }

        // Atualizar lista de membros selecionados
        function updateSelectedMembersList(mode = 'create') {
            let selectedListEl, selectedCountEl, selectedContainerEl;

            console.log('üîß updateSelectedMembersList INICIADO para mode:', mode);

            if (mode === 'edit') {
                selectedListEl = document.getElementById('editTargetsSelectedList');
                selectedCountEl = document.getElementById('editTargetsSelected');
                selectedContainerEl = document.getElementById('editTargetsSelectedContainer');
            } else {
                selectedListEl = document.getElementById('targetsSelectedList');
                selectedCountEl = document.getElementById('targetsSelected');
                selectedContainerEl = document.getElementById('targetsSelectedContainer');
            }

            console.log('üîç Elementos encontrados:', {
                selectedListEl: !!selectedListEl,
                selectedCountEl: !!selectedCountEl,
                selectedContainerEl: !!selectedContainerEl,
                mode: mode
            });

            if (!selectedListEl) {
                console.error('‚ùå selectedListEl n√£o encontrado para mode:', mode);
                return;
            }

            console.log('üéØ Atualizando lista de selecionados - INICIADO:', selectedTargets.size);
            console.log('üîç currentTargetsData:', currentTargetsData?.length || 0, 'membros');
            console.log('üîç allMembersCache size:', window.allMembersCache?.size || 0);
            console.log('üîç selectedTargets:', Array.from(selectedTargets));

            // Obter membros selecionados de currentTargetsData e adicionar outros j√° selecionados
            const allSelectedMembers = [];

            console.log('üìä Processando selectedTargets:', Array.from(selectedTargets));
            console.log('üìä currentTargetsData dispon√≠vel:', currentTargetsData.length);

            // Adicionar da busca atual (se existir dados)
            if (currentTargetsData && currentTargetsData.length > 0) {
                currentTargetsData.forEach(member => {
                    if (selectedTargets.has(String(member.codigo_sequencial))) {
                        allSelectedMembers.push(member);
                        console.log('‚úÖ Adicionado da busca atual:', member.nome);
                    }
                });
            }

            // Buscar dados de membros selecionados que n√£o est√£o na busca atual
            selectedTargets.forEach(memberId => {
                const memberInCurrent = currentTargetsData && currentTargetsData.length > 0
                    ? currentTargetsData.find(m => String(m.codigo_sequencial) === memberId)
                    : null;

                if (!memberInCurrent) {
                    // Membro foi selecionado em busca anterior, precisamos dos dados
                    console.log('üîç Buscando no cache memberId:', memberId, 'type:', typeof memberId);
                    const cachedMember = window.allMembersCache?.get(memberId);
                    console.log('üîç Resultado do cache:', cachedMember ? `${cachedMember.nome} (#${cachedMember.codigo_sequencial})` : 'N√ÉO ENCONTRADO');
                    if (cachedMember) {
                        allSelectedMembers.push(cachedMember);
                        console.log('‚úÖ Adicionado do cache:', cachedMember.nome);
                    } else {
                        console.warn('‚ö†Ô∏è Membro selecionado n√£o encontrado no cache:', memberId);
                        console.log('üîç Chaves dispon√≠veis no cache:', Array.from(window.allMembersCache?.keys() || []));
                    }
                }
            });

            console.log('üìä Total de membros selecionados para renderizar:', allSelectedMembers.length);

            // Ordenar alfabeticamente
            allSelectedMembers.sort((a, b) => a.nome.localeCompare(b.nome));

            // Atualizar contador
            if (selectedCountEl) {
                selectedCountEl.textContent = `üéØ Alvos Selecionados (${selectedTargets.size})`;
                console.log('‚úÖ Contador atualizado');
            }

            // Renderizar lista
            if (allSelectedMembers.length === 0) {
                selectedListEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;">
                        Nenhum membro selecionado ainda.<br>
                        <small>Clique nos membros acima para adicion√°-los como alvos.</small>
                    </div>`;
                console.log('‚úÖ Lista inferior: estado vazio definido');
            } else {
                selectedListEl.innerHTML = allSelectedMembers.map(member =>
                    createMemberListItem(member, true, mode)
                ).join('');
                console.log('‚úÖ Lista inferior: renderizada com', allSelectedMembers.length, 'membros');
            }

            // Controlar visibilidade do container de selecionados
            if (selectedContainerEl) {
                // No modo edi√ß√£o, sempre mostrar o container se h√° membros selecionados OU se √© modo edi√ß√£o
                if (mode === 'edit' || selectedTargets.size > 0) {
                    selectedContainerEl.style.display = 'block';
                    console.log('‚úÖ Container de selecionados vis√≠vel (mode:', mode, ', selectedTargets:', selectedTargets.size, ')');
                } else {
                    selectedContainerEl.style.display = 'none';
                    console.log('‚úÖ Container de selecionados oculto');
                }
            }

            console.log('‚úÖ Lista de selecionados - CONCLU√çDA');
        }

        // Exibir resultados da busca
        function displayTargetsResults(members, mode = 'create') {
            console.log('üìã Exibindo resultados sistema de lista dupla:', members.length, 'membros');
            console.log('üéØ Membros j√° selecionados:', selectedTargets.size);

            // Ordenar membros alfabeticamente
            const sortedMembers = [...members].sort((a, b) => a.nome.localeCompare(b.nome));

            // Atualizar dados globais mantendo sele√ß√µes existentes
            currentTargetsData = sortedMembers;

            // Elementos para lista dupla
            let countEl, searchListEl, selectedListEl, resultsEl, emptyEl;

            if (mode === 'edit') {
                countEl = document.getElementById('editTargetsCount');
                searchListEl = document.getElementById('editTargetsList');
                selectedListEl = document.getElementById('editTargetsSelectedList');
                resultsEl = document.getElementById('editTargetsResults');
                emptyEl = document.getElementById('editTargetsEmpty');
            } else {
                countEl = document.getElementById('targetsCount');
                searchListEl = document.getElementById('targetsList');
                selectedListEl = document.getElementById('targetsSelectedList');
                resultsEl = document.getElementById('targetsResults');
                emptyEl = document.getElementById('targetsEmpty');
            }

            console.log('üîç Elementos de lista dupla encontrados:', {
                countEl: !!countEl,
                searchListEl: !!searchListEl,
                selectedListEl: !!selectedListEl,
                resultsEl: !!resultsEl,
                emptyEl: !!emptyEl,
                mode: mode
            });

            // Esconder estado vazio
            if (emptyEl) emptyEl.style.display = 'none';

            if (sortedMembers.length === 0) {
                showTargetsEmpty(mode);
                return;
            }

            // Mostrar resultados
            if (resultsEl) {
                resultsEl.style.display = 'block';
            }

            // Atualizar contador de membros encontrados
            if (countEl) {
                countEl.textContent = `üìã Membros Encontrados (${sortedMembers.length})`;
            }

            // Lista superior: Apenas membros N√ÉO selecionados
            if (searchListEl) {
                const unselectedMembers = sortedMembers.filter(member =>
                    !selectedTargets.has(String(member.codigo_sequencial))
                );

                console.log('üìã Lista superior:', unselectedMembers.length, 'n√£o selecionados');

                if (unselectedMembers.length === 0) {
                    searchListEl.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;">
                            Todos os membros encontrados j√° foram selecionados.<br>
                            <small>Use filtros diferentes para buscar outros membros.</small>
                        </div>`;
                } else {
                    searchListEl.innerHTML = unselectedMembers.map(member =>
                        createMemberListItem(member, false, mode)
                    ).join('');
                }
            }

            // Lista inferior: Membros selecionados (de todas as buscas)
            updateSelectedMembersList(mode);
        }

        // Toggle sele√ß√£o de membro (sistema de lista dupla) - VERS√ÉO MELHORADA
        function toggleTargetSelection(memberId, mode = 'create') {
            try {
                console.log('üîÑ Toggle sele√ß√£o INICIADO:', memberId, 'Mode:', mode);

                // Valida√ß√µes iniciais
                if (!memberId) {
                    console.error('‚ùå memberId n√£o fornecido');
                    return;
                }

                // Inicializar estruturas se necess√°rio
                if (!selectedTargets) {
                    selectedTargets = new Set();
                    console.log('üÜï selectedTargets inicializado');
                }

                if (!currentTargetsData) {
                    currentTargetsData = [];
                    console.log('üÜï currentTargetsData inicializado');
                }

                if (!window.allMembersCache) {
                    window.allMembersCache = new Map();
                    console.log('üÜï Cache global inicializado');
                }

                console.log('üìä Estado atual selectedTargets:', Array.from(selectedTargets));
                console.log('üìä currentTargetsData:', currentTargetsData.length, 'membros');

                // Garantir que memberId seja string para consist√™ncia
                const memberIdStr = String(memberId);

                // Verificar se membro est√° selecionado
                const isCurrentlySelected = selectedTargets.has(memberIdStr);
                console.log('üîç Membro atualmente selecionado?', isCurrentlySelected);
                console.log('üîç MemberId (convertido para string):', memberIdStr);

                if (isCurrentlySelected) {
                    // Remover da sele√ß√£o
                    selectedTargets.delete(memberIdStr);
                    console.log('‚ùå Membro removido dos alvos:', memberIdStr);
                } else {
                    // Adicionar √† sele√ß√£o
                    selectedTargets.add(memberIdStr);
                    console.log('‚úÖ Membro adicionado aos alvos:', memberIdStr);

                    // Buscar dados do membro para adicionar ao cache
                    const member = currentTargetsData.find(m => String(m.codigo_sequencial) === memberIdStr);
                    console.log('üîç Membro encontrado nos dados atuais?', !!member);

                    if (member) {
                        // Cache √© Map, usar set() para adicionar
                        if (!window.allMembersCache.has(memberIdStr)) {
                            window.allMembersCache.set(memberIdStr, member);
                            console.log('üíæ Membro adicionado ao cache global');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Membro n√£o encontrado nos dados atuais para cache');
                    }
                }

                console.log('üìä Novo estado selectedTargets:', Array.from(selectedTargets));
                console.log('üîÑ Chamando updateDualListDisplay...');

                // Atualizar ambas as listas
                updateDualListDisplay(mode);

                console.log('‚úÖ Toggle sele√ß√£o CONCLU√çDO');

            } catch (error) {
                console.error('‚ùå Erro em toggleTargetSelection:', error);
                // Tentar recuperar o estado
                if (!selectedTargets) selectedTargets = new Set();
                if (!window.allMembersCache) window.allMembersCache = new Map();
            }
        }

        // Atualizar display das duas listas
        function updateDualListDisplay(mode = 'create') {
            console.log('üîÑ Atualizando display das listas duplas - INICIADO');
            console.log('üéØ Mode:', mode);

            let searchListEl, selectedListEl;

            if (mode === 'edit') {
                searchListEl = document.getElementById('editTargetsList');
                selectedListEl = document.getElementById('editTargetsSelectedList');
            } else {
                searchListEl = document.getElementById('targetsList');
                selectedListEl = document.getElementById('targetsSelectedList');
            }

            console.log('üîç Elementos encontrados:', {
                searchListEl: !!searchListEl,
                selectedListEl: !!selectedListEl,
                currentTargetsData: currentTargetsData.length
            });

            // Atualizar lista superior (membros dispon√≠veis para sele√ß√£o)
            if (searchListEl && currentTargetsData) {
                const unselectedMembers = currentTargetsData.filter(member =>
                    !selectedTargets.has(String(member.codigo_sequencial))
                );

                console.log('üìã Lista superior: filtrando', currentTargetsData.length, '‚Üí', unselectedMembers.length, 'n√£o selecionados');

                if (unselectedMembers.length === 0) {
                    searchListEl.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;">
                            Todos os membros encontrados j√° foram selecionados.<br>
                            <small>Use filtros diferentes para buscar outros membros.</small>
                        </div>`;
                    console.log('‚úÖ Lista superior: estado vazio definido');
                } else {
                    searchListEl.innerHTML = unselectedMembers.map(member =>
                        createMemberListItem(member, false, mode)
                    ).join('');
                    console.log('‚úÖ Lista superior: renderizada com', unselectedMembers.length, 'membros');
                }
            } else {
                console.error('‚ùå Lista superior: elementos n√£o encontrados');
            }

            // Atualizar lista inferior (membros selecionados)
            console.log('üéØ Chamando updateSelectedMembersList...');
            updateSelectedMembersList(mode);

            console.log('‚úÖ Display das listas duplas - CONCLU√çDO');
        }

        // Atualizar contador de selecionados
        function updateTargetsSelected(mode = 'create') {
            const selectedId = mode === 'create' ? 'targetsSelected' : 'editTargetsSelected';
            const selectedEl = document.getElementById(selectedId);

            if (selectedEl) {
                selectedEl.textContent = `${selectedTargets.size} membros selecionados`;
            }
        }

        // Atualizar lista de selecionados (nova fun√ß√£o)
        function updateSelectedTargetsList(mode = 'create') {
            const selectedSectionId = mode === 'create' ? 'targetsSelectedSection' : 'editTargetsSelectedSection';
            const selectedListId = mode === 'create' ? 'targetsSelectedList' : 'editTargetsSelectedList';

            const selectedSection = document.getElementById(selectedSectionId);
            const selectedList = document.getElementById(selectedListId);

            if (!selectedSection || !selectedList) {
                console.warn('‚ö†Ô∏è Elementos da lista de selecionados n√£o encontrados');
                return;
            }

            // Obter membros selecionados
            const selectedMembers = currentTargetsData.filter(member => selectedTargets.has(String(member.codigo_sequencial)));
            selectedMembers.sort((a, b) => a.nome.localeCompare(b.nome));

            if (selectedMembers.length === 0) {
                selectedSection.style.display = 'none';
                return;
            }

            // Mostrar se√ß√£o e popular lista
            selectedSection.style.display = 'block';
            selectedList.innerHTML = selectedMembers.map(member => `
                <div style="
                    display: flex;
                    align-items: center;
                    padding: 8px 12px;
                    border: 2px solid var(--primary);
                    background-color: white;
                    border-radius: 6px;
                    margin-bottom: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.backgroundColor='var(--light)'" onmouseout="this.style.backgroundColor='white'" onclick="toggleTargetSelection('${member.codigo_sequencial}', '${mode}')">
                    <span style="margin-right: 12px; font-size: 16px;">‚úÖ</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: var(--font-size-sm); color: var(--primary);">${member.nome}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--text-light);">
                            #${member.codigo_sequencial} ‚Ä¢ ${member.dojo || 'N/A'} ‚Ä¢ ${member.status || 'N/A'}
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); toggleTargetSelection('${member.codigo_sequencial}', '${mode}')" style="
                        background: var(--danger);
                        color: white;
                        border: none;
                        border-radius: 4px;
                        padding: 4px 8px;
                        font-size: var(--font-size-xs);
                        cursor: pointer;
                    ">√ó Remover</button>
                </div>
            `).join('');

            console.log('‚úÖ Lista de selecionados atualizada:', selectedMembers.length, 'membros');
        }

        // Selecionar todos os alvos (sistema de lista dupla)
        function selectAllTargets(mode = 'create') {
            console.log('‚úÖ Selecionando todos os membros vis√≠veis para:', mode);
            console.log('üìä Membros dispon√≠veis:', currentTargetsData.length);

            currentTargetsData.forEach(member => {
                const memberId = String(member.codigo_sequencial);
                if (!selectedTargets.has(memberId)) {
                    selectedTargets.add(memberId);

                    // Adicionar ao cache global
                    if (!window.allMembersCache) {
                        window.allMembersCache = new Map();
                    }
                    if (!window.allMembersCache.has(memberId)) {
                        window.allMembersCache.set(memberId, member);
                    }
                }
            });

            // Atualizar display das listas
            updateDualListDisplay(mode);
        }

        // Desselecionar todos os alvos (sistema de lista dupla)
        function unselectAllTargets(mode = 'create') {
            console.log('‚ùå Removendo todos os alvos selecionados para:', mode);

            selectedTargets.clear();

            // Atualizar display das listas
            updateDualListDisplay(mode);
        }

        // Limpar filtros
        function clearTargetFilters(mode = 'create') {
            const prefix = mode === 'create' ? 'target' : 'edit-target';

            // Limpar filtro de nome
            const nameFilter = document.getElementById(prefix + '-name-filter');
            if (nameFilter) nameFilter.value = '';

            // Limpar todos os filtros multi-select
            clearFilterSelections(prefix + '-dojo');
            clearFilterSelections(prefix + '-status');
            clearFilterSelections(prefix + '-categoria-grupo');
            clearFilterSelections(prefix + '-categoria-membro');
            clearFilterSelections(prefix + '-cargo');
            clearFilterSelections(prefix + '-buntai');
            clearFilterSelections(prefix + '-omitama');
            clearFilterSelections(prefix + '-sexo');

            // Esconder resultados e mostrar estado vazio
            showTargetsEmpty(mode);
        }

        // Salvar alvos selecionados
        function saveTargets(mode = 'create', activityId = null) {
            const targetActivityId = activityId || currentActivityId;

            if (!targetActivityId) {
                showToast('ID da atividade n√£o encontrado. Salve a atividade primeiro.', 'warning');
                return;
            }

            if (selectedTargets.size === 0) {
                showToast('Selecione pelo menos um membro como alvo.', 'warning');
                return;
            }

            console.log('üíæ Salvando alvos:', Array.from(selectedTargets), 'para atividade:', targetActivityId);

            // Obter UID do usu√°rio atual
            const uid = localStorage.getItem('uid') || 'U001';
            const memberIds = Array.from(selectedTargets);

            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((result) => {
                        if (result && result.ok) {
                            showToast(`${result.created || 0} alvos salvos com sucesso!`, 'success');
                            toggleTargetsSection(mode, targetActivityId); // Fechar se√ß√£o

                            // Se modo edi√ß√£o, recarregar alvos existentes
                            if (mode === 'edit') {
                                setTimeout(() => {
                                    toggleTargetsSection(mode, targetActivityId);
                                }, 500);
                            }
                        } else {
                            showToast('Erro ao salvar alvos: ' + (result?.error || 'Erro desconhecido'), 'error');
                        }
                    })
                    .withFailureHandler((error) => {
                        console.error('‚ùå Erro na API de salvar alvos:', error);
                        showToast('Erro ao conectar com o servidor: ' + error.message, 'error');
                    })
                    .saveTargetsDirectly(targetActivityId, memberIds, uid);
            }
        }

        // Estados de loading e vazio
        function showTargetsLoading(mode = 'create') {
            const loadingId = mode === 'create' ? 'targetsLoading' : 'editTargetsLoading';
            const resultsId = mode === 'create' ? 'targetsResults' : 'editTargetsResults';
            const emptyId = mode === 'create' ? 'targetsEmpty' : 'editTargetsEmpty';

            const loadingEl = document.getElementById(loadingId);
            const resultsEl = document.getElementById(resultsId);
            const emptyEl = document.getElementById(emptyId);

            console.log('üîÑ Mostrando loading para:', mode, 'ID:', loadingId, 'Elemento encontrado:', !!loadingEl);

            if (loadingEl) loadingEl.style.display = 'block';
            if (emptyEl) emptyEl.style.display = 'none';
            if (resultsEl) resultsEl.style.display = 'none';

            // Mostrar/manter lista de selecionados se h√° sele√ß√µes
            updateSelectedMembersList(mode);
        }

        function hideTargetsLoading(mode = 'create') {
            const loadingId = mode === 'create' ? 'targetsLoading' : 'editTargetsLoading';
            const loadingEl = document.getElementById(loadingId);

            console.log('‚úÖ Escondendo loading para:', mode, 'ID:', loadingId, 'Elemento encontrado:', !!loadingEl);

            if (loadingEl) loadingEl.style.display = 'none';
        }

        function showTargetsEmpty(mode = 'create') {
            const loadingId = mode === 'create' ? 'targetsLoading' : 'editTargetsLoading';
            const resultsId = mode === 'create' ? 'targetsResults' : 'editTargetsResults';
            const emptyId = mode === 'create' ? 'targetsEmpty' : 'editTargetsEmpty';

            const emptyEl = document.getElementById(emptyId);
            const resultsEl = document.getElementById(resultsId);
            const loadingEl = document.getElementById(loadingId);

            if (emptyEl) emptyEl.style.display = 'block';
            if (resultsEl) resultsEl.style.display = 'none';
            if (loadingEl) loadingEl.style.display = 'none';
        }

        // Mostrar container de selecionados imediatamente com loading (modo edi√ß√£o)
        function showSelectedTargetsContainerWithLoading(mode = 'create') {
            console.log('üîÑ Mostrando container de selecionados com loading:', mode);

            const selectedContainerEl = document.getElementById(mode === 'edit' ? 'editTargetsSelectedContainer' : 'targetsSelectedContainer');
            const selectedListEl = document.getElementById(mode === 'edit' ? 'editTargetsSelectedList' : 'targetsSelectedList');
            const emptyEl = document.getElementById(mode === 'edit' ? 'editTargetsEmpty' : 'targetsEmpty');

            // Esconder estado vazio
            if (emptyEl) {
                emptyEl.style.display = 'none';
                console.log('‚úÖ Estado vazio escondido');
            }

            // Mostrar container de selecionados
            if (selectedContainerEl) {
                selectedContainerEl.style.display = 'block';
                console.log('‚úÖ Container de selecionados vis√≠vel');
            }

            // Mostrar loading na lista
            if (selectedListEl) {
                selectedListEl.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; padding: 20px; color: var(--text-muted);">
                        <div class="loading-select-spinner" style="margin-right: 10px;"></div>
                        <span>Carregando alvos existentes...</span>
                    </div>`;
                console.log('‚úÖ Loading mostrado na lista de selecionados');
            }
        }

        // Mostrar mensagem de lista vazia (substituir loading quando n√£o h√° alvos)
        function showEmptySelectedTargetsList(mode = 'create') {
            console.log('üìù Mostrando mensagem de lista vazia para:', mode);

            const selectedContainerEl = document.getElementById(mode === 'edit' ? 'editTargetsSelectedContainer' : 'targetsSelectedContainer');
            const selectedListEl = document.getElementById(mode === 'edit' ? 'editTargetsSelectedList' : 'targetsSelectedList');

            // Manter container vis√≠vel
            if (selectedContainerEl) {
                selectedContainerEl.style.display = 'block';
                console.log('‚úÖ Container de selecionados mantido vis√≠vel');
            }

            // Mostrar mensagem de vazio na lista (substitui loading)
            if (selectedListEl) {
                selectedListEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;">
                        Nenhum membro selecionado ainda.<br>
                        <small>Clique nos membros acima para adicion√°-los como alvos.</small>
                    </div>`;
                console.log('‚úÖ Mensagem de lista vazia mostrada');
            }
        }

        function resetTargetsSection(mode = 'create') {
            selectedTargets.clear();
            currentTargetsData = [];
            window.allMembersCache = new Map();
            showTargetsEmpty(mode);
        }

        // Salvar alvos ap√≥s criar atividade (modo cria√ß√£o)
        function saveTargetsAfterActivity(activityId) {
            console.log('üíæ Salvando alvos ap√≥s criar atividade:', activityId);
            console.log('üéØ Estado atual selectedTargets:', Array.from(selectedTargets));

            if (selectedTargets.size === 0) {
                // Sem alvos, finalizar processo
                console.log('‚ö†Ô∏è Nenhum alvo selecionado, finalizando sem salvar');
                showCreateActivityLoading(false);
                showToast('Atividade criada com sucesso!', 'success');
                closeActivityModal();
                loadActivities();
                return;
            }

            // Obter UID do usu√°rio atual
            const uid = localStorage.getItem('uid') || 'U001';
            const memberIds = Array.from(selectedTargets);

            console.log('üìä Detalhes do salvamento:', {
                activityId: activityId,
                memberIds: memberIds,
                totalAlvos: memberIds.length,
                uid: uid
            });

            console.log('üöÄ Chamando saveTargetsDirectly no backend...');

            google.script.run
                .withSuccessHandler((result) => {
                    showCreateActivityLoading(false);
                    console.log('‚úÖ Resposta do backend saveTargetsDirectly:', result);

                    if (result && result.ok) {
                        const totalCreated = result.created || 0;
                        console.log('‚úÖ Sucesso! Alvos criados:', totalCreated);
                        showToast(`Atividade criada com sucesso! ${totalCreated} alvos definidos.`, 'success');
                    } else {
                        console.error('‚ö†Ô∏è Backend retornou erro:', result);
                        showToast(`Atividade criada! Erro ao salvar alvos: ${result?.error || 'Erro desconhecido'}`, 'warning');
                    }

                    closeActivityModal();
                    loadActivities();
                })
                .withFailureHandler((error) => {
                    showCreateActivityLoading(false);
                    console.error('‚ùå Erro na chamada ao backend:', error);
                    showToast(`Atividade criada! Erro ao salvar alvos: ${error.message || error}`, 'warning');
                    closeActivityModal();
                    loadActivities();
                })
                .saveTargetsDirectly(activityId, memberIds, uid);
        }

        // ===== FIM DAS FUN√á√ïES DE ALVOS =====

        // Fun√ß√£o de logout com destrui√ß√£o de sess√£o
        async function logout() {
            console.log('üö™ Iniciando processo de logout...');

            // Mostrar loading overlay
            showLogoutLoading(true);

            try {
                // Obter sessionId atual
                const sessionId = localStorage.getItem('sessionId');
                console.log('üîç SessionId para logout:', sessionId);

                // Destruir sess√£o no servidor se existe sessionId
                if (sessionId && typeof google !== 'undefined' && google.script && google.script.run) {
                    console.log('üîÑ Destruindo sess√£o no servidor...');

                    try {
                        await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler((result) => {
                                    console.log('‚úÖ Resultado do logout no servidor:', result);
                                    if (result && result.ok) {
                                        console.log('‚úÖ Sess√£o destru√≠da com sucesso no servidor');
                                    } else {
                                        console.warn('‚ö†Ô∏è Logout no servidor retornou erro:', result?.error);
                                    }
                                    resolve(result);
                                })
                                .withFailureHandler((error) => {
                                    console.error('‚ùå Erro ao destruir sess√£o no servidor:', error);
                                    // Continuar com logout local mesmo se falhar no servidor
                                    resolve(null);
                                })
                                .logoutUser(sessionId);
                        });
                    } catch (serverError) {
                        console.warn('‚ö†Ô∏è Erro na chamada do servidor, continuando com logout local:', serverError);
                    }
                } else {
                    console.log('üìù Sem sessionId ou Google Script indispon√≠vel, fazendo logout local apenas');
                }

            } catch (error) {
                console.warn('‚ö†Ô∏è Erro durante logout no servidor, continuando com limpeza local:', error);
            }

            // Limpar TODOS os dados de sess√£o local
            console.log('üßπ Limpando dados locais...');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('uid');
            localStorage.removeItem('userName');
            localStorage.removeItem('user');
            sessionStorage.clear();

            // Esconder todo o conte√∫do da aplica√ß√£o
            console.log('üîÑ Ocultando interface da aplica√ß√£o...');
            const appContent = document.querySelector('.app-container');
            const header = document.querySelector('.app-header');
            const navTabs = document.querySelector('.nav-tabs');
            const mobileNav = document.querySelector('.mobile-nav');
            const pageContents = document.querySelectorAll('.page-content');

            if (appContent) appContent.style.display = 'none';
            if (header) header.style.display = 'none';
            if (navTabs) navTabs.style.display = 'none';
            if (mobileNav) mobileNav.style.display = 'none';
            pageContents.forEach(page => page.style.display = 'none');

            // Mostrar tela de login novamente
            console.log('üîÑ Redirecionando para tela de login...');
            showLogin();

            // Esconder loading overlay
            showLogoutLoading(false);

            console.log('‚úÖ Logout completo realizado com sucesso!');
        }
</script>