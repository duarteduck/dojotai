<!-- ===== PÃGINA: PRÃTICAS DIÃRIAS ===== -->
<div id="practices" class="page-content hidden">
    <!-- Marca d'Ã¡gua SIMULADO -->
    <div class="watermark-simulado">SIMULADO</div>

    <div class="card">
        <div class="practices-header">
            <h1 style="font-size: var(--font-size-2xl); margin-bottom: var(--spacing-xs);">Registro DiÃ¡rio de PrÃ¡ticas</h1>
            <p style="opacity: 0.9;">Acompanhe suas prÃ¡ticas dia a dia</p>
        </div>

        <div class="practices-controls">
            <h2 id="days-count" style="font-size: var(--font-size-lg); font-weight: 600;">7 dias selecionados</h2>
            <button class="btn btn-primary" onclick="openCalendar()">
                <span>ğŸ“…</span>
                <span>Filtrar Dias</span>
            </button>
        </div>

        <div style="padding: var(--spacing-lg);">
            <div class="practices-grid" id="days-grid">
                <!-- Dias serÃ£o inseridos aqui via JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¥‹ SISTEMA DE PRÃTICAS DIÃRIAS - INTEGRADO COM BACKEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Estado global
let availablePractices = [];  // PrÃ¡ticas do cadastro (dinÃ¢micas)
let selectedDays = [];         // Dias selecionados
let practices = {};            // Dados: { '2025-01-15': { 'PRAC-0001': { quantidade: 3 }, ... } }
let observations = {};         // ObservaÃ§Ãµes: { '2025-01-15': 'Texto da observaÃ§Ã£o' }
let saveTimeouts = {};         // Timeouts para auto-save (debounce)
let currentMemberId = null;    // Membro ativo (State.selectedMemberId)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIALIZAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function initPractices() {
    try {
        // 1. Obter membro ativo do State (sistema de vÃ­nculos)
        currentMemberId = State.selectedMemberId;

        if (!currentMemberId) {
            showToast('Nenhum membro selecionado. Use o menu de perfil para selecionar um membro.', 'warning');
            return;
        }

        // 2. Carregar prÃ¡ticas disponÃ­veis do cadastro
        showLoading('Carregando prÃ¡ticas...');
        await loadAvailablePractices();

        if (availablePractices.length === 0) {
            hideLoading();
            showToast('Nenhuma prÃ¡tica cadastrada. Entre em contato com o administrador.', 'warning');
            return;
        }

        // 3. Selecionar Ãºltimos 7 dias se vazio
        if (selectedDays.length === 0) {
            selectLast7Days();
        }

        // 4. Carregar dados do backend
        await loadPracticesFromServer();

        hideLoading();

    } catch (error) {
        hideLoading();
        console.error('Erro ao inicializar prÃ¡ticas:', error);
        showToast('Erro ao carregar prÃ¡ticas: ' + error.message, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKEND - CARREGAR DADOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadAvailablePractices() {
    const sessionId = localStorage.getItem('sessionId');

    const result = await apiCall('getAvailablePractices', sessionId, currentMemberId);

    if (result.ok) {
        availablePractices = result.items || [];
        console.log('PrÃ¡ticas carregadas:', availablePractices.length);
    } else {
        console.error('Erro ao carregar prÃ¡ticas disponÃ­veis:', result.error);
        throw new Error(result.error || 'Erro ao carregar prÃ¡ticas disponÃ­veis');
    }
}

async function loadPracticesFromServer() {
    if (!currentMemberId) return;
    if (selectedDays.length === 0) return;

    const sessionId = localStorage.getItem('sessionId');

    // Ordenar dias para pegar min/max
    const sortedDays = [...selectedDays].sort((a, b) => a - b);
    const startDate = sortedDays[0].toISOString().split('T')[0];
    const endDate = sortedDays[sortedDays.length - 1].toISOString().split('T')[0];

    console.log('Carregando prÃ¡ticas:', startDate, 'atÃ©', endDate);

    const result = await apiCall('loadPracticesByDateRange', sessionId, currentMemberId, startDate, endDate);

    if (result.ok) {
        // Processar dados recebidos
        practices = {};  // Limpar

        (result.items || []).forEach(registro => {
            const dateKey = registro.data;
            if (!practices[dateKey]) practices[dateKey] = {};

            practices[dateKey][registro.pratica_id] = {
                quantidade: registro.quantidade || 0,
                id: registro.id  // Guardar ID do registro (para referÃªncia)
            };
        });

        console.log('PrÃ¡ticas carregadas do servidor:', Object.keys(practices).length, 'dias');

        // Carregar observaÃ§Ãµes de cada dia
        await loadObservationsFromServer();

        // Renderizar
        renderDays();

    } else {
        console.error('Erro ao carregar prÃ¡ticas:', result.error);
        showToast('Erro ao carregar prÃ¡ticas: ' + result.error, 'error');
    }
}

async function loadObservationsFromServer() {
    if (!currentMemberId) return;

    const sessionId = localStorage.getItem('sessionId');

    // Carregar observaÃ§Ã£o de cada dia selecionado
    for (const day of selectedDays) {
        const dateKey = day.toISOString().split('T')[0];

        const result = await apiCall('loadObservation', sessionId, currentMemberId, dateKey);

        if (result.ok && result.observacao) {
            observations[dateKey] = result.observacao;
        }
    }

    console.log('ObservaÃ§Ãµes carregadas:', Object.keys(observations).length, 'dias');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKEND - SALVAR DADOS (AUTO-SAVE COM DEBOUNCE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function scheduleSavePractice(dateKey, praticaId) {
    // Cancelar timeout anterior
    const key = `${dateKey}_${praticaId}`;
    if (saveTimeouts[key]) {
        clearTimeout(saveTimeouts[key]);
    }

    // Agendar save apÃ³s 2 segundos
    saveTimeouts[key] = setTimeout(() => {
        savePracticeToServer(dateKey, praticaId);
    }, 2000);
}

async function savePracticeToServer(dateKey, praticaId) {
    if (!currentMemberId) return;

    const sessionId = localStorage.getItem('sessionId');
    const quantidade = practices[dateKey]?.[praticaId]?.quantidade || 0;

    console.log('Salvando prÃ¡tica:', dateKey, praticaId, quantidade);

    const result = await apiCall('savePractice', sessionId, currentMemberId, dateKey, praticaId, quantidade);

    if (result.ok) {
        console.log('PrÃ¡tica salva:', result.id, result.isNew ? 'NOVA' : 'ATUALIZADA');
        // Atualizar ID do registro se foi criado agora
        if (result.id) {
            practices[dateKey][praticaId].id = result.id;
        }
    } else {
        console.error('Erro ao salvar prÃ¡tica:', result.error);
        showToast('Erro ao salvar: ' + result.error, 'error');
    }
}

function scheduleSaveObservation(dateKey) {
    // Cancelar timeout anterior
    const key = `obs_${dateKey}`;
    if (saveTimeouts[key]) {
        clearTimeout(saveTimeouts[key]);
    }

    // Agendar save apÃ³s 2 segundos
    saveTimeouts[key] = setTimeout(() => {
        saveObservationToServer(dateKey);
    }, 2000);
}

async function saveObservationToServer(dateKey) {
    if (!currentMemberId) return;

    const observacao = observations[dateKey];

    // NÃ£o salvar se vazio
    if (!observacao || observacao.trim() === '') {
        console.log('ObservaÃ§Ã£o vazia, nÃ£o salvando');
        return;
    }

    const sessionId = localStorage.getItem('sessionId');

    console.log('Salvando observaÃ§Ã£o:', dateKey, observacao.substring(0, 30) + '...');

    const result = await apiCall('saveObservation', sessionId, currentMemberId, dateKey, observacao);

    if (result.ok) {
        console.log('ObservaÃ§Ã£o salva:', result.id, result.isNew ? 'NOVA' : 'ATUALIZADA');
    } else {
        console.error('Erro ao salvar observaÃ§Ã£o:', result.error);
        showToast('Erro ao salvar observaÃ§Ã£o: ' + result.error, 'error');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIAS E RENDERIZAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getLast7Days() {
    const days = [];
    const today = new Date();
    for (let i = 6; i >= 0; i--) {
        const day = new Date(today);
        day.setDate(today.getDate() - i);
        days.push(day);
    }
    return days;
}

function selectLast7Days() {
    selectedDays = getLast7Days();
    updateDaysCount();
}

function getDayProgress(dateKey) {
    const dayPractices = practices[dateKey] || {};
    let completed = 0;
    const total = availablePractices.length;

    availablePractices.forEach(pratica => {
        const quantidade = dayPractices[pratica.id]?.quantidade || 0;

        // Se tipo Ã© contador: completo se quantidade > 0
        // Se tipo Ã© sim_nao: completo se quantidade === 1
        if (quantidade > 0) {
            completed++;
        }
    });

    return {
        completed,
        total,
        percentage: total > 0 ? Math.round((completed / total) * 100) : 0
    };
}

function getProgressClass(percentage) {
    if (percentage === 100) return 'success';
    if (percentage > 0) return 'warning';
    return 'danger';
}

function renderDays() {
    const grid = document.getElementById('days-grid');
    if (!grid) return;

    const sortedDays = [...selectedDays].sort((a, b) => b - a);  // Mais recente primeiro

    grid.innerHTML = sortedDays.map(day => {
        const dateKey = day.toISOString().split('T')[0];
        const progress = getDayProgress(dateKey);
        const isToday = day.toDateString() === new Date().toDateString();
        const observacao = observations[dateKey] || '';

        return `
            <div class="day-card ${isToday ? 'today' : ''}">
                <div class="day-header ${isToday ? 'today' : ''}">
                    <div class="day-name">${day.toLocaleDateString('pt-BR', { weekday: 'long' })}</div>
                    <div class="day-date">${day.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}</div>
                    <div style="margin-top: var(--spacing-sm);">
                        <div class="badge badge-${getProgressClass(progress.percentage)}">
                            ${progress.completed}/${progress.total} registros
                        </div>
                    </div>
                </div>
                <div style="padding: var(--spacing-md); display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    ${availablePractices.map(pratica => renderPractice(pratica, dateKey)).join('')}
                    ${renderObservationField(dateKey, observacao)}
                </div>
            </div>
        `;
    }).join('');
}

function renderPractice(pratica, dateKey) {
    const practiceData = practices[dateKey]?.[pratica.id] || { quantidade: 0 };
    const quantidade = practiceData.quantidade || 0;

    // Renderizar baseado no tipo
    if (pratica.tipo === 'sim_nao') {
        // Checkbox: quantidade = 1 (sim) ou 0 (nÃ£o)
        return `
            <div class="practice-item">
                <div class="practice-header">
                    <div>
                        <div class="practice-title" style="color: ${pratica.cor || 'var(--primary)'};">
                            ${pratica.icone || 'ğŸ“Œ'} ${pratica.nome}
                        </div>
                        <div class="practice-explanation">${pratica.descricao || ''}</div>
                    </div>
                    <div class="practice-controls">
                        <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; color: var(--success);">
                            <input type="radio" name="pratica-${pratica.id}-${dateKey}"
                                   ${quantidade === 1 ? 'checked' : ''}
                                   onchange="setYesNo('${dateKey}', '${pratica.id}', 1)">
                            <span>Sim</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; color: var(--danger); margin-left: var(--spacing-md);">
                            <input type="radio" name="pratica-${pratica.id}-${dateKey}"
                                   ${quantidade === 0 ? 'checked' : ''}
                                   onchange="setYesNo('${dateKey}', '${pratica.id}', 0)">
                            <span>NÃ£o</span>
                        </label>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Contador: input numÃ©rico
        return `
            <div class="practice-item">
                <div class="practice-header">
                    <div>
                        <div class="practice-title" style="color: ${pratica.cor || 'var(--primary)'};">
                            ${pratica.icone || 'ğŸ“Œ'} ${pratica.nome}
                        </div>
                        <div class="practice-explanation">${pratica.descricao || ''}</div>
                    </div>
                    <div class="practice-controls">
                        <input type="number" min="0"
                               class="practice-input"
                               value="${quantidade}"
                               onchange="updateQuantity('${dateKey}', '${pratica.id}', this.value)">
                        <button class="btn-increment" onclick="incrementPractice('${dateKey}', '${pratica.id}')">
                            +
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
}

function renderObservationField(dateKey, observacao) {
    return `
        <div class="practice-item" style="margin-top: var(--spacing-md); background-color: var(--background-light);">
            <div style="padding: var(--spacing-sm);">
                <div class="practice-title" style="margin-bottom: var(--spacing-xs);">
                    ğŸ“ ObservaÃ§Ãµes do dia
                </div>
                <textarea
                    class="practice-textarea"
                    placeholder="Adicione observaÃ§Ãµes sobre o dia..."
                    maxlength="500"
                    oninput="updateObservation('${dateKey}', this.value)"
                    style="width: 100%; min-height: 60px; padding: var(--spacing-sm); border: 1px solid var(--border-color); border-radius: var(--border-radius); font-family: inherit; resize: vertical;"
                >${observacao}</textarea>
                <div style="font-size: var(--font-size-xs); color: var(--text-light); margin-top: var(--spacing-xs);">
                    ${observacao.length}/500 caracteres
                </div>
            </div>
        </div>
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERAÃ‡Ã•ES DO USUÃRIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setYesNo(dateKey, praticaId, value) {
    if (!practices[dateKey]) practices[dateKey] = {};

    practices[dateKey][praticaId] = {
        quantidade: value,
        id: practices[dateKey][praticaId]?.id  // Manter ID se existir
    };

    renderDays();
    scheduleSavePractice(dateKey, praticaId);
}

function incrementPractice(dateKey, praticaId) {
    if (!practices[dateKey]) practices[dateKey] = {};

    const current = practices[dateKey][praticaId]?.quantidade || 0;

    practices[dateKey][praticaId] = {
        quantidade: current + 1,
        id: practices[dateKey][praticaId]?.id  // Manter ID se existir
    };

    renderDays();
    scheduleSavePractice(dateKey, praticaId);
}

function updateQuantity(dateKey, praticaId, newValue) {
    if (!practices[dateKey]) practices[dateKey] = {};

    const quantidade = Math.max(0, parseInt(newValue) || 0);

    practices[dateKey][praticaId] = {
        quantidade: quantidade,
        id: practices[dateKey][praticaId]?.id  // Manter ID se existir
    };

    renderDays();
    scheduleSavePractice(dateKey, praticaId);
}

function updateObservation(dateKey, value) {
    observations[dateKey] = value;
    renderDays();
    scheduleSaveObservation(dateKey);
}

function updateDaysCount() {
    const countEl = document.getElementById('days-count');
    if (countEl) {
        countEl.textContent = `${selectedDays.length} dias selecionados`;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL DE CALENDÃRIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openCalendar() {
    document.getElementById('calendar-modal').classList.remove('hidden');
}

function closeCalendar() {
    document.getElementById('calendar-modal').classList.add('hidden');
}

</script>

<!-- Modal do CalendÃ¡rio -->
<div id="calendar-modal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Filtrar Dias</h3>
            <button class="btn-close" onclick="closeCalendar()">âœ•</button>
        </div>
        <div style="text-align: center; color: var(--text-light); padding: var(--spacing-xl);">
            <div style="font-size: var(--font-size-3xl); margin-bottom: var(--spacing-lg);">ğŸ“…</div>
            <div style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-sm);">CalendÃ¡rio Interativo</div>
            <div>SeleÃ§Ã£o de dias personalizÃ¡vel serÃ¡ implementada aqui</div>
        </div>
    </div>
</div>
