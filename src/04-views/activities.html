<!-- ===== P√ÅGINA: ATIVIDADES ===== -->
<div id="activities" class="page-content hidden">
    <!-- Sistema de Filtros com Modal e Chips -->
    <div class="filters-container">
        <!-- Linha 1: Bot√£o Filtros, Chips e Nova Atividade -->
        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 12px;">

            <!-- Bot√£o principal "Filtros" -->
            <button id="btn-filtros" class="btn btn-primary" style="border: none !important; outline: none !important;">
                <span>üîç</span>
                <span id="filtros-text">Filtros</span>
            </button>

            <!-- Container dos chips -->
            <div id="chips-container" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;"></div>

            <!-- Bot√£o Limpar Tudo (ser√° mostrado via JS) -->
            <button id="btn-limpar-filtros" class="btn-limpar-filtros" style="display: none;">
                <span>√ó</span>
                <span>Limpar Tudo</span>
            </button>

            <!-- Bot√£o Nova Atividade -->
            <div style="margin-left: auto;">
                <button class="btn btn-primary" id="btn-nova-atividade">
                    <span>‚ûï</span>
                    <span>Nova Atividade</span>
                </button>
            </div>
        </div>

        <!-- Linha 2: Campo de busca e Nova Categoria -->
        <div style="display: flex; gap: 12px; align-items: center;">
            <!-- Campo de busca -->
            <div style="position: relative; flex: 1;">
                <span style="
                    position: absolute;
                    left: 12px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: var(--text-light);
                    pointer-events: none;
                    font-size: 16px;
                ">üîé</span>
                <input
                    type="text"
                    id="search-activities"
                    placeholder="Buscar por t√≠tulo ou descri√ß√£o..."
                    style="
                        width: 100%;
                        padding: 10px 40px 10px 40px;
                        border: 2px solid #d1d5db;
                        border-radius: 8px;
                        font-size: var(--font-size-sm);
                        outline: none;
                        transition: all 0.2s;
                        background: white;
                    "
                    onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                    onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"
                    onkeyup="filterActivitiesByText(this.value)"
                />
                <button
                    id="clear-search"
                    onclick="clearSearchText()"
                    style="
                        position: absolute;
                        right: 10px;
                        top: 50%;
                        transform: translateY(-50%);
                        background: var(--surface);
                        border: none;
                        color: var(--text-light);
                        cursor: pointer;
                        font-size: 20px;
                        padding: 4px 8px;
                        display: none;
                        border-radius: 4px;
                        line-height: 1;
                        transition: all 0.2s;
                    "
                    onmouseover="this.style.background='var(--border-color)'; this.style.color='var(--text-primary)'"
                    onmouseout="this.style.background='var(--surface)'; this.style.color='var(--text-light)'"
                >√ó</button>
            </div>

            <!-- Bot√£o Nova Categoria -->
            <button class="btn btn-outline" id="btn-nova-categoria" disabled style="opacity: 0.5; cursor: not-allowed;">
                <span>‚ûï</span>
                <span>Nova Categoria</span>
            </button>
        </div>
    </div>

    <!-- Grid de Atividades -->
    <div class="cards-grid" id="activities-grid">
        <!-- Atividades ser√£o renderizadas aqui via JavaScript -->
    </div>
</div>

<script>

        // ===== SISTEMA DE ATIVIDADES =====
        function initActivities() {
            // LAZY INIT: Inicializar sistema de filtros apenas na primeira vez
            if (!filtrosSystemInitialized) {
                initFiltrosSystem();
                filtrosSystemInitialized = true;
            }

            // Configurar filtros
            setupActivityFilters();

            // Aplicar filtros padr√£o (Pendente + Usu√°rio logado)
            // NOTA: aplicarFiltrosPadrao() j√° chama loadActivities() via aplicarFiltros()
            if (typeof aplicarFiltrosPadrao === 'function') {
                aplicarFiltrosPadrao();
            }

            // REMOVIDO: Chamada duplicada de loadActivities()
            // A fun√ß√£o aplicarFiltrosPadrao() acima j√° carrega as atividades

            // Configurar bot√£o Nova Atividade com valida√ß√£o de sess√£o
            const btnNova = document.getElementById('btn-nova-atividade');
            if (btnNova) {
                btnNova.addEventListener('click', function() {
                    // Validar sess√£o antes de abrir modal (instant√¢neo - valida em background)
                    const sessionValid = checkSessionBeforeModal();
                    if (sessionValid) {
                        openActivityModal();
                    }
                    // Se sess√£o inv√°lida, checkSessionBeforeModal() j√° mostrou o modal de sess√£o expirada
                });
            }
        }

        function setupActivityFilters() {
            const categoryFilter = document.getElementById('activities-category-filter');
            const statusFilter = document.getElementById('activities-status-filter');
            const periodFilter = document.getElementById('activities-period-filter');
            const ownerFilter = document.getElementById('activities-owner-filter');

            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    loadActivities();
                });
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    loadActivities();
                });
            }

            if (periodFilter) {
                periodFilter.addEventListener('change', function() {
                    loadActivities();
                });
            }

            if (ownerFilter) {
                ownerFilter.addEventListener('change', function() {
                    loadActivities();
                });
            }
        }

        // Guard para evitar chamadas simult√¢neas
        let isLoadingActivities = false;

        function loadActivities() {
            // Prevenir chamadas simult√¢neas
            if (isLoadingActivities) {
                console.log('‚ö†Ô∏è loadActivities j√° est√° em execu√ß√£o, ignorando chamada duplicada');
                return;
            }
            isLoadingActivities = true;

            const grid = document.getElementById('activities-grid');
            if (!grid) {
                isLoadingActivities = false;
                return;
            }

            // Mostrar loading overlay
            if (typeof showActivitiesLoadingOverlay === 'function') {
                showActivitiesLoadingOverlay(true);
            }

            // Tentar usar API real
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                // Preparar filtros para enviar ao backend
                const filtrosBackend = {
                    status: filtrosState.status || [],
                    categorias: filtrosState.categorias || [],
                    periodo: filtrosState.periodo || [],
                    responsavel: filtrosState.responsavel || []
                };

                // Conectar com API real usando apiCall()
                (async () => {
                    try {
                        const result = await apiCall('listActivitiesApi', filtrosBackend);

                        isLoadingActivities = false; // Liberar lock

                        if (result && result.ok && result.items) {
                            const activitiesWithCategory = result.items.map(activity => {
                                return {
                                    ...activity,
                                    // Manter compatibilidade com campos de categoria √∫nica
                                    categoria: activity.categoria_atividade_nome || 'Geral',
                                    categoria_icone: activity.categoria_atividade_icone || 'üìã',
                                    categoria_cor: activity.categoria_atividade_cor || '#6b7280',
                                    // PRESERVAR o array de m√∫ltiplas categorias
                                    categorias: activity.categorias || []
                                };
                            });

                            // Backend j√° filtrou, aplicar apenas filtro de texto (se houver)
                            const filteredActivities = applyActivityFilters(activitiesWithCategory);
                            renderActivities(filteredActivities);

                            // Esconder loading overlay
                            if (typeof showActivitiesLoadingOverlay === 'function') {
                                showActivitiesLoadingOverlay(false);
                            }
                        } else {
                            console.error('Erro ao carregar atividades:', result);
                            if (typeof showActivitiesLoadingOverlay === 'function') {
                                showActivitiesLoadingOverlay(false);
                            }
                            loadActivitiesFallback();
                        }
                    } catch (error) {
                        isLoadingActivities = false; // Liberar lock

                        // Esconder loading overlay
                        if (typeof showActivitiesLoadingOverlay === 'function') {
                            showActivitiesLoadingOverlay(false);
                        }

                        // Erro de sess√£o j√° tratado por apiCall()
                        if (!error.message || !error.message.includes('Sess√£o')) {
                            console.error('Erro na API de atividades:', error);
                            loadActivitiesFallback();
                        }
                    }
                })();
            } else {
                // Fallback se API n√£o estiver dispon√≠vel
                isLoadingActivities = false;

                // Esconder loading overlay
                if (typeof showActivitiesLoadingOverlay === 'function') {
                    showActivitiesLoadingOverlay(false);
                }

                loadActivitiesFallback();
            }
        }

        function applyActivityFilters(activities) {
            if (!activities || !Array.isArray(activities)) return [];

            // Backend j√° aplicou filtros de status, categoria, per√≠odo e respons√°vel
            // Aqui aplicamos apenas o filtro de TEXTO (busca por t√≠tulo/descri√ß√£o)
            let filtered = activities;

            if (filtrosState.searchText && filtrosState.searchText.trim().length > 0) {
                const searchTerm = filtrosState.searchText.toLowerCase().trim();
                filtered = filtered.filter(atividade => {
                    const titulo = (atividade.titulo || '').toLowerCase();
                    const descricao = (atividade.descricao || '').toLowerCase();
                    return titulo.includes(searchTerm) || descricao.includes(searchTerm);
                });
                console.log('üîç Filtro de texto aplicado:', filtered.length, 'de', activities.length);
            }

            return filtered;
        }


        function loadActivitiesFallback() {
            console.error('‚ùå N√£o foi poss√≠vel carregar as atividades da API');

            // Mostrar mensagem de erro para o usu√°rio
            const activitiesList = document.getElementById('activities-list');
            if (activitiesList) {
                activitiesList.innerHTML = `
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        N√£o foi poss√≠vel carregar as atividades. Verifique sua conex√£o.
                    </div>
                `;
            }
        }

        function getCategoryFromId(categoryId) {
            const categories = {
                '1': 'Okiyome',
                '2': 'Estudo',
                '3': 'Cerim√¥nia',
                '4': 'Reuni√£o',
                '5': 'Evento'
            };
            return categories[categoryId] || 'Geral';
        }

        // Remove um card com anima√ß√£o
        function removeActivityCardWithAnimation(activityId, onComplete) {
            // Valida√ß√£o de entrada
            if (!activityId) {
                console.warn('‚ö†Ô∏è removeActivityCardWithAnimation: activityId inv√°lido');
                return;
            }

            // Buscar card no DOM
            const card = document.querySelector(`[data-activity-id="${activityId}"]`);
            if (!card) {
                console.log('‚ÑπÔ∏è Card n√£o encontrado no DOM para remover');
                return;
            }

            // Adicionar classe de anima√ß√£o
            card.classList.add('card-removing');

            // Aguardar anima√ß√£o terminar e remover do DOM
            setTimeout(() => {
                if (card.parentNode) {
                    card.parentNode.removeChild(card);
                }

                // Callback opcional
                if (onComplete && typeof onComplete === 'function') {
                    onComplete();
                }
            }, 300); // Dura√ß√£o da anima√ß√£o fadeOutSlide
        }

        function openParticipants(activityId, titulo = '', descricao = '') {
            console.log('üü¢ PASSO 1: openParticipants chamada com ID:', activityId);
            console.log('üü¢ PASSO 2: Prestes a chamar openEditActivityModal');
            openEditActivityModal(activityId, 'participants', titulo, descricao);
            console.log('üü¢ PASSO 3: openEditActivityModal chamada finalizada');
        }

        function editActivity(activityId) {
            // Verificar se h√° modal de edi√ß√£o aberto
            const existingModal = document.getElementById('editActivityModal');
            if (existingModal) {
                console.log('‚è≥ Modal de edi√ß√£o j√° aberto, aguardando limpeza...');
                setTimeout(() => {
                    editActivity(activityId); // Tentar novamente ap√≥s delay
                }, 200);
                return;
            }

            console.log('üîÑ Abrindo modal de edi√ß√£o para:', activityId);
            openEditActivityModal(activityId);
        }

        async function completeActivity(activityId) {
            // Mostrar loading no bot√£o
            const button = document.querySelector(`button[onclick="completeActivity('${activityId}')"]`);
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<div class="loading-select-spinner" style="margin: 0 auto;"></div>';

            try {
                // Usar apiCall() que detecta sess√£o expirada automaticamente
                const response = await apiCall('completeActivity', activityId);

                // Restaurar bot√£o
                button.disabled = false;
                button.innerHTML = originalContent;

                if (response && response.ok) {
                    showToast('Atividade marcada como conclu√≠da com sucesso!', 'success');
                    updateSingleActivityCard(activityId);
                } else {
                    console.error('‚ùå Erro ao marcar atividade como conclu√≠da:', response);
                    showToast('Erro ao marcar atividade como conclu√≠da: ' + (response.error || 'Erro desconhecido'), 'error');
                }

            } catch (error) {
                // Restaurar bot√£o em caso de erro
                button.disabled = false;
                button.innerHTML = originalContent;

                // Erro de sess√£o expirada j√° foi tratado por apiCall()
                if (!error.message.includes('Sess√£o')) {
                    console.error('‚ùå Erro ao marcar atividade como conclu√≠da:', error);
                    showToast('Erro ao marcar atividade como conclu√≠da: ' + error.message, 'error');
                }
            }
        }

        // ===== SISTEMA DE MODAIS DE ATIVIDADES =====

        function createActivityModal() {
            const modalHTML = `
                <div id="activityModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(3px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                    box-sizing: border-box;
                " onclick="closeActivityModal(event)">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        width: 100%;
                        max-width: 600px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                        animation: modalFadeIn 0.2s ease;
                    " onclick="event.stopPropagation()">
                        <div style="padding: 24px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2 style="font-size: var(--font-size-xl); font-weight: 600; margin: 0;">Nova Atividade</h2>
                                <button onclick="closeActivityModal()" style="
                                    background: none;
                                    border: none;
                                    font-size: 24px;
                                    cursor: pointer;
                                    padding: 8px;
                                    border-radius: 50%;
                                    width: 40px;
                                    height: 40px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">&times;</button>
                            </div>
                        </div>
                        <div id="createActivityFormContent" style="padding: 24px;">
                            <form id="activityForm">
                                <div class="form-group">
                                    <label class="form-label">Nome da Atividade *</label>
                                    <input type="text" id="activity-name" class="form-input" placeholder="Digite o nome da atividade" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Descri√ß√£o</label>
                                    <textarea id="activity-description" class="form-input" placeholder="Descreva a atividade" rows="3"></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Data *</label>
                                        <input type="date" id="activity-date" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Hor√°rio *</label>
                                        <input type="time" id="activity-time" class="form-input" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Categorias *</label>
                                    <select id="activity-category" class="form-input" multiple style="min-height: 80px;" required>
                                        <option value="okiyome">Okiyome</option>
                                        <option value="estudo">Estudo</option>
                                        <option value="cerimonia">Cerim√¥nia</option>
                                    </select>
                                    <small class="form-help">Segure Ctrl/Cmd para selecionar m√∫ltiplas categorias</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Respons√°vel *</label>
                                    <select id="activity-responsible" class="form-input" required>
                                        <option value="">Carregando usu√°rios...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tags</label>
                                    <input type="text" id="activity-tags" class="form-input" placeholder="Ex: kata, b√°sico, manh√£ (separadas por v√≠rgula)">
                                    <small class="form-help">Digite tags separadas por v√≠rgula para facilitar a busca</small>
                                </div>
                            </form>

                            <!-- Se√ß√£o de Definir Alvos (retr√°til) -->
                            <div id="targetsSection" style="display: none; margin-top: 24px; padding: 20px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color); transition: all 0.3s ease;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin: 0; color: var(--text);">üéØ Definir Alvos da Atividade</h3>
                                    <button onclick="toggleTargetsSection('create')" style="
                                        background: none;
                                        border: none;
                                        font-size: 20px;
                                        cursor: pointer;
                                        padding: 8px;
                                        border-radius: 50%;
                                        width: 32px;
                                        height: 32px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: var(--text-light);
                                    ">√ó</button>
                                </div>

                                <!-- Filtros para sele√ß√£o de membros -->
                                <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border-color);">
                                    <!-- Busca por Nome -->
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-size: var(--font-size-sm); font-weight: 600; margin-bottom: 4px; color: var(--text);">üîç Busca por Nome</label>
                                        <input type="text" id="target-name-filter" class="form-input" placeholder="Digite o nome do membro..." style="font-size: var(--font-size-sm);">
                                    </div>

                                    <!-- Loading de filtros -->
                                    <div id="target-filters-loading" style="display: none; text-align: center; padding: 20px;">
                                        <div style="width: 24px; height: 24px; border: 3px solid var(--gray-light); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 8px;"></div>
                                        <p style="color: var(--text-light); margin: 0; font-size: var(--font-size-sm);">Carregando filtros...</p>
                                    </div>

                                    <!-- Filtros Multi-Select -->
                                    <div id="target-filters-content" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px;">
                                        <!-- Linha 1: Dojo / Status -->
                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Dojo</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('target-dojo')">
                                                <span id="target-dojo-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="target-dojo-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Status</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('target-status')">
                                                <span id="target-status-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="target-status-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <!-- Linha 2: Categoria Grupo / Categoria Membro -->
                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Cat. Grupo</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('target-categoria-grupo')">
                                                <span id="target-categoria-grupo-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="target-categoria-grupo-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Cat. Membro</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('target-categoria-membro')">
                                                <span id="target-categoria-membro-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="target-categoria-membro-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <!-- Linha 3: Cargo / Buntai -->
                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Cargo</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('target-cargo')">
                                                <span id="target-cargo-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="target-cargo-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Buntai</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('target-buntai')">
                                                <span id="target-buntai-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="target-buntai-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <!-- Linha 4: Omitama / Sexo -->
                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Omitama</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('target-omitama')">
                                                <span id="target-omitama-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="target-omitama-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Sexo</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('target-sexo')">
                                                <span id="target-sexo-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="target-sexo-options" class="filter-options" style="display: none;"></div>
                                        </div>
                                    </div>

                                    <!-- Bot√µes de A√ß√£o -->
                                    <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearTargetFilters('create')" style="font-size: 0.75rem; padding: 4px 8px;">Limpar</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="searchMembersForTargets('create')" style="font-size: 0.75rem; padding: 4px 8px;">üîç Buscar</button>
                                    </div>
                                </div>

                                <!-- Loading para busca -->
                                <div id="targetsLoading" style="display: none; text-align: center; padding: 40px;">
                                    <div style="width: 32px; height: 32px; border: 3px solid var(--gray-light); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                                    <p style="color: var(--text-light); margin: 0;">Buscando membros...</p>
                                </div>

                                <!-- Lista Superior: Resultados da Pesquisa -->
                                <div id="targetsResults" style="display: none;">
                                    <div style="background: white; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 16px;">
                                        <div style="padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                                            <span id="targetsCount" style="font-weight: 600; color: var(--text);">üìã Membros Encontrados (0)</span>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn btn-sm btn-outline-primary" onclick="selectAllTargets()" style="font-size: var(--font-size-xs);">Selecionar Todos</button>
                                            </div>
                                        </div>
                                        <div id="targetsList" style="max-height: 250px; overflow-y: auto; padding: 8px;"></div>
                                    </div>
                                </div>

                                <!-- Lista Inferior: Membros Selecionados (sempre vis√≠vel quando h√° sele√ß√µes) -->
                                <div id="targetsSelectedContainer" style="display: none;">
                                    <div style="background: white; border-radius: 8px; border: 1px solid var(--primary); border-width: 2px;">
                                        <div style="padding: 16px; border-bottom: 1px solid var(--primary); display: flex; justify-content: space-between; align-items: center; background: var(--primary-light);">
                                            <span id="targetsSelected" style="font-weight: 600; color: var(--primary);">üéØ Alvos Selecionados (0)</span>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn btn-sm btn-outline-secondary" onclick="unselectAllTargets()" style="font-size: var(--font-size-xs);">Remover Todos</button>
                                            </div>
                                        </div>
                                        <div id="targetsSelectedList" style="max-height: 200px; overflow-y: auto; padding: 8px; min-height: 60px;">
                                            <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;">
                                                Nenhum membro selecionado ainda.<br>
                                                <small>Clique nos membros acima para adicion√°-los como alvos.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Estado vazio -->
                                <div id="targetsEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                                    <p style="margin: 0;">Use os filtros acima para buscar membros e defini-los como alvos da atividade.</p>
                                </div>
                            </div>

                            <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <button type="button" onclick="toggleTargetsSection('create')" class="btn btn-outline-primary" id="targets-toggle-btn" style="font-size: var(--font-size-sm);">üéØ Definir Alvos</button>
                                <div style="display: flex; gap: 12px;">
                                    <button type="button" onclick="closeActivityModal()" class="btn btn-secondary" id="cancel-activity-btn">Cancelar</button>
                                    <button type="button" onclick="submitActivity()" class="btn btn-primary" id="save-activity-btn">Salvar Atividade</button>
                                </div>
                            </div>
                        </div>

                        <!-- Loading State - substitui o conte√∫do -->
                        <div id="createActivityLoadingState" style="
                            padding: 60px 24px;
                            display: none;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            min-height: 300px;
                        ">
                            <div style="
                                width: 48px;
                                height: 48px;
                                border: 4px solid var(--gray-light);
                                border-top: 4px solid var(--primary);
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin-bottom: 24px;
                            "></div>
                            <p style="
                                color: var(--text);
                                font-size: var(--font-size-lg);
                                margin: 0 0 8px 0;
                                font-weight: 500;
                            ">Salvando atividade...</p>
                            <p style="
                                color: var(--text-light);
                                font-size: var(--font-size-md);
                                margin: 0;
                            ">Por favor, aguarde</p>
                        </div>
                    </div>
                </div>
            `;
            return modalHTML;
        }

        function openActivityModal() {
            // Remove modal existente se houver
            const existingModal = document.getElementById('activityModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Criar e inserir novo modal
            const modalHTML = createActivityModal();
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Prevenir scroll do body
            document.body.style.overflow = 'hidden';

            // Carregar dados para os selects
            loadActivityModalData();

            // Focus no primeiro campo
            setTimeout(() => {
                const firstInput = document.getElementById('activity-name');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        function closeActivityModal(event) {
            // Se h√° event e n√£o clicou no pr√≥prio modal (fundo), ignora
            if (event && event.target !== event.currentTarget) return;

            // Limpar sele√ß√µes de alvos n√£o persistidas
            console.log('üßº Limpando sele√ß√µes de alvos ao fechar modal de cria√ß√£o');
            selectedTargets.clear();
            currentTargetsData = [];
            window.allMembersCache = new Map();

            const modal = document.getElementById('activityModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }

        function createEditActivityModal(activityId, mode = 'edit') {
            console.log('üîµ PASSO 6: createEditActivityModal INICIADO');
            const isParticipantsMode = mode === 'participants';
            const modalTitle = isParticipantsMode ? 'Participantes da Atividade' : 'Editar Atividade';
            console.log('üîµ PASSO 7: Vari√°veis definidas, isParticipantsMode:', isParticipantsMode);

            const modalHTML = `
                <div id="editActivityModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(3px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                    box-sizing: border-box;
                " onclick="closeEditActivityModal(event)">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        width: 100%;
                        max-width: 600px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                        animation: modalFadeIn 0.2s ease;
                        position: relative;
                    " onclick="event.stopPropagation()">
                        <div style="padding: 24px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2 style="font-size: var(--font-size-xl); font-weight: 600; margin: 0;">${modalTitle}</h2>
                                <button onclick="closeEditActivityModal()" style="
                                    background: none;
                                    border: none;
                                    font-size: 24px;
                                    cursor: pointer;
                                    padding: 8px;
                                    border-radius: 50%;
                                    width: 40px;
                                    height: 40px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">&times;</button>
                            </div>
                        </div>

                        <!-- Loading State - carregando dados -->
                        <div id="editActivityLoadingState" style="
                            padding: 60px 24px;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            min-height: 300px;
                        ">
                            <div style="
                                width: 48px;
                                height: 48px;
                                border: 4px solid var(--gray-light);
                                border-top: 4px solid var(--primary);
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin-bottom: 24px;
                            "></div>
                            <p style="
                                color: var(--text);
                                font-size: var(--font-size-lg);
                                margin: 0 0 8px 0;
                                font-weight: 500;
                            ">Carregando atividade...</p>
                            <p style="
                                color: var(--text-light);
                                font-size: var(--font-size-md);
                                margin: 0;
                            ">Por favor, aguarde</p>
                        </div>

                        <!-- Form Content - dados da atividade -->
                        <div id="editActivityFormContent" style="padding: 24px; display: none;">
                            <form id="editActivityForm">
                                <div class="form-group">
                                    <label class="form-label">Nome da Atividade</label>
                                    <input type="text" id="edit-activity-name" class="form-input" readonly style="background: var(--gray-light); cursor: not-allowed;" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Descri√ß√£o</label>
                                    <textarea id="edit-activity-description" class="form-input" placeholder="Descreva a atividade" rows="3" ${isParticipantsMode ? 'readonly style="background: var(--gray-light); cursor: not-allowed;"' : ''}></textarea>
                                </div>
                                ${!isParticipantsMode ? `
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Data *</label>
                                        <input type="date" id="edit-activity-date" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Hor√°rio *</label>
                                        <input type="time" id="edit-activity-time" class="form-input" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Categorias *</label>
                                    <select id="edit-activity-category" class="form-input" multiple style="min-height: 80px;" required>
                                        <option value="okiyome">Okiyome</option>
                                        <option value="estudo">Estudo</option>
                                        <option value="cerimonia">Cerim√¥nia</option>
                                    </select>
                                    <small class="form-help">Segure Ctrl/Cmd para selecionar m√∫ltiplas categorias</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Respons√°vel *</label>
                                    <select id="edit-activity-responsible" class="form-input" required>
                                        <option value="">Carregando usu√°rios...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tags</label>
                                    <input type="text" id="edit-activity-tags" class="form-input" placeholder="Ex: kata, b√°sico, manh√£ (separadas por v√≠rgula)">
                                    <small class="form-help">Digite tags separadas por v√≠rgula para facilitar a busca</small>
                                </div>
                                ` : ''}
                            </form>

                            ${!isParticipantsMode ? `
                            <!-- Se√ß√£o de Definir Alvos para Edi√ß√£o -->
                            <div id="editTargetsSection" style="display: none; margin-top: 24px; padding: 20px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin: 0; color: var(--text);">üéØ Editar Alvos da Atividade</h3>
                                    <button onclick="toggleTargetsSection('edit')" style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px; color: var(--text-light);">&times;</button>
                                </div>

                                <!-- Alvos atuais (se√ß√£o removida - agora integrada no sistema de lista dupla) -->

                                <!-- Filtros para buscar e gerenciar alvos -->
                                <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border-color);">
                                    <h4 style="font-size: var(--font-size-md); font-weight: 600; margin: 0 0 12px 0; color: var(--text);">Buscar e Gerenciar Alvos</h4>

                                    <!-- Busca por Nome -->
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-size: var(--font-size-sm); font-weight: 600; margin-bottom: 4px; color: var(--text);">üîç Busca por Nome</label>
                                        <input type="text" id="edit-target-name-filter" class="form-input" placeholder="Digite o nome do membro..." style="font-size: var(--font-size-sm);">
                                    </div>

                                    <!-- Loading de filtros -->
                                    <div id="edit-target-filters-loading" style="display: none; text-align: center; padding: 20px;">
                                        <div style="width: 24px; height: 24px; border: 3px solid var(--gray-light); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 8px;"></div>
                                        <p style="color: var(--text-light); margin: 0; font-size: var(--font-size-sm);">Carregando filtros...</p>
                                    </div>

                                    <!-- Filtros Multi-Select -->
                                    <div id="edit-target-filters-content" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px;">
                                        <!-- Linha 1: Dojo / Status -->
                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Dojo</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('edit-target-dojo')">
                                                <span id="edit-target-dojo-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="edit-target-dojo-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Status</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('edit-target-status')">
                                                <span id="edit-target-status-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="edit-target-status-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <!-- Linha 2: Categoria Grupo / Categoria Membro -->
                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Cat. Grupo</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('edit-target-categoria-grupo')">
                                                <span id="edit-target-categoria-grupo-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="edit-target-categoria-grupo-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Cat. Membro</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('edit-target-categoria-membro')">
                                                <span id="edit-target-categoria-membro-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="edit-target-categoria-membro-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <!-- Linha 3: Cargo / Buntai -->
                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Cargo</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('edit-target-cargo')">
                                                <span id="edit-target-cargo-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="edit-target-cargo-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Buntai</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('edit-target-buntai')">
                                                <span id="edit-target-buntai-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="edit-target-buntai-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <!-- Linha 4: Omitama / Sexo -->
                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Omitama</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('edit-target-omitama')">
                                                <span id="edit-target-omitama-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="edit-target-omitama-options" class="filter-options" style="display: none;"></div>
                                        </div>

                                        <div class="filter-multiselect">
                                            <label style="display: block; font-size: var(--font-size-xs); font-weight: 600; margin-bottom: 2px; color: var(--text-light);">Sexo</label>
                                            <div class="filter-dropdown" onclick="toggleFilterDropdown('edit-target-sexo')">
                                                <span id="edit-target-sexo-label" style="font-size: var(--font-size-sm);">Todos</span>
                                                <span style="font-size: 0.7rem;">‚ñº</span>
                                            </div>
                                            <div id="edit-target-sexo-options" class="filter-options" style="display: none;"></div>
                                        </div>
                                    </div>

                                    <!-- Bot√µes de A√ß√£o -->
                                    <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearTargetFilters('edit')" style="font-size: 0.75rem; padding: 4px 8px;">Limpar</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="searchMembersForTargets('edit')" style="font-size: 0.75rem; padding: 4px 8px;">üîç Buscar</button>
                                    </div>
                                </div>

                                <!-- Loading para busca -->
                                <div id="editTargetsLoading" style="display: none; text-align: center; padding: 40px;">
                                    <div style="width: 32px; height: 32px; border: 3px solid var(--gray-light); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                                    <p style="color: var(--text-light); margin: 0;">Buscando membros...</p>
                                </div>

                                <!-- Lista Superior: Resultados da Pesquisa -->
                                <div id="editTargetsResults" style="display: none;">
                                    <div style="background: white; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 16px;">
                                        <div style="padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                                            <span id="editTargetsCount" style="font-weight: 600; color: var(--text);">üìã Membros Encontrados (0)</span>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn btn-sm btn-outline-primary" onclick="selectAllTargets('edit')" style="font-size: var(--font-size-xs);">Selecionar Todos</button>
                                            </div>
                                        </div>
                                        <div id="editTargetsList" style="max-height: 250px; overflow-y: auto; padding: 8px;"></div>
                                    </div>
                                </div>

                                <!-- Lista Inferior: Membros Selecionados (sempre vis√≠vel quando h√° sele√ß√µes) -->
                                <div id="editTargetsSelectedContainer" style="display: none;">
                                    <div style="background: white; border-radius: 8px; border: 1px solid var(--primary); border-width: 2px;">
                                        <div style="padding: 16px; border-bottom: 1px solid var(--primary); display: flex; justify-content: space-between; align-items: center; background: var(--primary-light);">
                                            <span id="editTargetsSelected" style="font-weight: 600; color: var(--primary);">üéØ Alvos Selecionados (0)</span>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn btn-sm btn-outline-secondary" onclick="unselectAllTargets('edit')" style="font-size: var(--font-size-xs);">Remover Todos</button>
                                            </div>
                                        </div>
                                        <div id="editTargetsSelectedList" style="max-height: 200px; overflow-y: auto; padding: 8px; min-height: 60px;">
                                            <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;">
                                                Nenhum membro selecionado ainda.<br>
                                                <small>Clique nos membros acima para adicion√°-los como alvos.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Estado vazio -->
                                <div id="editTargetsEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                                    <p style="margin: 0;">Use os filtros acima para buscar membros e defini-los como alvos da atividade.</p>
                                </div>
                            </div>
                            ` : ''}

                            ${isParticipantsMode ? `
                            <!-- Se√ß√£o de Participantes -->
                            <div id="participantsSection" style="margin-top: 24px; padding: 20px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color);">
                                <h3 style="font-size: var(--font-size-lg); font-weight: 600; margin: 0 0 20px 0; color: var(--text);">üë• Participantes da Atividade</h3>

                                <!-- Loading state -->
                                <div id="participantsLoading" style="text-align: center; padding: 40px;">
                                    <div style="width: 32px; height: 32px; border: 3px solid var(--gray-light); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                                    <p style="color: var(--text-light); margin: 0;">Carregando participantes...</p>
                                </div>

                                <!-- Lista de participantes -->
                                <div id="participantsList" style="display: none;"></div>

                                <!-- Campo de busca para adicionar membros extras -->
                                <div id="addExtraMemberSection" style="display: none; margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px dashed var(--border-color);">
                                    <label style="font-weight: 600; margin-bottom: 8px; display: block; color: var(--text); font-size: var(--font-size-md);">
                                        ‚ûï Adicionar Membro Extra
                                    </label>
                                    <small style="color: var(--text-light); display: block; margin-bottom: 12px; font-size: var(--font-size-sm);">
                                        Membros que participaram mas n√£o eram alvos da atividade
                                    </small>
                                    <div style="position: relative;">
                                        <input
                                            type="text"
                                            id="search-extra-member"
                                            placeholder="Buscar membro por nome..."
                                            autocomplete="off"
                                            style="
                                                width: 100%;
                                                padding: 10px 12px;
                                                border: 2px solid #d1d5db;
                                                border-radius: 8px;
                                                font-size: var(--font-size-md);
                                                outline: none;
                                                transition: all 0.2s;
                                                background: white;
                                            "
                                            onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                                            onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"
                                        />
                                        <div id="member-suggestions" class="autocomplete-suggestions" style="display: none;"></div>
                                    </div>
                                </div>

                                <!-- Estado vazio -->
                                <div id="participantsEmpty" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                                    <p style="margin: 0;">Nenhum alvo definido para esta atividade ainda.</p>
                                </div>
                            </div>
                            ` : ''}

                            <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                ${isParticipantsMode ? `
                                    <div></div>
                                    <div style="display: flex; gap: 12px;">
                                        <button type="button" onclick="closeEditActivityModal()" class="btn btn-secondary">Fechar</button>
                                        <button type="button" onclick="saveAllParticipations('${activityId}')" class="btn btn-primary" id="save-participations-btn">Salvar Participa√ß√µes</button>
                                    </div>
                                ` : `
                                    <button type="button" onclick="toggleTargetsSection('edit', '${activityId}')" class="btn btn-outline-primary" id="edit-targets-toggle-btn" style="font-size: var(--font-size-sm);">üéØ Definir Alvos</button>
                                    <div style="display: flex; gap: 12px;">
                                        <button type="button" onclick="closeEditActivityModal()" class="btn btn-secondary" id="edit-cancel-btn">Cancelar</button>
                                        <button type="button" onclick="updateActivity('${activityId}')" class="btn btn-primary" id="edit-save-btn">Salvar Altera√ß√µes</button>
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Loading State - salvando altera√ß√µes -->
                        <div id="editActivitySavingState" style="
                            padding: 60px 24px;
                            display: none;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            min-height: 300px;
                        ">
                            <div style="
                                width: 48px;
                                height: 48px;
                                border: 4px solid var(--gray-light);
                                border-top: 4px solid var(--primary);
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin-bottom: 24px;
                            "></div>
                            <p style="
                                color: var(--text);
                                font-size: var(--font-size-lg);
                                margin: 0 0 8px 0;
                                font-weight: 500;
                            ">Salvando altera√ß√µes...</p>
                            <p style="
                                color: var(--text-light);
                                font-size: var(--font-size-md);
                                margin: 0;
                            ">Por favor, aguarde</p>
                        </div>
                    </div>
                </div>
            `;
            return modalHTML;
        }

        function openEditActivityModal(activityId, mode = 'edit', titulo = '', descricao = '') {
            console.log('üü° PASSO 4: openEditActivityModal INICIADO com mode:', mode, 'activityId:', activityId);
            if (!activityId) {
                console.error('‚ùå ID da atividade n√£o fornecido!');
                return;
            }
            console.log('üü° PASSO 5: Valida√ß√£o de ID passou, continuando...');

            // Remove modal existente se houver
            const existingModal = document.getElementById('editActivityModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Criar e inserir novo modal
            console.log('üü° PASSO 8: Prestes a chamar createEditActivityModal');
            const modalHTML = createEditActivityModal(activityId, mode);
            console.log('üü° PASSO 9: Modal HTML criado, inserindo no DOM');
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            console.log('üü° PASSO 10: Modal inserido no DOM com sucesso');

            // Prevenir scroll do body
            document.body.style.overflow = 'hidden';

            if (mode === 'participants') {
                console.log('üîß Modo participantes detectado, carregando dados...');

                // Se t√≠tulo e descri√ß√£o foram passados, preencher diretamente (otimiza√ß√£o)
                if (titulo) {
                    const nameField = document.getElementById('edit-activity-name');
                    const descField = document.getElementById('edit-activity-description');
                    if (nameField) nameField.value = titulo;
                    if (descField) descField.value = descricao;

                    // Mostrar form content imediatamente
                    const loadingState = document.getElementById('editActivityLoadingState');
                    const formContent = document.getElementById('editActivityFormContent');
                    if (loadingState) loadingState.style.display = 'none';
                    if (formContent) formContent.style.display = 'block';
                }

                // Modo participantes: carregar apenas participa√ß√µes
                setTimeout(() => {
                    console.log('üîß Chamando loadActivityForParticipants para:', activityId);
                    loadActivityForParticipants(activityId);
                }, 100);
            } else {
                // Modo edi√ß√£o: carregar dados para os selects primeiro
                loadEditActivityModalData();

                // Aguardar um pouco e depois carregar dados da atividade
                setTimeout(() => {
                    loadActivityForEdit(activityId);
                }, 500); // Aumentando delay para dar tempo da API se estabilizar
            }
        }

        function closeEditActivityModal(event) {
            // Se h√° event e n√£o clicou no pr√≥prio modal (fundo), ignora
            if (event && event.target !== event.currentTarget) return;

            // Limpar sele√ß√µes de alvos n√£o persistidas
            console.log('üßº Limpando sele√ß√µes de alvos ao fechar modal de edi√ß√£o');
            selectedTargets.clear();
            currentTargetsData = [];
            window.allMembersCache = new Map();
            pendingExtraMembers = []; // Limpar membros extras pendentes
            currentParticipations = []; // Limpar participa√ß√µes carregadas
            extraMemberSearchInitialized = false; // Resetar flag para permitir reinicializa√ß√£o
            console.log('üßº Membros extras pendentes limpos ao fechar modal');

            const modal = document.getElementById('editActivityModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }

        // ===== MODAL DE PARTICIPANTES (usa editActivityModal em modo 'participants') =====

        async function loadActivityForParticipants(activityId, tentativa = 1) {
            try {
                console.log('üìä [PARTICIPANTES] Iniciando carregamento para atividade:', activityId, '(tentativa', tentativa + ')');

                // Verificar se State est√° dispon√≠vel
                if (typeof State === 'undefined') {
                    if (tentativa >= 5) {
                        throw new Error('State n√£o carregado ap√≥s 5 tentativas. Verifique se app_state.html est√° sendo inclu√≠do corretamente.');
                    }
                    console.warn('‚ö†Ô∏è State n√£o definido na tentativa', tentativa, '- tentando novamente em 200ms...');
                    setTimeout(() => loadActivityForParticipants(activityId, tentativa + 1), 200);
                    return;
                }

                console.log('‚úÖ [PARTICIPANTES] State carregado! User:', State?.user);

                if (!activityId) {
                    throw new Error('ID da atividade n√£o fornecido');
                }

                // Verificar se o Google Apps Script est√° dispon√≠vel
                if (typeof google === 'undefined' || !google.script) {
                    throw new Error('Google Apps Script n√£o est√° dispon√≠vel');
                }

                console.log('üìä [PARTICIPANTES] Carregando participa√ß√µes...');

                // Carregar participa√ß√µes da atividade usando apiCall()
                const participationsResult = await apiCall('listParticipacoes', activityId);

                console.log('üë• Participa√ß√µes carregadas:', participationsResult);

                // Esconder loading (compat√≠vel com ambos os modais)
                const loadingNew = document.getElementById('participants-loading');
                const loadingOld = document.getElementById('participantsLoading');
                if (loadingNew) loadingNew.style.display = 'none';
                if (loadingOld) loadingOld.style.display = 'none';

                if (participationsResult && participationsResult.ok && participationsResult.items && participationsResult.items.length > 0) {
                    // Filtrar apenas registros n√£o deletados
                    const activeParticipations = participationsResult.items.filter(p => p.deleted !== 'x');

                    // Armazenar participa√ß√µes para valida√ß√£o de duplicatas
                    currentParticipations = activeParticipations;

                    console.log('üë• Total de participa√ß√µes:', participationsResult.items.length);
                    console.log('üë• Participa√ß√µes ativas (n√£o deletadas):', activeParticipations.length);

                    if (activeParticipations.length > 0) {
                        // Mostrar lista de participa√ß√µes ativas (compat√≠vel com ambos modais)
                        const listNew = document.getElementById('participants-list');
                        const listOld = document.getElementById('participantsList');
                        if (listNew) listNew.style.display = 'block';
                        if (listOld) listOld.style.display = 'block';

                        // Renderizar participantes
                        renderParticipantsForModal(activeParticipations);
                    } else {
                        // Mostrar mensagem de sem alvos ativos (novo modal)
                        const noTargets = document.getElementById('participants-no-targets');
                        if (noTargets) noTargets.style.display = 'block';

                        // Modal antigo - mostrar mensagem
                        const emptyOld = document.getElementById('participantsEmpty');
                        if (emptyOld) emptyOld.style.display = 'block';
                    }
                } else {
                    // Armazenar array vazio para valida√ß√£o
                    currentParticipations = [];

                    // Mostrar mensagem de sem alvos (novo modal)
                    const noTargets = document.getElementById('participants-no-targets');
                    if (noTargets) noTargets.style.display = 'block';

                    // Modal antigo - mostrar mensagem
                    const emptyOld = document.getElementById('participantsEmpty');
                    if (emptyOld) emptyOld.style.display = 'block';
                }

                // ========== MOSTRAR SE√á√ÉO DE BUSCA DE MEMBROS EXTRAS ==========
                const extraSection = document.getElementById('addExtraMemberSection');
                if (extraSection) {
                    extraSection.style.display = 'block';
                    console.log('‚úÖ Se√ß√£o de busca de membros extras exibida');
                }

                // ========== INICIALIZAR BUSCA DE MEMBROS EXTRAS ==========
                initExtraMemberSearch(activityId);
                console.log('‚úÖ Busca de membros extras inicializada');

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados para participa√ß√µes:', error);

                // Garantir que o loading desapare√ßa e mostrar erro
                const loadingElement = document.getElementById('participants-loading');

                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 20px;">
                            ‚ùå Erro ao carregar participa√ß√µes
                            <br><small>${error.message || error}</small>
                            <br><br>
                            <button onclick="loadActivityForParticipants('${activityId}', 1)" class="btn btn-primary btn-sm" style="
                                padding: 8px 16px;
                                background: var(--primary);
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">
                                üîÑ Tentar Novamente
                            </button>
                        </div>
                    `;
                    loadingElement.style.display = 'block';
                }
            }
        }

        function renderParticipantsForModal(participations) {
            // Compat√≠vel com ambos os modais
            const containerNew = document.getElementById('participants-items');
            const containerOld = document.getElementById('participantsList');
            const container = containerNew || containerOld;

            if (!container) {
                console.error('‚ùå Container de participantes n√£o encontrado');
                return;
            }

            // CONVERTER PENDENTES EM FORMATO DE PARTICIPA√á√ÉO
            const pendingAsParticipations = pendingExtraMembers.map(m => ({
                id: `temp-${m.uid}`, // ID tempor√°rio
                id_membro: m.uid,
                nome_membro: m.nome,
                tipo: 'extra',
                participou: 'sim', // ‚úÖ J√° marcado como participou
                chegou_tarde: '',
                saiu_cedo: '',
                observacoes: '',
                deleted: '',
                isPending: true // Flag para identificar
            }));

            // COMBINAR: participa√ß√µes do banco + pendentes
            const allParticipations = [...participations, ...pendingAsParticipations];

            console.log('üë• [PARTICIPANTES] Renderizando:', participations.length, 'do banco +', pendingExtraMembers.length, 'pendentes');

            // Backend j√° retorna nome_membro - n√£o precisa buscar todos os membros
            let html = '';
            allParticipations.forEach(participation => {
                console.log('üë• [PARTICIPANTES] Processando participa√ß√£o:', participation.id_membro, participation.nome_membro);
                const memberName = participation.nome_membro || `Nome n√£o encontrado (ID: ${participation.id_membro})`;
                const isPending = participation.isPending || false;

                        html += `
                            <div class="participant-item"
                                 data-deleted="${participation.deleted || ''}"
                                 data-table-id="${participation.id}"
                                 data-pending="${isPending}"
                                 style="
                                background: ${isPending ? '#fffbeb' : 'white'};
                                border: 1px solid ${isPending ? '#fbbf24' : 'var(--border-color)'};
                                border-radius: 8px;
                                padding: 16px;
                                margin-bottom: 12px;
                                ${isPending ? 'border-left: 4px solid #f59e0b;' : ''}
                                ${participation.deleted === 'x' ? 'opacity: 0.5; background: #fee; border-color: var(--danger);' : ''}
                            ">${isPending ? `
                                <div style="color: #f59e0b; font-size: 12px; font-weight: 600; margin-bottom: 8px;">
                                    ‚è≥ PENDENTE - Ser√° salvo ao clicar em "Salvar Participa√ß√µes"
                                </div>
                            ` : ''}
                                <!-- Linha 1: Nome + Checkbox Participou -->
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="
                                            width: 40px;
                                            height: 40px;
                                            background: var(--primary-light);
                                            border-radius: 50%;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            margin-right: 12px;
                                            font-weight: 600;
                                            color: var(--primary);
                                            flex-shrink: 0;
                                        ">
                                            ${memberName.charAt(0).toUpperCase()}
                                        </div>
                                        <h5 style="margin: 0; font-weight: 600; color: var(--text);">
                                            ${memberName}
                                        </h5>
                                    </div>

                                    <label style="
                                        display: flex;
                                        align-items: center;
                                        cursor: pointer;
                                        font-weight: 500;
                                        color: #374151;
                                        white-space: nowrap;
                                    ">
                                        <input
                                            type="checkbox"
                                            id="participou-${participation.id}"
                                            data-participation-id="${participation.id}"
                                            data-member-id="${participation.id_membro}"
                                            onchange="toggleParticipationOptions(this)"
                                            ${participation.participou === 'sim' ? 'checked' : ''}
                                            style="
                                                margin-right: 8px;
                                                width: 18px;
                                                height: 18px;
                                                accent-color: var(--primary);
                                                cursor: pointer;
                                            "
                                        >
                                        Participou
                                    </label>
                                </div>

                                <!-- Linha 2: -- (esquerda) + Checkboxes lado a lado (direita, alinhados abaixo do Participou) -->
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-left: 52px;">
                                    <div style="color: #6b7280; font-size: 14px;">
                                        --
                                    </div>

                                    <div id="options-${participation.id}" style="
                                        display: ${participation.participou === 'sim' ? 'flex' : 'none'};
                                        gap: 16px;
                                        flex-wrap: nowrap;
                                    ">
                                        <label style="
                                            display: flex;
                                            align-items: center;
                                            cursor: pointer;
                                            font-size: 14px;
                                            color: #6b7280;
                                            white-space: nowrap;
                                        ">
                                            <input
                                                type="checkbox"
                                                id="chegou-tarde-${participation.id}"
                                                ${participation.chegou_tarde === 'sim' ? 'checked' : ''}
                                                style="
                                                    margin-right: 6px;
                                                    width: 16px;
                                                    height: 16px;
                                                    accent-color: var(--warning);
                                                "
                                            >
                                            Chegou tarde
                                        </label>

                                        <label style="
                                            display: flex;
                                            align-items: center;
                                            cursor: pointer;
                                            font-size: 14px;
                                            color: #6b7280;
                                            white-space: nowrap;
                                        ">
                                            <input
                                                type="checkbox"
                                                id="saiu-cedo-${participation.id}"
                                                ${participation.saiu_cedo === 'sim' ? 'checked' : ''}
                                                style="
                                                    margin-right: 6px;
                                                    width: 16px;
                                                    height: 16px;
                                                    accent-color: var(--warning);
                                                "
                                            >
                                            Saiu cedo
                                        </label>
                                    </div>
                                </div>

                                <!-- Campo Observa√ß√µes -->
                                <div style="padding-left: 52px;">
                                    <label style="
                                        display: block;
                                        font-size: 14px;
                                        color: #6b7280;
                                        margin-bottom: 6px;
                                    ">
                                        Observa√ß√µes
                                    </label>
                                    <textarea
                                        id="observacoes-${participation.id}"
                                        placeholder="Adicione observa√ß√µes sobre a participa√ß√£o..."
                                        style="
                                            width: 100%;
                                            min-height: 60px;
                                            padding: 8px 12px;
                                            border: 1px solid #d1d5db;
                                            border-radius: 6px;
                                            font-size: 14px;
                                            font-family: inherit;
                                            resize: vertical;
                                            color: #374151;
                                        "
                                    >${participation.observacoes || ''}</textarea>
                                </div>
                            </div>
                        `;
            });

            container.innerHTML = html;
        }

        // ===== BUSCA E ADI√á√ÉO DE MEMBROS EXTRAS =====

        let searchTimeout;
        let currentActivityIdForExtraMember = null;
        let extraMemberSearchInitialized = false;
        let pendingExtraMembers = []; // Membros extras adicionados localmente, ainda n√£o salvos no banco
        let currentParticipations = []; // Participa√ß√µes carregadas do banco (para valida√ß√£o de duplicatas)

        function initExtraMemberSearch(activityId) {
            currentActivityIdForExtraMember = activityId;
            const searchInput = document.getElementById('search-extra-member');
            const suggestionsContainer = document.getElementById('member-suggestions');

            if (!searchInput) return;

            // Evitar adicionar m√∫ltiplos event listeners
            if (extraMemberSearchInitialized) return;
            extraMemberSearchInitialized = true;

            // Event listener para busca com debounce
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const searchTerm = e.target.value.trim();

                if (searchTerm.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                // Debounce: aguarda 300ms ap√≥s parar de digitar
                searchTimeout = setTimeout(() => {
                    searchMembersForExtra(searchTerm);
                }, 300);
            });

            // Fechar sugest√µes ao clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#addExtraMemberSection')) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        function searchMembersForExtra(searchTerm) {
            const suggestionsContainer = document.getElementById('member-suggestions');

            // Mostrar loading
            suggestionsContainer.innerHTML = '<div class="suggestion-item no-results">üîÑ Buscando...</div>';
            suggestionsContainer.style.display = 'block';

            // Buscar membros usando apiCall()
            (async () => {
                try {
                    // Enviar filtros como objeto √∫nico: {nome: 'termo', status: ['ativo', 'afastado']}
                    const result = await apiCall('searchMembersByCriteria', {
                        nome: searchTerm,
                        status: ['Ativo', 'Afastado'] // Array = filtro IN (m√∫ltiplos valores)
                    });
                    showMemberSuggestions(result);
                } catch (error) {
                    // Erro de sess√£o j√° tratado por apiCall()
                    if (!error.message || !error.message.includes('Sess√£o')) {
                        console.error('‚ùå Erro ao buscar membros:', error);
                        suggestionsContainer.innerHTML = '<div class="suggestion-item no-results">‚ùå Erro ao buscar membros</div>';
                    }
                }
            })();
        }

        function showMemberSuggestions(result) {
            const suggestionsContainer = document.getElementById('member-suggestions');

            if (!result || !result.ok || !result.items || result.items.length === 0) {
                suggestionsContainer.innerHTML = '<div class="suggestion-item no-results">Nenhum membro encontrado</div>';
                suggestionsContainer.style.display = 'block';
                return;
            }

            const members = result.items;
            const html = members.map(member => `
                <div class="suggestion-item" onclick="addExtraMember('${member.codigo_sequencial}', '${escapeHtml(member.nome)}', '${escapeHtml(member.dojo || '')}')">
                    <div class="member-avatar">${member.nome.charAt(0).toUpperCase()}</div>
                    <div class="member-info">
                        <div class="member-name">${member.nome}</div>
                        <div class="member-dojo">${member.dojo || 'Sem dojo'}</div>
                    </div>
                </div>
            `).join('');

            suggestionsContainer.innerHTML = html;
            suggestionsContainer.style.display = 'block';
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function addExtraMember(memberId, memberName, memberDojo) {
            const activityId = currentActivityIdForExtraMember;

            if (!activityId) {
                showToast('Erro: ID da atividade n√£o encontrado', 'error');
                return;
            }

            // Verificar se membro j√° existe nas participa√ß√µes do banco
            const memberIdStr = String(memberId);
            const jaExisteNoBanco = currentParticipations.some(p => {
                return String(p.id_membro) === memberIdStr;
            });

            if (jaExisteNoBanco) {
                showToast('Este membro j√° est√° na lista de participantes', 'warning');
                return;
            }

            // Verificar se membro j√° foi adicionado localmente (pendente)
            const jaAdicionadoPendente = pendingExtraMembers.some(m => {
                return String(m.uid) === memberIdStr;
            });

            if (jaAdicionadoPendente) {
                showToast('Este membro j√° foi adicionado √† lista', 'warning');
                return;
            }

            // Adicionar membro em mem√≥ria (n√£o faz INSERT imediato)
            pendingExtraMembers.push({
                uid: memberId,
                nome: memberName,
                dojo: memberDojo || ''
            });

            // Re-renderizar lista combinada (banco + pendentes)
            loadActivityForParticipants(activityId);

            // Limpar campo de busca e sugest√µes
            const searchInput = document.getElementById('search-extra-member');
            const suggestionsContainer = document.getElementById('member-suggestions');
            if (searchInput) searchInput.value = '';
            if (suggestionsContainer) suggestionsContainer.style.display = 'none';

            // Feedback ao usu√°rio
            showToast(`${memberName} adicionado. Clique em "Salvar Participa√ß√µes" para confirmar.`, 'info');
        }

        function toggleParticipationOptions(checkbox) {
            const participationId = checkbox.dataset.participationId;
            const optionsDiv = document.getElementById(`options-${participationId}`);

            if (checkbox.checked) {
                optionsDiv.style.display = 'flex';
            } else {
                optionsDiv.style.display = 'none';
                // Limpar subcampos quando desmarcar participa√ß√£o
                document.getElementById(`chegou-tarde-${participationId}`).checked = false;
                document.getElementById(`saiu-cedo-${participationId}`).checked = false;
            }
        }

        async function saveAllParticipations(activityId) {
            const saveBtn = document.getElementById('save-participations-btn');
            const originalContent = saveBtn.innerHTML;

            try {
                console.log('üíæ Salvando todas as participa√ß√µes para atividade:', activityId);

                // Mostrar loading
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<div class="loading-select-spinner" style="margin: 0 auto;"></div>';

                // ========== 1. COLETAR E INSERIR NOVOS EXTRAS PENDENTES (SE HOUVER) ==========
                if (pendingExtraMembers.length > 0) {
                    console.log('‚ûï Inserindo', pendingExtraMembers.length, 'membros extras...');

                    // Coletar dados da interface para cada pendente
                    const membrosData = pendingExtraMembers.map(m => {
                        const tempId = `temp-${m.uid}`;
                        const participouCheckbox = document.getElementById(`participou-${tempId}`);
                        const chegouTardeCheckbox = document.getElementById(`chegou-tarde-${tempId}`);
                        const saiuCedoCheckbox = document.getElementById(`saiu-cedo-${tempId}`);
                        const observacoesTextarea = document.getElementById(`observacoes-${tempId}`);

                        return {
                            memberId: m.uid,
                            tipo: 'extra',
                            participou: (participouCheckbox && participouCheckbox.checked) ? 'sim' : 'nao',
                            chegou_tarde: (chegouTardeCheckbox && chegouTardeCheckbox.checked) ? 'sim' : 'nao',
                            saiu_cedo: (saiuCedoCheckbox && saiuCedoCheckbox.checked) ? 'sim' : 'nao',
                            observacoes: observacoesTextarea ? observacoesTextarea.value.trim() : ''
                        };
                    });

                    const insertResult = await apiCall('createMultipleParticipacoes',
                        activityId,
                        membrosData,
                        State.user?.uid || ''
                    );

                    if (!insertResult.ok) {
                        throw new Error('Falha ao criar membros extras: ' + (insertResult.error || 'Erro desconhecido'));
                    }

                    console.log('‚úÖ Membros extras criados:', insertResult.created);
                }

                // ========== 2. COLETAR UPDATES DOS EXISTENTES ==========
                const participationUpdates = [];
                const participantItems = document.querySelectorAll('.participant-item');

                participantItems.forEach(item => {
                    // IGNORAR PENDENTES (j√° foram inseridos acima)
                    if (item.dataset.pending === 'true') {
                        console.log('‚è≠Ô∏è Pulando item pendente (j√° inserido no banco)');
                        return;
                    }

                    const participouCheckbox = item.querySelector('input[data-participation-id]');
                    const participationId = participouCheckbox.dataset.participationId;
                    const memberId = participouCheckbox.dataset.memberId;
                    const tableId = item.dataset.tableId; // ID da tabela participa√ß√µes

                    // Verificar se o registro est√° marcado como deletado nos dados originais
                    // O campo deleted tem valor "x" quando deletado
                    const isDeleted = item.dataset.deleted === 'x';

                    if (isDeleted) {
                        console.log('üóëÔ∏è Pulando participa√ß√£o marcada como deletada (deleted = x):', participationId);
                        return; // N√£o processa itens deletados
                    }

                    const chegouTardeCheckbox = item.querySelector(`#chegou-tarde-${participationId}`);
                    const saiuCedoCheckbox = item.querySelector(`#saiu-cedo-${participationId}`);
                    const observacoesTextarea = item.querySelector(`#observacoes-${participationId}`);

                    const participationData = {
                        tableId: tableId, // ID da tabela para update direto
                        participationId: participationId,
                        memberId: memberId,
                        participou: participouCheckbox.checked ? 'sim' : 'nao',
                        chegou_tarde: (chegouTardeCheckbox && chegouTardeCheckbox.checked) ? 'sim' : 'nao',
                        saiu_cedo: (saiuCedoCheckbox && saiuCedoCheckbox.checked) ? 'sim' : 'nao',
                        observacoes: observacoesTextarea ? observacoesTextarea.value.trim() : ''
                    };

                    participationUpdates.push(participationData);
                });

                console.log('üìä Dados coletados para salvar:', participationUpdates);
                console.log('üîç [DEBUG] Primeiro item completo:', JSON.stringify(participationUpdates[0], null, 2));

                // Salvar cada participa√ß√£o no backend usando ID da tabela participa√ß√µes
                const savePromises = participationUpdates.map(async (data) => {
                    console.log('üíæ Salvando participa√ß√£o ID:', data.tableId, 'com dados:', {
                        participou: data.participou,
                        chegou_tarde: data.chegou_tarde,
                        saiu_cedo: data.saiu_cedo,
                        observacoes: data.observacoes
                    });

                    return await apiCall('saveParticipacaoDirectly', null, null, {
                        id: data.tableId, // ID espec√≠fico da tabela participa√ß√µes
                        participou: data.participou,
                        chegou_tarde: data.chegou_tarde,
                        saiu_cedo: data.saiu_cedo,
                        observacoes: data.observacoes
                    }, '');
                });

                const results = await Promise.all(savePromises);
                console.log('‚úÖ Resultados do salvamento:', results);

                // Verificar se todos foram salvos com sucesso
                const failures = results.filter(result => !result.ok);
                if (failures.length > 0) {
                    throw new Error(`${failures.length} participa√ß√µes falharam ao salvar`);
                }

                // ========== 3. LIMPAR PENDENTES ==========
                pendingExtraMembers = [];
                console.log('üßπ Membros extras pendentes limpos da mem√≥ria');

                // Fechar modal
                closeEditActivityModal();

                // Atualizar card para refletir novos contadores
                console.log('üîÑ Chamando updateSingleActivityCard para:', activityId);
                updateSingleActivityCard(activityId);

                // Mostrar mensagem de sucesso
                showToast('Participa√ß√µes salvas com sucesso!', 'success');

            } catch (error) {
                console.error('‚ùå Erro ao salvar participa√ß√µes:', error);
                showToast('Erro ao salvar participa√ß√µes: ' + (error.message || error), 'error');
            } finally {
                // Restaurar bot√£o
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
            }
        }



        async function loadActivityForEdit(activityId, retryCount = 0) {
            console.log(`Carregando atividade para edi√ß√£o: ${activityId} (tentativa ${retryCount + 1})`);

            // Tentar carregar dados reais da API
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                try {
                    const result = await apiCall('getActivityById', activityId);

                    console.log('üì• Resposta da API getActivityById:', result);
                    console.log('üîç Tipo da resposta:', typeof result);
                    console.log('üîç Resposta serializada:', JSON.stringify(result));

                    // Verifica√ß√£o mais robusta com retry
                    if (result === null || result === undefined) {
                        console.error(`‚ùå Resposta nula da API (tentativa ${retryCount + 1}) - poss√≠vel problema de serializa√ß√£o`);

                        if (retryCount < 2) {
                            console.log(`‚è≥ Tentando novamente em 1 segundo... (retry ${retryCount + 1})`);
                            setTimeout(() => {
                                loadActivityForEdit(activityId, retryCount + 1);
                            }, 1000);
                            return;
                        } else {
                            showEditActivityDataLoading(false);
                            showToast('Erro de comunica√ß√£o persistente com o servidor. Tente novamente mais tarde.', 'error');
                            return;
                        }
                    }

                    if (result && result.ok === true && result.activity) {
                        const activity = result.activity;

                        // Mostrar formul√°rio e esconder loading
                        showEditActivityDataLoading(false);

                        // Preencher campos b√°sicos
                        document.getElementById('edit-activity-name').value = activity.titulo || '';
                        document.getElementById('edit-activity-description').value = activity.descricao || '';
                        document.getElementById('edit-activity-tags').value = activity.tags || '';

                            // Processar data/hora
                            if (activity.data) {
                                const dataString = activity.data.toString();
                                console.log('üìÖ Processando data recebida:', dataString);

                                // Tentar diferentes formatos de data
                                let date;
                                if (dataString.includes('T')) {
                                    // Formato ISO: 2025-09-25T14:30:00
                                    date = new Date(dataString);
                                } else if (dataString.includes(' ')) {
                                    // Formato brasileiro: 2025-09-25 14:30:00
                                    date = new Date(dataString.replace(' ', 'T'));
                                } else {
                                    // S√≥ data: 2025-09-25
                                    date = new Date(dataString + 'T00:00:00');
                                }

                                if (!isNaN(date.getTime())) {
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const hours = String(date.getHours()).padStart(2, '0');
                                    const minutes = String(date.getMinutes()).padStart(2, '0');

                                    document.getElementById('edit-activity-date').value = `${year}-${month}-${day}`;
                                    document.getElementById('edit-activity-time').value = `${hours}:${minutes}`;
                                    console.log('‚úÖ Data/hora definida:', `${year}-${month}-${day} ${hours}:${minutes}`);
                                }
                            }

                            // Processar categorias m√∫ltiplas - aguardar carregamento
                            if (activity.categorias_ids) {
                                const selectCategories = () => {
                                    const catSelect = document.getElementById('edit-activity-category');
                                    if (catSelect && catSelect.options.length > 3) { // Verificar se carregou (> op√ß√µes padr√£o)
                                        const categoriaIds = activity.categorias_ids.split(',').map(id => id.trim());
                                        console.log('üè∑Ô∏è Categorias a selecionar:', categoriaIds);

                                        // Limpar sele√ß√µes anteriores
                                        Array.from(catSelect.options).forEach(option => {
                                            option.selected = false;
                                        });

                                        // Selecionar categorias corretas
                                        Array.from(catSelect.options).forEach(option => {
                                            if (categoriaIds.includes(option.value)) {
                                                option.selected = true;
                                                console.log('üè∑Ô∏è Categoria selecionada:', option.value, option.text);
                                            }
                                        });
                                    } else {
                                        // Tentar novamente se ainda n√£o carregou
                                        setTimeout(selectCategories, 200);
                                    }
                                };
                                setTimeout(selectCategories, 100);
                            }

                            // Selecionar respons√°vel - aguardar carregamento
                            if (activity.atribuido_uid) {
                                const selectResponsible = () => {
                                    const respSelect = document.getElementById('edit-activity-responsible');
                                    if (respSelect && respSelect.options.length > 1) { // Verificar se carregou
                                        respSelect.value = activity.atribuido_uid;
                                        if (respSelect.value === activity.atribuido_uid) {
                                            console.log('üë§ Respons√°vel definido:', activity.atribuido_uid);
                                        } else {
                                            console.warn('‚ö†Ô∏è Respons√°vel n√£o encontrado nas op√ß√µes:', activity.atribuido_uid);
                                        }
                                    } else {
                                        // Tentar novamente se ainda n√£o carregou
                                        setTimeout(selectResponsible, 200);
                                    }
                                };
                                setTimeout(selectResponsible, 100);
                            }
                    } else {
                        console.error('Erro ao carregar atividade:', result);
                        showEditActivityDataLoading(false);
                        showToast('Erro ao carregar atividade: ' + (result?.error || 'Erro desconhecido'), 'error');
                    }
                } catch (error) {
                    // Erro de sess√£o j√° tratado por apiCall()
                    if (!error.message || !error.message.includes('Sess√£o')) {
                        console.error('Erro na API ao carregar atividade:', error);
                        showEditActivityDataLoading(false);
                        showToast('Erro ao conectar com o servidor.', 'error');
                    }
                }
            } else {
                console.log('‚ö†Ô∏è API n√£o dispon√≠vel, usando fallback');
                showEditActivityDataLoading(false);
                showToast('Sistema em modo de desenvolvimento. API n√£o dispon√≠vel.', 'warning');
            }
        }

        function showEditActivityDataLoading(show) {
            const loadingState = document.getElementById('editActivityLoadingState');
            const formContent = document.getElementById('editActivityFormContent');

            if (show) {
                // Mostrar loading, esconder formul√°rio
                if (loadingState) {
                    loadingState.style.display = 'flex';
                }
                if (formContent) {
                    formContent.style.display = 'none';
                }
            } else {
                // Mostrar formul√°rio, esconder loading
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                if (formContent) {
                    formContent.style.display = 'block';
                }
            }
        }

        function showEditActivitySaveLoading(show) {
            const formContent = document.getElementById('editActivityFormContent');
            const savingState = document.getElementById('editActivitySavingState');

            if (show) {
                // Mostrar loading de salvar, esconder formul√°rio
                if (formContent) {
                    formContent.style.display = 'none';
                }
                if (savingState) {
                    savingState.style.display = 'flex';
                }
            } else {
                // Mostrar formul√°rio, esconder loading de salvar
                if (formContent) {
                    formContent.style.display = 'block';
                }
                if (savingState) {
                    savingState.style.display = 'none';
                }
            }
        }

        function updateActivity(activityId) {
            console.log('üîÑ Atualizando atividade:', activityId);

            // Coletar dados do formul√°rio com debug
            console.log('üîç DEBUG: Coletando dados do formul√°rio...');

            const categorySelect = document.getElementById('edit-activity-category');
            const selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);

            // Debug individual dos campos
            const tituloEl = document.getElementById('edit-activity-name');
            const dateEl = document.getElementById('edit-activity-date');
            const timeEl = document.getElementById('edit-activity-time');
            const descricaoEl = document.getElementById('edit-activity-description');
            const responsibleEl = document.getElementById('edit-activity-responsible');
            const tagsEl = document.getElementById('edit-activity-tags');

            console.log('üîç DEBUG: Elementos encontrados:', {
                tituloEl: !!tituloEl,
                dateEl: !!dateEl,
                timeEl: !!timeEl,
                descricaoEl: !!descricaoEl,
                responsibleEl: !!responsibleEl,
                tagsEl: !!tagsEl,
                categorySelect: !!categorySelect
            });

            const formData = {
                id: activityId,
                titulo: tituloEl ? tituloEl.value : '',
                categorias: selectedCategories,
                data: (dateEl ? dateEl.value : '') + 'T' + (timeEl ? timeEl.value : ''),
                descricao: descricaoEl ? descricaoEl.value : '',
                atribuido_uid: responsibleEl ? responsibleEl.value : '',
                tags: tagsEl ? tagsEl.value : '',
                alvos: Array.from(selectedTargets) // Adicionar alvos selecionados
            };

            console.log('üìù Dados para atualiza√ß√£o:', formData);
            console.log('üîç DEBUG: T√≠tulo coletado:', `"${formData.titulo}"`, 'Length:', formData.titulo.length);

            // Valida√ß√£o b√°sica
            if (!formData.titulo) {
                showToast('Nome da atividade √© obrigat√≥rio', 'warning');
                return;
            }

            if (!selectedCategories.length) {
                showToast('Selecione pelo menos uma categoria', 'warning');
                return;
            }

            if (!formData.data || formData.data === 'T') {
                showToast('Data e hor√°rio s√£o obrigat√≥rios', 'warning');
                return;
            }

            if (!formData.atribuido_uid) {
                showToast('Selecione um respons√°vel pela atividade', 'warning');
                return;
            }

            // Mostrar loading de salvar
            showEditActivitySaveLoading(true);

            // Tentar conectar com API real
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                (async () => {
                    try {
                        const result = await apiCall('updateActivityWithTargets', {
                            id: formData.id,
                            patch: {
                                titulo: formData.titulo,
                                descricao: formData.descricao,
                                data: formData.data,
                                atribuido_uid: formData.atribuido_uid,
                                categorias_ids: Array.isArray(formData.categorias) ? formData.categorias.join(',') : formData.categorias, // Converter array para string CSV
                                tags: formData.tags // String de tags separadas por v√≠rgula
                            },
                            alvos: formData.alvos
                        });

                        // Esconder loading
                        showEditActivitySaveLoading(false);

                        if (result && result.ok) {
                            showToast('Atividade atualizada com sucesso!', 'success');
                            closeEditActivityModal();

                            // Aguardar modal fechar antes de atualizar card
                            setTimeout(() => {
                                updateSingleActivityCard(formData.id); // Atualizar card espec√≠fico
                            }, 300);
                        } else {
                            showToast('Erro ao atualizar atividade: ' + (result.error || 'Erro desconhecido'), 'error');
                            closeEditActivityModal(); // Fechar mesmo com erro
                        }
                    } catch (error) {
                        // Esconder loading
                        showEditActivitySaveLoading(false);

                        // Erro de sess√£o j√° tratado por apiCall()
                        if (!error.message || !error.message.includes('Sess√£o')) {
                            console.error('Erro na API:', error);
                            showToast('Erro ao conectar com o servidor. Tente novamente.', 'error');
                        }

                        closeEditActivityModal(); // Fechar mesmo com erro
                    }
                })();
                return;
            }

            // N√£o h√° API dispon√≠vel - esconder loading e mostrar erro
            showEditActivitySaveLoading(false);
            showToast('Erro: Sistema n√£o conseguiu conectar com o servidor. Verifique sua conex√£o e tente novamente.', 'error');
            closeEditActivityModal(); // Fechar mesmo com erro
        }

        function submitActivity(event) {
            if (event) {
                event.preventDefault();
            }

            // Coletar categorias selecionadas
            const categorySelect = document.getElementById('activity-category');
            const selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);

            const formData = {
                titulo: document.getElementById('activity-name').value,
                categorias: selectedCategories, // Array de categorias
                data: document.getElementById('activity-date').value + 'T' + document.getElementById('activity-time').value,
                // status ser√° definido como 'Pendente' automaticamente no backend (valor padr√£o)
                descricao: document.getElementById('activity-description').value,
                atribuido_uid: document.getElementById('activity-responsible').value,
                tags: document.getElementById('activity-tags').value
            };

            console.log('Criando nova atividade:', formData);

            // Valida√ß√£o b√°sica
            if (!formData.titulo) {
                showToast('Nome da atividade √© obrigat√≥rio', 'warning');
                return;
            }

            if (!selectedCategories.length) {
                showToast('Selecione pelo menos uma categoria', 'warning');
                return;
            }

            if (!formData.data || formData.data === 'T') {
                showToast('Data e hor√°rio s√£o obrigat√≥rios', 'warning');
                return;
            }

            if (!formData.atribuido_uid) {
                showToast('Selecione um respons√°vel pela atividade', 'warning');
                return;
            }

            // Mostrar loading overlay
            showCreateActivityLoading(true);

            // Tentar conectar com API real
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                const uid = localStorage.getItem('uid') || 'U001';

                (async () => {
                    try {
                        const result = await apiCall('createActivity', formData, uid);

                        if (result && result.ok) {
                            console.log('‚úÖ Atividade criada com sucesso, ID:', result.id);

                            // Verificar se h√° alvos selecionados para salvar
                            if (selectedTargets.size > 0) {
                                console.log('üíæ Salvando alvos da atividade...');
                                saveTargetsAfterActivity(result.id);
                            } else {
                                // Sem alvos, finalizar processo
                                showCreateActivityLoading(false);
                                showToast('Atividade criada com sucesso!', 'success');
                                closeActivityModal();
                                loadActivities();
                            }
                        } else {
                            showCreateActivityLoading(false);
                            showToast('Erro ao criar atividade: ' + (result.error || 'Erro desconhecido'), 'error');
                        }
                    } catch (error) {
                        showCreateActivityLoading(false);

                        // Erro de sess√£o j√° tratado por apiCall()
                        if (!error.message || !error.message.includes('Sess√£o')) {
                            console.error('Erro na API:', error);
                            showToast('Erro ao conectar com o servidor. Tente novamente.', 'error');
                        }
                    }
                })();
                return;
            }

            // N√£o h√° API dispon√≠vel - esconder loading e mostrar erro
            showCreateActivityLoading(false);
            showToast('Erro: Sistema n√£o conseguiu conectar com o servidor. Verifique sua conex√£o e tente novamente.', 'error');
            console.error('Erro: Google Apps Script n√£o dispon√≠vel');
        }

        function showCreateActivityLoading(show) {
            const formContent = document.getElementById('createActivityFormContent');
            const loadingState = document.getElementById('createActivityLoadingState');

            if (show) {
                // Esconder formul√°rio e mostrar loading
                if (formContent) {
                    formContent.style.display = 'none';
                }
                if (loadingState) {
                    loadingState.style.display = 'flex';
                }
            } else {
                // Mostrar formul√°rio e esconder loading
                if (formContent) {
                    formContent.style.display = 'block';
                }
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
            }
        }

        // Fun√ß√£o removida - agora usamos updateActivity()

        // Fechar modal ao pressionar ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const activityModal = document.getElementById('activityModal');
                const editActivityModal = document.getElementById('editActivityModal');
                const participantsModal = document.getElementById('participantsModal');

                if (activityModal && activityModal.style.display === 'flex') {
                    closeActivityModal();
                }
                if (editActivityModal && editActivityModal.style.display === 'flex') {
                    closeEditActivityModal();
                }
                if (participantsModal && participantsModal.style.display === 'flex') {
                    closeParticipantsModal();
                }
            }
        });

        // ===== CARREGAMENTO DIN√ÇMICO DO USU√ÅRIO =====
        function loadCurrentUser() {
            // M√©todo 1: Tentar primeiro do localStorage (dados reais do login)
            try {
                const uid = localStorage.getItem('uid');
                const userName = localStorage.getItem('userName');

                if (uid && userName) {
                    updateUserMenuInfo({ uid, nome: userName });
                    return;
                }
            } catch (error) {
                console.error('Erro ao ler localStorage:', error);
            }

            // M√©todo 2: Tentar via app_state (backup)
            try {
                const userStr = localStorage.getItem('user');
                if (userStr) {
                    const user = JSON.parse(userStr);
                    if (user && user.nome) {
                        updateUserMenuInfo(user);
                        return;
                    }
                }
            } catch (error) {
                console.error('Erro ao ler app_state:', error);
            }

            // M√©todo 3: Fallback para API apenas se necess√°rio
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(function(user) {
                        if (user && user.nome) {
                            updateUserMenuInfo(user);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Erro ao carregar usu√°rio via API:', error);
                    })
                    .getCurrentLoggedUser();
            }
        }

        function updateUserMenuInfo(user) {
            try {
                const userNameEl = document.getElementById('userMenuName');
                const userAvatarEl = document.getElementById('userMenuAvatar');
                const userRoleEl = document.getElementById('userMenuRole');

                if (userNameEl && user.nome) {
                    userNameEl.textContent = user.nome;
                }

                if (userAvatarEl && user.nome) {
                    // Gerar iniciais a partir do nome
                    const initials = user.nome
                        .split(' ')
                        .slice(0, 2)
                        .map(n => n.charAt(0).toUpperCase())
                        .join('');
                    userAvatarEl.textContent = initials;
                }

                if (userRoleEl) {
                    // Manter "--" como especificado
                    userRoleEl.textContent = '--';
                }

                // Atualizar dropdown se a fun√ß√£o existir
                if (typeof updateDropdownUserInfo === 'function') {
                    updateDropdownUserInfo(user);
                }

            } catch (error) {
                console.error('‚ùå Erro ao atualizar informa√ß√µes do usu√°rio:', error);
            }
        }

        // ============================================================================
        // PRE-LOAD: Carregar categorias e respons√°veis no cache ao iniciar a aplica√ß√£o
        // ============================================================================
        function preLoadCachedData() {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                // Carregar categorias em paralelo usando apiCall()
                (async () => {
                    try {
                        const result = await apiCall('listCategoriasAtividadesApi');
                        if (result && result.ok && result.items) {
                            window.cachedCategorias = result.items;
                            console.log('‚ö° Cache de categorias pr√©-carregado:', result.items.length);
                        }
                    } catch (error) {
                        // Erro de sess√£o j√° tratado por apiCall()
                        if (!error.message || !error.message.includes('Sess√£o')) {
                            console.error('‚ùå Erro ao pr√©-carregar categorias:', error);
                        }
                    }
                })();

                // Carregar respons√°veis em paralelo usando apiCall()
                (async () => {
                    try {
                        const result = await apiCall('listUsuariosApi');
                        if (result && result.ok && result.items) {
                            window.cachedResponsaveis = result.items;
                            console.log('‚ö° Cache de respons√°veis pr√©-carregado:', result.items.length);
                        }
                    } catch (error) {
                        // Erro de sess√£o j√° tratado por apiCall()
                        if (!error.message || !error.message.includes('Sess√£o')) {
                            console.error('‚ùå Erro ao pr√©-carregar respons√°veis:', error);
                        }
                    }
                })();
            }
        }

        // ===== INICIALIZA√á√ÉO =====
        // NOTA: Inicializa√ß√£o agora √© feita em src/05-components/core/init.html
        // Removido DOMContentLoaded duplicado que causava carregamentos duplos

        // ===== FUN√á√ïES DE GEST√ÉO DE ALVOS =====

        // Vari√°veis globais para gest√£o de alvos
        let currentActivityId = null;
        let currentTargetsData = [];
        let selectedTargets = new Set();
        // Cache global para manter dados de membros selecionados de buscas anteriores
        window.allMembersCache = new Map();

        // Fun√ß√£o para mostrar/esconder bot√£o ap√≥s salvar atividade
        function showTargetsButton(mode = 'create') {
            const button = document.getElementById(mode === 'create' ? 'targets-toggle-btn' : 'edit-targets-toggle-btn');
            if (button) {
                button.style.display = 'inline-flex';
            }
        }

        // Fun√ß√£o principal para toggle da se√ß√£o de alvos
        function toggleTargetsSection(mode = 'create', activityId = null) {
            console.log('üéØ Toggle targets section:', mode, activityId);

            const sectionId = mode === 'create' ? 'targetsSection' : 'editTargetsSection';
            const section = document.getElementById(sectionId);

            if (!section) {
                console.error('‚ùå Se√ß√£o de alvos n√£o encontrada:', sectionId);
                return;
            }

            const isVisible = section.style.display !== 'none';

            if (isVisible) {
                // Esconder se√ß√£o
                console.log('üîΩ Escondendo se√ß√£o de alvos');
                section.style.display = 'none';
                resetTargetsSection(mode);
            } else {
                // Mostrar se√ß√£o
                console.log('üîº Mostrando se√ß√£o de alvos');
                section.style.display = 'block';

                // Debug CSS
                console.log('üîç Estado da se√ß√£o ap√≥s mostrar:');
                console.log('- display:', section.style.display);
                console.log('- offsetHeight:', section.offsetHeight);
                console.log('- clientHeight:', section.clientHeight);
                console.log('- visibility:', getComputedStyle(section).visibility);
                console.log('- opacity:', getComputedStyle(section).opacity);

                currentActivityId = activityId;

                // Scroll suave para a se√ß√£o
                setTimeout(() => {
                    console.log('üéØ Fazendo scroll para a se√ß√£o');
                    section.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 200);

                // Inicializar dados da se√ß√£o
                initializeTargetsSection(mode, activityId);
            }
        }

        // Inicializar se√ß√£o de alvos
        function initializeTargetsSection(mode = 'create', activityId = null) {
            console.log('üîÑ Inicializando se√ß√£o de alvos:', mode, activityId);

            // Carregar filtros
            loadTargetFilters(mode);

            // Se modo edi√ß√£o e h√° activityId, mostrar lista de selecionados imediatamente e carregar alvos existentes
            if (mode === 'edit' && activityId) {
                // Mostrar container de selecionados imediatamente
                showSelectedTargetsContainerWithLoading(mode);
                loadExistingTargets(activityId);
            } else if (mode === 'edit') {
                // S√≥ mostrar empty se n√£o h√° activityId (caso imposs√≠vel, mas por seguran√ßa)
                showTargetsEmpty(mode);
            } else {
                // No modo create, mostrar apenas a mensagem explicativa (filtros ficam sempre vis√≠veis)
                const emptyEl = document.getElementById('targetsEmpty');
                if (emptyEl) {
                    emptyEl.style.display = 'block';
                    console.log('‚úÖ Mostrando mensagem explicativa no modo create');
                }
            }
        }



</script>