<script>
    // ============================================================================
    // ACTIVITY HELPERS
    // Fun√ß√µes utilit√°rias espec√≠ficas para gerenciamento de atividades
    // ============================================================================

    /**
     * Renderiza um card de atividade completo
     * @param {Object} activity - Objeto da atividade
     * @returns {string} - HTML do card
     */
    function renderActivityCard(activity) {
        if (!activity || !activity.id) {
            console.warn('‚ö†Ô∏è renderActivityCard: activity inv√°lida', activity);
            return '';
        }

        // L√≥gica inteligente de status baseada na data
        const statusInfo = getSmartStatus(activity.status, activity.data);

        const categoryClass = activity.categoria.toLowerCase();

        const icon = activity.categoria_icone || 'üìã';

        const formattedDate = formatDate(activity.data);

        // Verificar se a atividade j√° passou (a partir do dia da atividade)
        const atividadeJaPassou = isActivityPast(activity.data);

        // ===== CONTROLE DE PERMISS√ïES =====
        // Obter usu√°rio logado
        const currentUserUid = State.uid || localStorage.getItem('uid');

        // Lista de administradores (permiss√£o total)
        const admins = ['U001', 'U002', 'U003', 'U004'];
        const isAdmin = admins.includes(currentUserUid);

        // Verificar se √© o respons√°vel pela atividade
        const isResponsavel = activity.atribuido_uid === currentUserUid;

        // Permiss√µes espec√≠ficas
        const podeVerParticipantes = isAdmin || isResponsavel;

        // Bot√£o editar s√≥ aparece se:
        // 1. Status n√£o √© Conclu√≠da
        // 2. Data da atividade ainda n√£o passou (hoje ou futuro)
        // 3. Usu√°rio √© admin (U001-U004)
        const podeEditar = statusInfo.text !== 'Conclu√≠da' && !atividadeJaPassou && isAdmin;

        return `
            <div class="card activity-card ${categoryClass}" data-activity-id="${activity.id}" style="display: flex; flex-direction: column; min-height: 280px;">
                <div style="padding: var(--spacing-md); flex: 1; display: flex; flex-direction: column;">
                    <!-- Parte Superior: Conte√∫do principal -->
                    <div style="flex: 1;">
                        <!-- Linha 1: √çcones das categorias + T√≠tulo -->
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
                            ${activity.categorias && activity.categorias.length > 0
                                ? activity.categorias.map(cat => `<div class="card-icon" style="color: ${cat.cor || '#6b7280'};" title="${cat.nome}">${cat.icone || 'üìã'}</div>`).join('')
                                : `<div class="card-icon">${icon}</div>`
                            }
                            <div class="card-title" style="flex: 1; margin: 0; font-size: var(--font-size-md); line-height: 1.3; cursor: help;" title="ID: ${activity.id}">${activity.titulo}</div>
                        </div>

                        <!-- Linha 2: Tags das categorias horizontais -->
                        <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs); margin-bottom: var(--spacing-xs);">
                            ${activity.categorias && activity.categorias.length > 0
                                ? activity.categorias.map(cat => `<div class="badge badge-info" style="font-size: var(--font-size-xs); background-color: ${cat.cor || '#6b7280'}; color: white;">${cat.nome}</div>`).join('')
                                : `<div class="badge badge-info" style="font-size: var(--font-size-xs); background-color: ${activity.categoria_cor || '#6b7280'}; color: white;">${activity.categoria}</div>`
                            }
                        </div>

                        <!-- Linha 3: Data/hora + Status -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                            <div class="activity-date" style="font-size: var(--font-size-xs); color: var(--text-light);">${formattedDate}</div>
                            <div class="badge ${statusInfo.class}" style="font-size: var(--font-size-xs);">${statusInfo.text}</div>
                        </div>

                        <!-- Linha 4: Respons√°vel -->
                        ${activity.atribuido_nome ? `<div style="font-size: var(--font-size-xs); color: var(--text-light); margin-bottom: var(--spacing-sm);">Respons√°vel: ${activity.atribuido_nome}</div>` : ''}

                        <!-- Linha 5: Descri√ß√£o -->
                        <div style="color: var(--text-light); font-size: var(--font-size-xs); line-height: 1.4;">
                            ${activity.descricao}
                        </div>
                    </div>

                    <!-- Parte Inferior: Contagens + Bot√µes (sempre alinhados no bottom) -->
                    <div style="margin-top: auto; padding-top: var(--spacing-sm);">
                        <!-- Sistema de Participa√ß√£o Unificado -->
                        <div class="participation-summary" style="margin-bottom: var(--spacing-sm);">
                            <div class="participation-row" style="margin-bottom: var(--spacing-xs);">
                                <span class="participation-label" style="font-size: var(--font-size-xs);">Alvo:</span>
                                <span class="participation-count total" style="font-size: var(--font-size-xs);">${activity.total_alvos || 0}</span>
                            </div>
                            <div class="participation-row" style="margin-bottom: var(--spacing-xs);">
                                <span class="participation-label" style="font-size: var(--font-size-xs);">Previs√£o:</span>
                                <div class="participation-values">
                                    <span class="participation-count confirmed" style="font-size: var(--font-size-xs);">${activity.confirmados || 0} confirmados</span>
                                    <span class="participation-count rejected" style="font-size: var(--font-size-xs);">${activity.rejeitados || 0} rejeitados</span>
                                </div>
                            </div>
                            <div class="participation-row">
                                <span class="participation-label" style="font-size: var(--font-size-xs);">Participa√ß√£o:</span>
                                <div class="participation-values">
                                    <span class="participation-count present" style="font-size: var(--font-size-xs);">${activity.participantes || 0} presentes</span>
                                    <span class="participation-count absent" style="font-size: var(--font-size-xs);">${activity.ausentes || 0} ausentes</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tags da atividade -->
                        ${activity.tags ? `<div style="margin-bottom: var(--spacing-sm); padding: var(--spacing-sm); background: var(--light); border-radius: var(--radius); border-left: 3px solid var(--primary);">
                            <div style="font-size: var(--font-size-xs); color: var(--text-light); margin-bottom: var(--spacing-xs);">üè∑Ô∏è Tags:</div>
                            <div style="font-size: var(--font-size-xs); color: var(--text); line-height: 1.4;">${activity.tags}</div>
                        </div>` : ''}

                        <!-- Bot√µes de a√ß√£o -->
                        <div class="activity-actions" style="display: flex; gap: var(--spacing-xs); justify-content: center;">
                            ${podeVerParticipantes
                                ? (statusInfo.text !== 'Conclu√≠da'
                                    ? `<button class="btn btn-primary" onclick="openParticipants('${activity.id}', \`${(activity.titulo || '').replace(/`/g, '')}\`, \`${(activity.descricao || '').replace(/`/g, '')}\`)" style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center;">üë• Participantes</button>`
                                    : `<button class="btn btn-outline" disabled style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center; opacity: 0.5; cursor: not-allowed;">üìä Resumo</button>`)
                                : ''
                            }
                            ${podeEditar ? `<button class="btn btn-outline" onclick="editActivity('${activity.id}')" style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center;">‚úèÔ∏è Editar</button>` : ''}
                            ${statusInfo.text !== 'Conclu√≠da' && isAdmin ? `<button class="btn btn-complete" onclick="completeActivity('${activity.id}')" style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center;">‚úÖ Concluir</button>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Renderiza m√∫ltiplas atividades em um grid
     * @param {Array} activities - Array de atividades
     */
    function renderActivities(activities) {
        const grid = document.getElementById('activities-grid');
        if (!grid || !activities) return;

        const html = activities.map(activity => renderActivityCard(activity)).join('');

        grid.innerHTML = html;
    }

    /**
     * Atualiza um card espec√≠fico validando contra filtros ativos
     * @param {string} activityId - ID da atividade
     * @param {Function} onComplete - Callback ap√≥s completar
     */
    async function updateSingleActivityCard(activityId, onComplete) {
        try {
            // Valida√ß√£o de entrada
            if (!activityId) {
                console.warn('‚ö†Ô∏è updateSingleActivityCard: activityId inv√°lido');
                return;
            }

            // Obter sessionId do localStorage
            const sessionId = localStorage.getItem('sessionId');
            if (!sessionId) {
                console.error('‚ùå SessionId n√£o encontrado');
                showToast('Sess√£o expirada. Fa√ßa login novamente.', 'error');
                return;
            }

            // Buscar atividade atualizada da API
            const result = await apiCall('getActivityById', activityId);

            if (!result || !result.ok || !result.activity) {
                console.warn('‚ö†Ô∏è Atividade n√£o encontrada ou resposta inv√°lida:', result);
                // Remover card se n√£o existe mais
                const cardElement = document.querySelector(`[data-activity-id="${activityId}"]`);
                if (cardElement) {
                    cardElement.remove();
                }
                return;
            }

            const updatedActivity = result.activity;

            // Verificar se atividade passa pelos filtros ativos
            const passesFilters = activityPassesFilters(updatedActivity);

            // Buscar card existente
            const cardElement = document.querySelector(`[data-activity-id="${activityId}"]`);

            if (passesFilters) {
                // Atividade passa pelos filtros - atualizar ou adicionar card
                const newCardHTML = renderActivityCard(updatedActivity);

                if (cardElement) {
                    // Substituir card existente
                    cardElement.outerHTML = newCardHTML;
                } else {
                    // Adicionar novo card no grid
                    const grid = document.getElementById('activities-grid');
                    if (grid) {
                        grid.insertAdjacentHTML('beforeend', newCardHTML);
                    }
                }
            } else {
                // Atividade N√ÉO passa pelos filtros - remover se existir
                if (cardElement) {
                    cardElement.remove();
                }
            }

            // Executar callback se fornecido
            if (typeof onComplete === 'function') {
                onComplete();
            }

        } catch (error) {
            console.error('‚ùå Erro ao atualizar card:', error);
        }
    }

    /**
     * Verifica se atividade passa pelos filtros ativos
     * @param {Object} activity - Objeto da atividade
     * @returns {boolean} - true se passa, false caso contr√°rio
     */
    function activityPassesFilters(activity) {
        // TODO: Implementar l√≥gica de verifica√ß√£o de filtros
        // Por enquanto retorna true (aceita todas)
        return true;
    }

    // Expor fun√ß√µes globalmente
    window.renderActivityCard = renderActivityCard;
    window.renderActivities = renderActivities;
    window.updateSingleActivityCard = updateSingleActivityCard;
    window.activityPassesFilters = activityPassesFilters;
</script>
