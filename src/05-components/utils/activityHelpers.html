<script>
    // ============================================================================
    // ACTIVITY HELPERS
    // Fun√ß√µes utilit√°rias espec√≠ficas para gerenciamento de atividades
    // ============================================================================

    /**
     * Renderiza um card de atividade completo
     * @param {Object} activity - Objeto da atividade
     * @returns {string} - HTML do card
     */
    function renderActivityCard(activity) {
        if (!activity || !activity.id) {
            console.warn('‚ö†Ô∏è renderActivityCard: activity inv√°lida', activity);
            return '';
        }

        // L√≥gica inteligente de status baseada na data
        const statusInfo = getSmartStatus(activity.status, activity.data);

        const categoryClass = activity.categoria.toLowerCase();

        const icon = activity.categoria_icone || 'üìã';

        const formattedDate = formatDate(activity.data);

        // Verificar se a atividade j√° passou (a partir do dia da atividade)
        const atividadeJaPassou = isActivityPast(activity.data);

        // ===== CONTROLE DE PERMISS√ïES =====
        // Obter usu√°rio logado
        const currentUserUid = State.uid || localStorage.getItem('uid');

        // Lista de administradores (permiss√£o total)
        const admins = ['U001', 'U002', 'U003', 'U004'];
        const isAdmin = admins.includes(currentUserUid);

        // Verificar se √© o respons√°vel pela atividade
        const isResponsavel = activity.atribuido_uid === currentUserUid;

        // ===== MATRIZ DE PERMISS√ïES DE BOT√ïES =====
        // Determinar categoria de tempo da atividade
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const dataAtividade = new Date(activity.data);
        dataAtividade.setHours(0, 0, 0, 0);

        const isAtrasada = dataAtividade < hoje;
        const isHoje = dataAtividade.getTime() === hoje.getTime();
        const isPendente = dataAtividade > hoje;

        // Compara√ß√£o case-insensitive (banco pode retornar 'concluida' ou 'Concluida')
        const statusLower = (activity.status || '').toLowerCase();
        const isConcluida = statusLower === 'concluida';
        const isCancelada = statusLower === 'cancelada';

        // Permiss√£o base: admin OU respons√°vel
        const canManage = isAdmin || isResponsavel;

        // Verificar se √© categoria "tarefa" (n√£o tem participantes nem alvos)
        const isTarefa = (activity.categoria || '').toLowerCase() === 'tarefa';

        // DEBUG: Log da classifica√ß√£o
        console.log(`üîç Card ${activity.id}:`, {
            data: activity.data,
            status: activity.status,
            isAtrasada,
            isHoje,
            isPendente,
            isConcluida,
            isCancelada,
            canManage,
            currentUser: currentUserUid,
            responsavel: activity.atribuido_uid
        });

        // Matriz de bot√µes conforme tabela:
        // STATUS      | Participantes | Editar | Cancelar | Concluir | Resumo
        // ATRASADA    | A/R           | -      | -        | A/R      | -
        // HOJE        | A/R           | A/R    | A/R      | A/R      | -
        // PENDENTE    | A/R           | A/R    | A/R      | A/R      | -
        // CONCLU√çDA   | -             | -      | -        | -        | A/R
        // CANCELADA   | -             | -      | -        | -        | -

        // IMPORTANTE: Todos os bot√µes (exceto Resumo) s√≥ aparecem se N√ÉO for Conclu√≠da E N√ÉO for Cancelada
        // Bot√£o Participantes: n√£o aparece para categoria "tarefa"
        const showParticipantes = !isTarefa && canManage && (isAtrasada || isHoje || isPendente) && !isConcluida && !isCancelada;
        // Bot√µes Editar e Cancelar: apenas para admin (isAdmin j√° definido na linha 36)
        const showEditar = isAdmin && (isHoje || isPendente) && !isConcluida && !isCancelada;
        const showCancelar = isAdmin && (isHoje || isPendente) && !isConcluida && !isCancelada;
        const showConcluir = canManage && (isAtrasada || isHoje || isPendente) && !isConcluida && !isCancelada;
        const showResumo = canManage && isConcluida; // S√≥ aparece em Conclu√≠da (desabilitado por enquanto)

        return `
            <div class="card activity-card ${categoryClass}" data-activity-id="${activity.id}" style="display: flex; flex-direction: column; min-height: 280px;">
                <div style="padding: var(--spacing-md); flex: 1; display: flex; flex-direction: column;">
                    <!-- Parte Superior: Conte√∫do principal -->
                    <div style="flex: 1;">
                        <!-- Linha 1: √çcones das categorias + T√≠tulo -->
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
                            ${activity.categorias && activity.categorias.length > 0
                                ? activity.categorias.map(cat => `<div class="card-icon" style="color: ${cat.cor || '#6b7280'};" title="${cat.nome}">${cat.icone || 'üìã'}</div>`).join('')
                                : `<div class="card-icon">${icon}</div>`
                            }
                            <div class="card-title" style="flex: 1; margin: 0; font-size: var(--font-size-md); line-height: 1.3; cursor: help;" title="ID: ${activity.id}">${activity.titulo}</div>
                        </div>

                        <!-- Linha 2: Tags das categorias horizontais -->
                        <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs); margin-bottom: var(--spacing-xs);">
                            ${activity.categorias && activity.categorias.length > 0
                                ? activity.categorias.map(cat => `<div class="badge badge-info" style="font-size: var(--font-size-xs); background-color: ${cat.cor || '#6b7280'}; color: white;">${cat.nome}</div>`).join('')
                                : `<div class="badge badge-info" style="font-size: var(--font-size-xs); background-color: ${activity.categoria_cor || '#6b7280'}; color: white;">${activity.categoria}</div>`
                            }
                        </div>

                        <!-- Linha 3: Data/hora + Status -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                            <div class="activity-date" style="font-size: var(--font-size-xs); color: var(--text-light);">${formattedDate}</div>
                            <div class="badge ${statusInfo.class}" style="font-size: var(--font-size-xs);">${statusInfo.text}</div>
                        </div>

                        <!-- Linha 4: Respons√°vel -->
                        ${activity.atribuido_nome ? `<div style="font-size: var(--font-size-xs); color: var(--text-light); margin-bottom: var(--spacing-sm);">Respons√°vel: ${activity.atribuido_nome}</div>` : ''}

                        <!-- Linha 5: Descri√ß√£o -->
                        <div style="color: var(--text-light); font-size: var(--font-size-xs); line-height: 1.4;">
                            ${activity.descricao}
                        </div>
                    </div>

                    <!-- Parte Inferior: Contagens + Bot√µes (sempre alinhados no bottom) -->
                    <div style="margin-top: auto; padding-top: var(--spacing-sm);">
                        <!-- Sistema de Participa√ß√£o Unificado (n√£o aparece para categoria "tarefa") -->
                        ${!isTarefa ? `<div class="participation-summary" style="margin-bottom: var(--spacing-sm);">
                            <div class="participation-row" style="margin-bottom: var(--spacing-xs);">
                                <span class="participation-label" style="font-size: var(--font-size-xs);">Alvo:</span>
                                <span class="participation-count total" style="font-size: var(--font-size-xs);">${activity.total_alvos || 0}</span>
                            </div>
                            <div class="participation-row" style="margin-bottom: var(--spacing-xs);">
                                <span class="participation-label" style="font-size: var(--font-size-xs);">Previs√£o:</span>
                                <div class="participation-values">
                                    <span class="participation-count confirmed" style="font-size: var(--font-size-xs);">${activity.confirmados || 0} confirmados</span>
                                    <span class="participation-count rejected" style="font-size: var(--font-size-xs);">${activity.rejeitados || 0} rejeitados</span>
                                </div>
                            </div>
                            <div class="participation-row">
                                <span class="participation-label" style="font-size: var(--font-size-xs);">Participa√ß√£o:</span>
                                <div class="participation-values">
                                    <span class="participation-count present" style="font-size: var(--font-size-xs);">${activity.participantes || 0} presentes</span>
                                    <span class="participation-count absent" style="font-size: var(--font-size-xs);">${activity.ausentes || 0} ausentes</span>
                                </div>
                            </div>
                        </div>` : ''}

                        <!-- Tags da atividade -->
                        ${activity.tags ? `<div style="margin-bottom: var(--spacing-sm); padding: var(--spacing-sm); background: var(--light); border-radius: var(--radius); border-left: 3px solid var(--primary);">
                            <div style="font-size: var(--font-size-xs); color: var(--text-light); margin-bottom: var(--spacing-xs);">üè∑Ô∏è Tags:</div>
                            <div style="font-size: var(--font-size-xs); color: var(--text); line-height: 1.4;">${activity.tags}</div>
                        </div>` : ''}

                        <!-- Bot√µes de a√ß√£o (Matriz de Permiss√µes) -->
                        <div class="activity-actions" style="display: flex; gap: var(--spacing-xs); justify-content: center; flex-wrap: wrap;">
                            ${showParticipantes
                                ? `<button class="btn btn-primary" onclick="openParticipants('${activity.id}', \`${(activity.titulo || '').replace(/`/g, '')}\`, \`${(activity.descricao || '').replace(/`/g, '')}\`)" style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center;">üë• Participantes</button>`
                                : ''
                            }
                            ${showEditar
                                ? `<button class="btn btn-outline" onclick="editActivity('${activity.id}')" style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center;">‚úèÔ∏è Editar</button>`
                                : ''
                            }
                            ${showCancelar
                                ? `<button class="btn btn-danger" onclick="cancelActivity('${activity.id}')" style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center;">üö´ Cancelar</button>`
                                : ''
                            }
                            ${showConcluir
                                ? `<button class="btn btn-success" onclick="completeActivity('${activity.id}')" style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center;">‚úÖ Concluir</button>`
                                : ''
                            }
                            ${showResumo
                                ? `<button class="btn btn-outline" disabled style="flex: 1; font-size: var(--font-size-sm); padding: var(--spacing-sm); min-height: 36px; display: flex; align-items: center; justify-content: center; opacity: 0.5; cursor: not-allowed;">üìä Resumo</button>`
                                : ''
                            }
                        </div>

                        <!-- Relato (se existir) -->
                        ${activity.relato && activity.relato.trim().length > 0
                            ? `<div style="
                                margin-top: var(--spacing-md);
                                padding: var(--spacing-md);
                                background: ${isCancelada ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)'};
                                border-left: 4px solid ${isCancelada ? 'var(--danger)' : 'var(--success)'};
                                border-radius: var(--radius-md);
                            ">
                                <div style="
                                    font-weight: 600;
                                    color: ${isCancelada ? 'var(--danger)' : 'var(--success)'};
                                    margin-bottom: var(--spacing-xs);
                                    display: flex;
                                    align-items: center;
                                    gap: var(--spacing-xs);
                                    font-size: var(--font-size-sm);
                                ">
                                    <span>${isCancelada ? '‚ùå' : 'üí¨'}</span>
                                    <span>${isCancelada ? 'Motivo do Cancelamento' : 'Relato'}</span>
                                </div>
                                <div style="
                                    color: var(--text);
                                    font-size: var(--font-size-sm);
                                    line-height: 1.6;
                                    white-space: pre-wrap;
                                    word-wrap: break-word;
                                    max-height: 200px;
                                    overflow-y: auto;
                                ">
                                    ${activity.relato}
                                </div>
                            </div>`
                            : ''
                        }
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Renderiza m√∫ltiplas atividades em um grid
     * @param {Array} activities - Array de atividades
     */
    function renderActivities(activities) {
        const grid = document.getElementById('activities-grid');
        if (!grid || !activities) return;

        const html = activities.map(activity => renderActivityCard(activity)).join('');

        grid.innerHTML = html;
    }

    /**
     * Atualiza um card espec√≠fico validando contra filtros ativos
     *
     * IMPORTANTE: Usa validateActivityAgainstFilters() do backend para garantir
     * valida√ß√£o consistente com a listagem (single source of truth)
     *
     * @param {string} activityId - ID da atividade
     * @param {Function} onComplete - Callback ap√≥s completar
     */
    async function updateSingleActivityCard(activityId, onComplete) {
        try {
            console.log('üîÑ Chamando updateSingleActivityCard para:', activityId);

            // ============================================================================
            // 1. VALIDA√á√ïES DE ENTRADA
            // ============================================================================
            if (!activityId) {
                console.warn('‚ö†Ô∏è updateSingleActivityCard: activityId inv√°lido');
                return;
            }

            const sessionId = localStorage.getItem('sessionId');
            if (!sessionId) {
                console.error('‚ùå SessionId n√£o encontrado');
                showToast('Sess√£o expirada. Fa√ßa login novamente.', 'error');
                return;
            }

            // ============================================================================
            // 2. LOCALIZAR CARD NO DOM
            // ============================================================================
            const card = document.querySelector(`[data-activity-id="${activityId}"]`);
            if (!card) {
                console.log('‚ÑπÔ∏è Card n√£o encontrado no DOM para:', activityId);
                return;
            }

            // ============================================================================
            // 3. ADICIONAR ANIMA√á√ÉO DE LOADING (pulse)
            // ============================================================================
            card.classList.add('card-updating');

            // ============================================================================
            // 4. COLETAR FILTROS ATIVOS
            // ============================================================================
            const filtros = {
                status: filtrosState.status || [],
                categorias: filtrosState.categorias || [],
                periodo: filtrosState.periodo || [],
                responsavel: filtrosState.responsavel || []
            };

            console.log('üì° Validando atividade contra filtros:', filtros);

            // ============================================================================
            // 5. VALIDAR NO BACKEND (single source of truth)
            // ============================================================================
            const result = await apiCall('validateActivityAgainstFilters', activityId, filtros);

            // ============================================================================
            // 6. TRATAR ERROS
            // ============================================================================
            if (!result || !result.ok) {
                console.error('‚ùå Erro ao validar atividade:', result?.error);
                showToast('Erro ao atualizar atividade', 'error');
                card.classList.remove('card-updating');
                return;
            }

            console.log('‚úÖ Valida√ß√£o conclu√≠da. Passa no filtro?', result.passaNoFiltro);

            // ============================================================================
            // 7. N√ÉO PASSA NO FILTRO ‚Üí REMOVER COM ANIMA√á√ÉO
            // ============================================================================
            if (!result.passaNoFiltro) {
                card.classList.remove('card-updating');
                removeActivityCardWithAnimation(activityId);
                console.log('üóëÔ∏è Card removido (n√£o passa nos filtros)');
                return;
            }

            // ============================================================================
            // 8. PASSA NO FILTRO ‚Üí ATUALIZAR
            // ============================================================================

            // 8.1. Transformar campos de categoria (backend ‚Üí frontend)
            const activityWithCategory = {
                ...result.activity,
                categoria: result.activity.categoria_atividade_nome || 'Geral',
                categoria_icone: result.activity.categoria_atividade_icone || 'üìã',
                categoria_cor: result.activity.categoria_atividade_cor || '#6b7280',
                categorias: result.activity.categorias || []
            };

            // 8.2. Renderizar novo HTML
            const newHtml = renderActivityCard(activityWithCategory);

            // 8.3. Criar elemento tempor√°rio
            const temp = document.createElement('div');
            temp.innerHTML = newHtml;
            const newCard = temp.firstElementChild;

            // 8.4. Substituir no DOM mantendo posi√ß√£o
            card.parentNode.replaceChild(newCard, card);

            console.log('‚úÖ Card atualizado com sucesso');

            // ============================================================================
            // 9. CALLBACK OPCIONAL
            // ============================================================================
            if (onComplete && typeof onComplete === 'function') {
                onComplete(result.activity);
            }

        } catch (error) {
            console.error('‚ùå Erro em updateSingleActivityCard:', error);
            showToast('Erro ao atualizar atividade', 'error');

            // Remover anima√ß√£o em caso de erro
            const card = document.querySelector(`[data-activity-id="${activityId}"]`);
            if (card) {
                card.classList.remove('card-updating');
            }
        }
    }

    // ============================================================================
    // FUN√á√ÉO REMOVIDA: activityPassesFilters()
    //
    // Motivo: Substitu√≠da por validateActivityAgainstFilters() no backend
    // - Valida√ß√£o agora √© feita no backend (single source of truth)
    // - Elimina duplica√ß√£o de l√≥gica de filtros
    // - Garante consist√™ncia entre listagem e update seletivo
    //
    // Removido em: Restaura√ß√£o do Update Seletivo de Cards
    // Data: 26/10/2025
    // ============================================================================

    // Expor fun√ß√µes globalmente
    window.renderActivityCard = renderActivityCard;
    window.renderActivities = renderActivities;
    window.updateSingleActivityCard = updateSingleActivityCard;
</script>
