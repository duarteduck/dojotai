<!-- ============================================================================ -->
<!-- SELETOR DE MEMBRO - Sistema de troca de perfil vinculado -->
<!-- Permite usu√°rio alternar entre m√∫ltiplos membros vinculados -->
<!-- ============================================================================ -->

<script>
    // ============================================================================
    // ESTADO DO SELETOR DE MEMBROS
    // ============================================================================

    let myLinkedMembers = []; // Lista de membros vinculados ao usu√°rio logado
    let selectedMember = null; // Membro atualmente selecionado
    let memberSelectorInitialized = false;

    /**
     * Inicializa o seletor de membros ap√≥s login bem-sucedido
     * Chamado por auth.html ap√≥s autentica√ß√£o
     */
    async function initMemberSelector() {
        try {
            if (memberSelectorInitialized) {
                console.log('ü•ã MemberSelector j√° inicializado');
                return;
            }

            console.log('ü•ã Inicializando seletor de membros...');

            // Mostrar loading overlay
            if (typeof showMemberLoadingOverlay === 'function') {
                showMemberLoadingOverlay(true);
            }

            const sessionId = localStorage.getItem('sessionId');
            if (!sessionId) {
                console.warn('‚ö†Ô∏è Sem sessionId - n√£o √© poss√≠vel carregar v√≠nculos');
                if (typeof showMemberLoadingOverlay === 'function') {
                    showMemberLoadingOverlay(false);
                }
                return;
            }

            // Buscar v√≠nculos do usu√°rio logado
            // NOTA: apiCall() j√° injeta sessionId automaticamente
            const result = await apiCall('getMyLinkedMembers');

            if (!result.ok) {
                console.error('‚ùå Erro ao buscar v√≠nculos:', result.error);
                showToast('Erro ao carregar perfis vinculados', 'error');
                if (typeof showMemberLoadingOverlay === 'function') {
                    showMemberLoadingOverlay(false);
                }
                return;
            }

            myLinkedMembers = result.items || [];
            console.log(`‚úÖ ${myLinkedMembers.length} v√≠nculo(s) encontrado(s)`);

            // Selecionar membro automaticamente
            selectInitialMember();

            // Configurar visibilidade do bot√£o
            setupMemberSelectorButton();

            // Configurar eventos do modal
            setupMemberSelectorModal();

            memberSelectorInitialized = true;
            console.log('‚úÖ MemberSelector inicializado');

            // Esconder loading overlay
            if (typeof showMemberLoadingOverlay === 'function') {
                showMemberLoadingOverlay(false);
            }

        } catch (error) {
            console.error('‚ùå Erro ao inicializar seletor de membros:', error);

            // Esconder loading overlay em caso de erro
            if (typeof showMemberLoadingOverlay === 'function') {
                showMemberLoadingOverlay(false);
            }
        }
    }

    /**
     * Reseta o seletor de membros no logout
     * Limpa todas as vari√°veis globais e estado
     */
    window.resetMemberSelector = function resetMemberSelector() {
        console.log('üßπ Resetando seletor de membros...');

        // Limpar vari√°veis globais
        myLinkedMembers = [];
        selectedMember = null;
        memberSelectorInitialized = false;

        // Limpar estado (j√° feito por State.clear(), mas garantir)
        State.selectedMember = null;
        State.selectedMemberId = null;

        // Esconder bot√£o do seletor e remover classe de alerta
        const selectorBtn = document.getElementById('member-selector-btn');
        if (selectorBtn) {
            selectorBtn.style.display = 'none';
            selectorBtn.classList.remove('no-members-alert');
        }

        // Fechar dropdown se estiver aberto
        const dropdown = document.getElementById('member-selector-dropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }

        console.log('‚úÖ Seletor de membros resetado');
    }

    /**
     * Seleciona membro inicial ap√≥s login
     * Prioridade: principal='sim' > primeiro da lista
     */
    function selectInitialMember() {
        if (myLinkedMembers.length === 0) {
            console.warn('‚ö†Ô∏è Usu√°rio sem v√≠nculos - nenhum membro selecionado');
            selectedMember = null;
            State.selectedMember = null;
            State.selectedMemberId = null;
            return;
        }

        // Tentar encontrar o principal
        let principal = myLinkedMembers.find(m => m.principal === 'sim');

        // Se n√£o tem principal, pega o primeiro
        if (!principal) {
            principal = myLinkedMembers[0];
        }

        selectedMember = principal;
        State.selectedMember = principal;
        State.selectedMemberId = principal.membro_id;

        console.log('‚úÖ Membro selecionado:', principal.membro_nome);
    }

    /**
     * Configura visibilidade e eventos do bot√£o de troca de perfil
     */
    function setupMemberSelectorButton() {
        const button = document.getElementById('member-selector-btn');

        if (!button) {
            console.warn('‚ö†Ô∏è Bot√£o member-selector-btn n√£o encontrado no DOM');
            return;
        }

        // Sempre mostrar o bot√£o
        button.style.display = 'block';
        button.addEventListener('click', openMemberSelectorModal);

        // Adicionar classe de alerta se n√£o houver v√≠nculos
        if (myLinkedMembers.length === 0) {
            button.classList.add('no-members-alert');
            button.title = '‚ö†Ô∏è Nenhum perfil vinculado';
            console.log('‚ö†Ô∏è Bot√£o em modo alerta (sem v√≠nculos)');
        } else {
            button.classList.remove('no-members-alert');
            button.title = myLinkedMembers.length > 1 ? 'Trocar perfil' : 'Ver perfil vinculado';
            console.log(`‚úÖ Bot√£o de perfil ativado (${myLinkedMembers.length} v√≠nculo(s))`);
        }
    }

    /**
     * Configura eventos do modal de sele√ß√£o
     */
    function setupMemberSelectorModal() {
        const modal = document.getElementById('member-selector-modal');
        const backdrop = modal?.querySelector('.modal-backdrop');
        const closeBtn = modal?.querySelector('.btn-fechar-modal');

        if (backdrop) {
            backdrop.addEventListener('click', closeMemberSelectorModal);
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', closeMemberSelectorModal);
        }

        // Fechar com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('member-selector-modal');
                if (modal && modal.style.display === 'block') {
                    closeMemberSelectorModal();
                }
            }
        });
    }

    /**
     * Abre dropdown de sele√ß√£o de membro
     */
    function openMemberSelectorModal() {
        // Validar sess√£o antes de abrir
        const sessionValid = checkSessionBeforeModal();
        if (!sessionValid) return;

        const dropdown = document.getElementById('member-selector-dropdown');
        const button = document.getElementById('member-selector-btn');

        if (!dropdown) {
            console.error('‚ùå Dropdown member-selector-dropdown n√£o encontrado');
            return;
        }

        if (!button) {
            console.error('‚ùå Bot√£o member-selector-btn n√£o encontrado');
            return;
        }

        // Renderizar lista de membros
        renderMembersList();

        // Posicionar dropdown em rela√ß√£o ao bot√£o
        const buttonRect = button.getBoundingClientRect();
        dropdown.style.top = `${buttonRect.bottom + 8}px`; // 8px de gap
        dropdown.style.right = `${window.innerWidth - buttonRect.right}px`;

        // Toggle dropdown
        dropdown.classList.toggle('show');

        // Fechar ao clicar fora
        if (dropdown.classList.contains('show')) {
            setTimeout(() => {
                document.addEventListener('click', closeOnClickOutside);
            }, 0);
        }
    }

    /**
     * Fecha dropdown de sele√ß√£o
     */
    function closeMemberSelectorModal() {
        const dropdown = document.getElementById('member-selector-dropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
            document.removeEventListener('click', closeOnClickOutside);
        }
    }

    /**
     * Fecha dropdown ao clicar fora
     */
    function closeOnClickOutside(event) {
        const dropdown = document.getElementById('member-selector-dropdown');
        const button = document.getElementById('member-selector-btn');

        if (dropdown && !dropdown.contains(event.target) && !button.contains(event.target)) {
            closeMemberSelectorModal();
        }
    }

    /**
     * Renderiza lista de membros no dropdown
     */
    function renderMembersList() {
        const container = document.getElementById('members-list-container');
        if (!container) return;

        container.innerHTML = '';

        // Se n√£o h√° v√≠nculos, mostrar mensagem de alerta
        if (myLinkedMembers.length === 0) {
            container.innerHTML = `
                <div style="padding: 1.5rem; text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                    <div style="font-weight: 600; color: var(--danger); margin-bottom: 0.5rem;">
                        Nenhum perfil vinculado
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-light);">
                        Entre em contato com o administrador<br>para vincular seu perfil a um membro.
                    </div>
                </div>
            `;
            return;
        }

        console.log('üîç Renderizando membros. Selecionado:', selectedMember);

        myLinkedMembers.forEach(vinculo => {
            const isSelected = selectedMember &&
                              selectedMember.id &&
                              vinculo.id &&
                              String(selectedMember.id) === String(vinculo.id);

            console.log(`  Membro: ${vinculo.membro_nome}, ID: ${vinculo.id}, Selecionado: ${isSelected}`);

            const memberItem = document.createElement('button');
            memberItem.className = 'member-selector-item' + (isSelected ? ' active' : '');
            memberItem.onclick = () => selectMember(vinculo);

            memberItem.innerHTML = `
                <span class="icon">ü•ã</span>
                <div class="member-selector-info">
                    <div class="member-selector-name">${vinculo.membro_nome}</div>
                    <div class="member-selector-meta">${vinculo.categoria_membro || 'Membro'} ‚Ä¢ ${vinculo.tipo_vinculo || ''}</div>
                </div>
                ${isSelected ? '<span class="check">‚úì</span>' : ''}
            `;

            container.appendChild(memberItem);
        });
    }

    /**
     * Seleciona um membro e fecha o modal
     */
    async function selectMember(vinculo) {
        try {
            console.log('ü•ã Selecionando membro:', vinculo.membro_nome);

            // Atualizar estado local (apenas na sess√£o atual)
            selectedMember = vinculo;
            State.selectedMember = vinculo;
            State.selectedMemberId = vinculo.membro_id;

            console.log('‚úÖ Membro selecionado na sess√£o atual:', vinculo.membro_nome);

            // Fechar dropdown
            closeMemberSelectorModal();

            // Feedback visual
            showToast(`Perfil alterado para ${vinculo.membro_nome}`, 'success');

            // Recarregar p√°gina atual para refletir mudan√ßa
            // (Pr√°ticas, por exemplo, precisam do membro correto)
            const currentPage = document.querySelector('.nav-tab.active')?.dataset.page;
            if (currentPage === 'practices') {
                // Recarregar pr√°ticas se estiver na p√°gina
                if (typeof initPractices === 'function') {
                    initPractices();
                }
            }

        } catch (error) {
            console.error('‚ùå Erro ao selecionar membro:', error);
            showToast('Erro ao trocar perfil', 'error');
        }
    }

    /**
     * Retorna o membro atualmente selecionado
     * @returns {Object|null} Objeto do membro selecionado ou null
     */
    function getSelectedMember() {
        return selectedMember;
    }

    /**
     * Retorna o ID do membro atualmente selecionado
     * @returns {number|null} ID do membro ou null
     */
    function getSelectedMemberId() {
        return selectedMember ? selectedMember.membro_id : null;
    }

    // Expor fun√ß√µes globalmente
    window.initMemberSelector = initMemberSelector;
    window.getSelectedMember = getSelectedMember;
    window.getSelectedMemberId = getSelectedMemberId;
</script>

<!-- ============================================================================ -->
<!-- ESTILOS DO SELETOR DE MEMBROS -->
<!-- ============================================================================ -->

<style>
    /* Bot√£o de troca de perfil - usa classe theme-toggle do Design System */
    #member-selector-btn {
        display: none; /* Mostrado apenas se m√∫ltiplos v√≠nculos */
        position: relative;
    }

    /* Estado de alerta quando n√£o h√° v√≠nculos */
    #member-selector-btn.no-members-alert {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        animation: pulse-alert 2s ease-in-out infinite;
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }

    #member-selector-btn.no-members-alert:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
        animation: pulse-alert-fast 1s ease-in-out infinite;
    }

    @keyframes pulse-alert {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
        }
    }

    @keyframes pulse-alert-fast {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.9);
        }
        50% {
            box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
        }
    }

    /* Dropdown de sele√ß√£o de membros (estilo igual ao userMenuDropdown) */
    #member-selector-dropdown {
        position: fixed;
        min-width: 280px;
        background: #ffffff;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        overflow: hidden;
    }

    #member-selector-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    /* Header do Dropdown */
    .member-selector-header {
        padding: var(--spacing-lg);
        background: var(--gradient-primary);
        color: #ffffff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .member-selector-header h4 {
        margin: 0;
        font-size: var(--font-size-lg);
        font-weight: 600;
    }

    /* Lista de Membros */
    .member-selector-items {
        padding: var(--spacing-sm) 0;
        max-height: 400px;
        overflow-y: auto;
        background: #ffffff;
    }

    .member-selector-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md) var(--spacing-lg);
        color: var(--text);
        text-decoration: none;
        transition: var(--transition);
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: var(--font-size-base);
    }

    .member-selector-item:hover {
        background: #f1f5f9;
    }

    .member-selector-item.active {
        background: #dbeafe;
        color: #1e40af;
    }

    .member-selector-item .icon {
        font-size: 1.25rem;
        width: 24px;
        text-align: center;
    }

    .member-selector-item .member-selector-info {
        flex: 1;
    }

    .member-selector-item .member-selector-name {
        font-weight: 600;
        font-size: var(--font-size-base);
        margin-bottom: 2px;
    }

    .member-selector-item .member-selector-meta {
        font-size: var(--font-size-xs);
        color: #64748b;
    }

    .member-selector-item .check {
        font-size: 1.25rem;
        color: #3b82f6;
        font-weight: bold;
    }

    /* Dark mode support */
    [data-theme="dark"] #member-selector-dropdown {
        background: var(--dark);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .member-selector-items {
        background: var(--dark);
    }

    [data-theme="dark"] .member-selector-item:hover {
        background: var(--surface);
    }

    [data-theme="dark"] .member-selector-item.active {
        background: var(--primary);
        color: #ffffff;
    }
</style>

<!-- ============================================================================ -->
<!-- DROPDOWN DE SELE√á√ÉO DE MEMBROS -->
<!-- Renderizado globalmente, posicionado via CSS em rela√ß√£o ao bot√£o -->
<!-- ============================================================================ -->

<script>
    // Criar e adicionar dropdown ao body quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        // Criar dropdown
        const dropdown = document.createElement('div');
        dropdown.id = 'member-selector-dropdown';
        dropdown.innerHTML = `
            <div class="member-selector-header">
                <h4>Selecionar Perfil</h4>
            </div>
            <div class="member-selector-items" id="members-list-container">
                <!-- Membros ser√£o renderizados aqui via JS -->
            </div>
        `;

        // Adicionar ao body
        document.body.appendChild(dropdown);
    });
</script>
