<script>
    // ============================================================================
    // SELECT HELPERS
    // Fun√ß√µes auxiliares para carregar e popular elementos <select>
    // ============================================================================

    /**
     * Popula um elemento select com itens
     * @param {HTMLSelectElement} select - Elemento select
     * @param {Array} items - Array de itens
     * @param {string} valueField - Nome do campo para o value
     * @param {string} textField - Nome do campo para o texto
     * @param {string} placeholder - Texto placeholder (opcional)
     */
    function populateSelect(select, items, valueField, textField, placeholder) {
        select.innerHTML = '';

        // Adicionar placeholder apenas se n√£o for select m√∫ltiplo e placeholder foi fornecido
        if (!select.multiple && placeholder) {
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = placeholder;
            placeholderOption.disabled = true;
            placeholderOption.selected = true;
            select.appendChild(placeholderOption);
        }

        // Adicionar op√ß√µes
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item[valueField];
            option.textContent = item[textField];
            select.appendChild(option);
        });
    }

    /**
     * Carrega categorias de atividades em um select
     * @param {string} selectId - ID do elemento select
     */
    function loadCategories(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;

        // Se cache existe, usar diretamente (instant√¢neo!)
        if (window.cachedCategorias) {
            populateSelect(select, window.cachedCategorias, 'id', 'nome',
                          select.multiple ? null : 'Selecione uma categoria...');
            return;
        }

        // Mostrar loading no select
        select.innerHTML = '<option disabled selected>üîÑ Carregando categorias...</option>';

        // Carregar da API apenas se cache n√£o existe ainda
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            (async () => {
                try {
                    const result = await apiCall('listCategoriasAtividadesApi');

                    if (result && result.ok && result.items) {
                        window.cachedCategorias = result.items; // Salvar no cache
                        populateSelect(select, result.items, 'id', 'nome',
                                     select.multiple ? null : 'Selecione uma categoria...');
                    } else {
                        loadCategoriesFallback(select);
                    }
                } catch (error) {
                    // Erro de sess√£o j√° tratado por apiCall()
                    if (!error.message || !error.message.includes('Sess√£o')) {
                        console.error('Erro ao carregar categorias:', error);
                        loadCategoriesFallback(select);
                    }
                }
            })();
        } else {
            loadCategoriesFallback(select);
        }
    }

    /**
     * Fallback quando falha carregar categorias
     */
    function loadCategoriesFallback(select) {
        console.error('‚ùå Erro ao carregar categorias da API');

        select.innerHTML = select.multiple ?
            '<option disabled>‚ùå Erro ao carregar categorias</option>' :
            '<option disabled selected>‚ùå Erro ao carregar categorias</option>';
    }

    /**
     * Carrega usu√°rios respons√°veis em um select
     * @param {string} selectId - ID do elemento select
     */
    function loadResponsibleUsers(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;

        // Se cache existe, usar diretamente (instant√¢neo!)
        if (window.cachedResponsaveis) {
            populateSelect(select, window.cachedResponsaveis, 'uid', 'nome',
                          'Selecione um respons√°vel...');
            return;
        }

        // Mostrar loading
        select.innerHTML = '<option disabled selected>üîÑ Carregando usu√°rios...</option>';

        // Carregar da API apenas se cache n√£o existe ainda
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            (async () => {
                try {
                    const result = await apiCall('listUsuariosApi');

                    if (result && result.ok && result.items) {
                        window.cachedResponsaveis = result.items; // Salvar no cache
                        populateSelect(select, result.items, 'uid', 'nome',
                                     'Selecione um respons√°vel...');
                    } else {
                        loadResponsibleUsersFallback(select);
                    }
                } catch (error) {
                    // Erro de sess√£o j√° tratado por apiCall()
                    if (!error.message || !error.message.includes('Sess√£o')) {
                        console.error('Erro ao carregar usu√°rios:', error);
                        loadResponsibleUsersFallback(select);
                    }
                }
            })();
        } else {
            loadResponsibleUsersFallback(select);
        }
    }

    /**
     * Fallback quando falha carregar usu√°rios
     */
    function loadResponsibleUsersFallback(select) {
        console.error('‚ùå Erro ao carregar usu√°rios da API');

        select.innerHTML = '<option disabled selected>‚ùå Erro ao carregar usu√°rios</option>';
    }

    /**
     * Carrega dados para o modal de nova atividade
     */
    function loadActivityModalData() {
        loadCategories('activity-category');
        loadResponsibleUsers('activity-responsible');
    }

    /**
     * Carrega dados para o modal de edi√ß√£o de atividade
     */
    function loadEditActivityModalData() {
        loadCategories('edit-activity-category');
        loadResponsibleUsers('edit-activity-responsible');
    }

    /**
     * PRE-CARREGA dados de categorias e respons√°veis no cache ap√≥s login
     * Deve ser chamado uma √∫nica vez ap√≥s login bem-sucedido
     */
    function preLoadCachedData() {
        console.log('üöÄ PRE-CARREGANDO dados no cache...');

        if (typeof google !== 'undefined' && google.script && google.script.run) {
            // Pr√©-carregar categorias
            if (!window.cachedCategorias) {
                (async () => {
                    try {
                        const result = await apiCall('listCategoriasAtividadesApi');
                        if (result && result.ok && result.items) {
                            window.cachedCategorias = result.items;
                            console.log('‚úÖ Categorias pr√©-carregadas no cache:', result.items.length);
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erro ao pr√©-carregar categorias:', error);
                    }
                })();
            }

            // Pr√©-carregar respons√°veis
            if (!window.cachedResponsaveis) {
                (async () => {
                    try {
                        const result = await apiCall('listUsuariosApi');
                        if (result && result.ok && result.items) {
                            window.cachedResponsaveis = result.items;
                            console.log('‚úÖ Respons√°veis pr√©-carregados no cache:', result.items.length);
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erro ao pr√©-carregar respons√°veis:', error);
                    }
                })();
            }
        }
    }

    // Expor fun√ß√µes globalmente
    window.populateSelect = populateSelect;
    window.loadCategories = loadCategories;
    window.loadResponsibleUsers = loadResponsibleUsers;
    window.loadActivityModalData = loadActivityModalData;
    window.loadEditActivityModalData = loadEditActivityModalData;
    window.preLoadCachedData = preLoadCachedData;
</script>
