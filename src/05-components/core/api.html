<script>
    // ============================================================================
    // WRAPPERS DA API
    // Helpers para chamadas ao google.script.run com tratamento de sess√£o
    // ============================================================================

    /**
     * Wrapper para google.script.run com tratamento autom√°tico de sess√£o expirada
     * Injeta automaticamente o sessionId do localStorage como primeiro par√¢metro
     *
     * @param {string} method - Nome do m√©todo backend
     * @param {...any} args - Argumentos para o m√©todo
     * @returns {Promise} Resultado da chamada
     *
     * @example
     * const result = await apiCall('completeActivity', activityId);
     */
    window.apiCall = async function apiCall(method, ...args) {
        return new Promise((resolve, reject) => {
            // Obter sessionId do localStorage
            const sessionId = localStorage.getItem('sessionId');

            // Se n√£o h√° sessionId, n√£o faz a chamada (usu√°rio n√£o logado)
            if (!sessionId) {
                console.warn(`‚ö†Ô∏è API Call bloqueada (sem sess√£o): ${method}`);
                reject(new Error('Usu√°rio n√£o autenticado'));
                return;
            }

            console.log(`üì° API Call: ${method}`, { sessionId: '‚úì', args });

            // Injetar sessionId como primeiro par√¢metro
            const argsWithSession = [sessionId, ...args];

            google.script.run
                .withSuccessHandler((result) => {
                    console.log(`‚úÖ ${method} success:`, result);

                    // Detectar sess√£o expirada via flag
                    if (result && result.sessionExpired) {
                        console.warn(`‚è±Ô∏è Sess√£o expirada detectada em ${method}`);
                        handleSessionExpired();
                        reject(new Error('Sess√£o expirada'));
                        return;
                    }

                    // Verificar mensagem de erro relacionada a sess√£o (fallback)
                    if (result && !result.ok && result.error) {
                        const errorMsg = result.error.toLowerCase();
                        if (errorMsg.includes('sess√£o') &&
                            (errorMsg.includes('expirada') || errorMsg.includes('inv√°lida'))) {
                            console.warn(`‚è±Ô∏è Erro de sess√£o detectado: ${result.error}`);
                            handleSessionExpired();
                            reject(new Error(result.error));
                            return;
                        }
                    }

                    resolve(result);
                })
                .withFailureHandler((error) => {
                    console.error(`‚ùå ${method} failed:`, error);
                    reject(error);
                })
                [method](...argsWithSession);
        });
    }

    /**
     * Valida se h√° sess√£o ativa (apenas localStorage - instant√¢neo)
     * Retorna true se h√° sessionId, false se n√£o h√°
     */
    window.checkSessionBeforeModal = function checkSessionBeforeModal() {
        const sessionId = localStorage.getItem('sessionId');

        // Se n√£o h√° sessionId, sess√£o expirou
        if (!sessionId) {
            console.warn('‚ö†Ô∏è Tentativa de abrir modal sem sess√£o');
            handleSessionExpired();
            return false;
        }

        // Validar sess√£o no backend EM BACKGROUND (n√£o bloqueia abertura do modal)
        validateSessionInBackground();

        return true;
    }

    /**
     * Valida sess√£o no backend em background (n√£o bloqueia UI)
     * Se sess√£o expirou, fecha modal automaticamente e mostra aviso
     */
    async function validateSessionInBackground() {
        const sessionId = localStorage.getItem('sessionId');

        if (!sessionId) return;

        try {
            const result = await apiCall('validateSessionQuick', sessionId);

            if (!result || !result.ok) {
                console.warn('‚ö†Ô∏è Sess√£o inv√°lida detectada em background');

                // Fechar todos os modais abertos
                const activityModal = document.getElementById('activityModal');
                const filtersModal = document.getElementById('modal-filtros');

                if (activityModal && activityModal.style.display !== 'none') {
                    activityModal.style.display = 'none';
                }
                if (filtersModal && filtersModal.style.display !== 'none') {
                    fecharModalFiltros();
                }

                // Mostrar modal de sess√£o expirada
                handleSessionExpired();
            }
        } catch (error) {
            // Erro j√° tratado por apiCall
        }
    }

    /**
     * Verifica se est√° rodando no ambiente Google Apps Script
     */
    function isGoogleScriptEnvironment() {
        return typeof google !== 'undefined' && google.script && google.script.run;
    }

    // Expor fun√ß√µes globalmente
    window.isGoogleScriptEnvironment = isGoogleScriptEnvironment;
    window.validateSessionInBackground = validateSessionInBackground;
</script>
