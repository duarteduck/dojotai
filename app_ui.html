<script>
/* ===========================
   UI helpers + Normalizer
   =========================== */
var Normalizer = {
  activity: function(a){
    if (!a) return a;
    function get(o, keys, def){
      for (var i=0;i<keys.length;i++){ var k=keys[i]; if(o && o[k]!=null) return o[k]; }
      return def;
    }
    return {
      id: get(a, ['id']),
      titulo: get(a, ['titulo','Titulo','T√≠tulo'], ''),
      descricao: get(a, ['descricao','Descri√ß√£o','desc']),
      categoriaAtividadeId:   get(a, ['categoriaAtividadeId','categoria_atividade_id','categorias_ids']) || (get(a, ['categorias_ids']) || '').split(',')[0],
      categoriaAtividadeNome: get(a, ['categoriaAtividadeNome','categoria_atividade_nome']),
      categoriaAtividadeIcone:get(a, ['categoriaAtividadeIcone','categoria_atividade_icone']),
      categoriaAtividadeCor:  get(a, ['categoriaAtividadeCor','categoria_atividade_cor']),
      status: String(get(a, ['status','Status'], 'pendente')).toLowerCase(),
      uid: get(a, ['uid','UID','atribuido_uid','atribuidoUid']),
      usuarioNome: get(a, ['usuarioNome','nomeUsuario','atribuido_nome','atribuidoNome']),
      atualizadoPorNome: get(a, ['atualizadoPorNome','atualizado_nome']),
      atualizadoEm: get(a, ['atualizadoEm','atualizado_em']),
      data: get(a, ['data','Data']),
      total_alvos: get(a, ['total_alvos'], 0),
      confirmados: get(a, ['confirmados'], 0),
      rejeitados: get(a, ['rejeitados'], 0),
      participantes: get(a, ['participantes'], 0),
      ausentes: get(a, ['ausentes'], 0)
    };
  }
};

/* ===== SISTEMA DE SEM√ÅFORO - FUN√á√ïES DE DATA ===== */
var DateSemaforo = {
  getDateAlert: function(dateStr) {
    if (!dateStr) return 'normal';
    try {
      var activityDate = new Date(dateStr);
      if (isNaN(activityDate)) return 'normal';
      var today = new Date(); today.setHours(0,0,0,0);
      var activityDateOnly = new Date(activityDate); activityDateOnly.setHours(0,0,0,0);
      var diffDays = Math.ceil((activityDateOnly - today) / (1000*60*60*24));
      if (diffDays <= 0) return 'overdue';     // hoje ou atrasada
      if (diffDays <= 7) return 'upcoming';    // pr√≥ximos 7 dias
      return 'normal';
    } catch(e){ return 'normal'; }
  },
  formatDateWithAlert: function(dateStr, alertType) {
    if (!dateStr) return '';
    var formattedDate = this.formatDate(dateStr);
    if (alertType === 'overdue') {
      return '<span class="meta-date-alert overdue"><span class="alert-icon">üö®</span>'+formattedDate+'</span>';
    }
    if (alertType === 'upcoming') {
      return '<span class="meta-date-alert upcoming"><span class="alert-icon">‚è∞</span>'+formattedDate+'</span>';
    }
    return '<small class="meta-date">'+formattedDate+'</small>';
  },
  formatDate: function(dateStr) {
    try {
      var d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString('pt-BR');
    } catch(e){ return dateStr; }
  }
};

/* ===========================
   UI base
   =========================== */
var UI = {
  escape: function(s){
    s=(s==null?'':String(s));
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  },
  tpl: function(id){
    var el=document.getElementById(id);
    var wrap=document.createElement('div');
    wrap.innerHTML=el?el.innerHTML:'';
    return wrap.firstElementChild||document.createElement('div');
  },
  toast: function(msg,kind){
    var areaId='toast-area';
    var area=document.getElementById(areaId);
    if(!area){
      area=document.createElement('div');
      area.id=areaId;
      area.style.position='fixed';
      area.style.right='12px';
      area.style.bottom='12px';
      area.style.zIndex='9999';
      document.body.appendChild(area);
    }
    var n=document.createElement('div');
    n.className='toast '+(kind||'');
    n.textContent=msg;
    n.style.background='#111';
    n.style.color='#fff';
    n.style.padding='10px 14px';
    n.style.borderRadius='10px';
    n.style.marginTop='8px';
    n.style.boxShadow='0 6px 20px rgba(0,0,0,.15)';
    area.appendChild(n);
    setTimeout(function(){ n.remove(); },2800);
  },
  renderSkeleton: function(el){
    el.innerHTML='';
    for(var i=0;i<4;i++){
      var d=document.createElement('div');
      d.className='card skel'; d.style.height='76px';
      el.appendChild(d);
    }
  },

  renderAtividades: function(data,filtro,el){
    el.innerHTML='';
    var items=(data||[]).filter(function(a){ return filtro==='todas'?true:(a.status===filtro); });

    // Minhas
    if(window.State&&State.ui&&State.ui.minhas){
      items=items.filter(function(a){ return a.uid===State.uid; });
    }
    // Filtro por nome
    if(window.State&&State.ui&&State.ui.nomeFiltro){
      var q=String(State.ui.nomeFiltro||'').toLowerCase();
      items=items.filter(function(a){ return String(a.usuarioNome||'').toLowerCase().indexOf(q)>=0; });
    }
    // Filtro por categoria
    if(window.State&&State.ui&&State.ui.categoriaAtividadeFiltro&&State.ui.categoriaAtividadeFiltro!=='todas'){
      items=items.filter(function(a){ return (a.categoriaAtividadeId||'')===State.ui.categoriaAtividadeFiltro; });
    }
    // Filtro por datas selecionadas no calend√°rio
    if(window.State&&State.ui&&State.ui.dateFilter&&State.ui.dateFilter.length>0){
      items=items.filter(function(a){
        if(!a.data) return false;
        var activityDate=null;
        if(/^\d{4}-\d{2}-\d{2}$/.test(a.data)){ activityDate=a.data; }
        else if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(a.data)){
          var parts=a.data.split('/');
          var day=parts[0].padStart(2,'0');
          var month=parts[1].padStart(2,'0');
          var year=parts[2];
          activityDate=year+'-'+month+'-'+day;
        } else {
          try{
            var dateObj=new Date(a.data);
            if(!isNaN(dateObj.getTime())){
              var year=dateObj.getFullYear();
              var month=(dateObj.getMonth()+1).toString().padStart(2,'0');
              var day=dateObj.getDate().toString().padStart(2,'0');
              activityDate=year+'-'+month+'-'+day;
            }
          }catch(e){}
        }
        return activityDate && State.ui.dateFilter.indexOf(activityDate)>=0;
      });
    }

    if(items.length===0){ el.appendChild(this.tpl('tpl-empty')); return; }

    function block(html,key,show){
      var re=new RegExp('{{#'+key+'}}([\\s\\S]*?){{\\/'+key+'}}','g');
      return html.replace(re, show ? '$1' : '');
    }
    function formatarDataBrasileira(dataStr){
      if(!dataStr) return '';
      try{
        var d=new Date(dataStr);
        if(isNaN(d)) return dataStr;
        return d.toLocaleDateString('pt-BR')+' √†s '+d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      }catch(e){ return dataStr; }
    }

    for(var i=0;i<items.length;i++){
      var a=items[i];
      var tpl=document.getElementById('tpl-activity-card');
      var html=tpl.innerHTML;

      // data + alerta (somente pendente)
      var dateAlert='normal', formattedDateWithAlert='';
      if(a.status==='pendente'){
        dateAlert=DateSemaforo.getDateAlert(a.data);
        formattedDateWithAlert=DateSemaforo.formatDateWithAlert(a.data,dateAlert);
      } else {
        formattedDateWithAlert=a.data?'<small class="meta-date">'+DateSemaforo.formatDate(a.data)+'</small>':'';
      }

      var hasUltimaAcao=!!(a.atualizadoPorNome&&a.atualizadoEm);
      var atualizadoEmFormatado=hasUltimaAcao?formatarDataBrasileira(a.atualizadoEm):'';
      var hasCategoriaAtividade=!!(a.categoriaAtividadeIcone&&a.categoriaAtividadeNome);

      html=html
        .replace(/{{id}}/g,UI.escape(a.id))
        .replace(/{{titulo}}/g,UI.escape(a.titulo||a.descricao||''))
        .replace(/{{descricao}}/g,UI.escape(a.descricao||''))
        .replace(/{{categoriaAtividadeId}}/g,UI.escape(a.categoriaAtividadeId||''))
        .replace(/{{categoriaAtividadeNome}}/g,UI.escape(a.categoriaAtividadeNome||''))
        .replace(/{{categoriaAtividadeIcone}}/g,a.categoriaAtividadeIcone||'')
        .replace(/{{categoriaAtividadeCor}}/g,UI.escape(a.categoriaAtividadeCor||'#6B7280'))
        .replace(/{{data}}/g,formattedDateWithAlert)
        .replace(/{{usuarioNome}}/g,UI.escape(a.usuarioNome||a.uid||'‚Äî'))
        .replace(/{{atualizadoPorNome}}/g,UI.escape(a.atualizadoPorNome||''))
        .replace(/{{atualizadoEm}}/g,atualizadoEmFormatado)
        .replace(/{{statusLabel}}/g,(a.status==='pendente'?'Pendente':(a.status==='concluida'?'Conclu√≠da':a.status)))
        .replace(/{{statusClass}}/g,a.status)
        .replace(/{{total_alvos}}/g,a.total_alvos||0)
        .replace(/{{confirmados}}/g,a.confirmados||0)
        .replace(/{{rejeitados}}/g,a.rejeitados||0)
        .replace(/{{participantes}}/g,a.participantes||0)
        .replace(/{{ausentes}}/g,a.ausentes||0);

      html=block(html,'hasDesc',!!a.descricao);
      html=block(html,'hasCategoriaAtividade',hasCategoriaAtividade);
      html=block(html,'hasUltimaAcao',hasUltimaAcao);
      html=block(html,'isPendente',a.status==='pendente');
      html=block(html,'isConcluida',a.status==='concluida');
      html=block(html,'data',!!a.data);

      var wrap=document.createElement('div'); wrap.innerHTML=html;
      var card=wrap.firstElementChild;

      // classes de alerta (pendente)
      if(a.status==='pendente'){
        if(dateAlert==='overdue') card.classList.add('alert-overdue');
        else if(dateAlert==='upcoming') card.classList.add('alert-upcoming');
      }

      // concluir
      var btnConcluir=card.querySelector('.btn-concluir');
      if(btnConcluir){
        (function(atividade,botao){
          botao.addEventListener('click',function(){
            botao.disabled=true; botao.classList.add('is-loading');
            API.concluir(atividade.id).then(function(res){
              var item=null; if(!State.cache) State.cache={atividades:[]};
              for(var k=0;k<State.cache.atividades.length;k++){
                if(State.cache.atividades[k].id===atividade.id){ item=State.cache.atividades[k]; break; }
              }
              if(item){
                item.status=(res&&res.status)?res.status:'concluida';
                if(res&&res.atualizadoPorNome) item.atualizadoPorNome=res.atualizadoPorNome;
                if(res&&res.atualizadoEm) item.atualizadoEm=res.atualizadoEm;
              }
              UI.toast('Atividade conclu√≠da!');
              var cur=(document.querySelector('#chips .chip.is-active[data-status]')||{}).dataset;
              var st=cur&&cur.status?cur.status:'todas';
              UI.renderAtividades(State.cache.atividades,st,el);
            }).catch(function(err){
              console.error('[concluir] erro',err);
              UI.toast('Falha ao concluir','err');
              botao.disabled=false; botao.classList.remove('is-loading');
            });
          });
        })(a,btnConcluir);
      }

      // participantes
      var btnParticipantes = card.querySelector('.btn-participantes');
      if (btnParticipantes) {
        (function(atividade, botao) {
          botao.addEventListener('click', function() {
            openParticipacaoModal(atividade.id);
          });
        })(a, btnParticipantes);
      }

      el.appendChild(card);
    }
  }
};

/* ===========================
   Views
   =========================== */
var Views = {
  initLogin: function(){
    var btn=document.getElementById('btn-login');
    var inpLogin=document.getElementById('inp-login');
    var inpPin=document.getElementById('inp-pin');
    var msg=document.getElementById('login-msg');

    function setLoading(v){
      if(!btn) return;
      btn.disabled=!!v;
      if(btn.classList) btn.classList.toggle('is-loading',!!v);
      if(msg) msg.textContent=v?'Autenticando...':'';
    }
    function doLogin(){
      var login=(inpLogin&&inpLogin.value?inpLogin.value:'').trim();
      var pin=(inpPin&&inpPin.value?inpPin.value:'').trim();
      if(!login||!pin){ if(msg) msg.textContent='Informe login e PIN.'; return; }
      setLoading(true);
      API.login(login,pin).then(function(res){
        var uidFromRes=(res&&res.user&&res.user.uid)?res.user.uid:null;
        var hasOk=!!(res&&res.ok);
        var uid=uidFromRes||(window.State&&State.uid)||null;
        if(hasOk&&uid){
          try{ if(uidFromRes) State.uid=uidFromRes; }catch(e){}
          Router.go('#/dash');
        } else {
          if(msg) msg.textContent=(res&&res.error)||'Falha ao autenticar.';
        }
        setLoading(false);
      }).catch(function(err){
        console.error('[login] hard error',err);
        if(msg) msg.textContent='Erro ao autenticar.';
        setLoading(false);
      });
    }
    if(btn) btn.onclick=doLogin;
    function onKey(ev){
      ev=ev||window.event;
      var key=ev.key||ev.keyCode;
      if(key==='Enter'||key===13){
        if(ev.preventDefault) ev.preventDefault();
        doLogin();
      }
    }
    if(inpLogin) inpLogin.addEventListener('keydown',onKey);
    if(inpPin)   inpPin.addEventListener('keydown',onKey);
  },

  initDash: function(){
    // Bootstrap do State
    if(!window.State){
      window.State={
        uid:(function(){ try{return localStorage.getItem('uid');}catch(e){return null;} })(),
        clear:function(){ try{localStorage.removeItem('uid');}catch(e){} },
        cache:{ atividades:[], categoriasAtividades:[] },
        ui:{ minhas:false, nomeFiltro:'', categoriaAtividadeFiltro:'todas' }
      };
    } else {
      if(!State.cache) State.cache={ atividades:[], categoriasAtividades:[] };
      if(!State.ui) State.ui={ minhas:false, nomeFiltro:'', categoriaAtividadeFiltro:'todas' };
    }
    if(!State.ui.dateFilter) State.ui.dateFilter=[];
    if(!State.ui.categoriaAtividadeFiltro) State.ui.categoriaAtividadeFiltro='todas';

    var $=function(s){ return document.querySelector(s); };
    var listEl=$('#list');

    // Delega√ß√£o para bot√£o Alterar
    if(listEl && !listEl.__altDelegation){
      listEl.addEventListener('click', function(ev){
        var btn = ev.target && ev.target.closest && ev.target.closest('.btn-alt');
        if (!btn) return;
        var card = btn.closest('.activity');
        var id = card && card.getAttribute('data-id');
        if (!id) return;
        if (window.Router && Router.go){
          Router.go('#/edit?id=' + encodeURIComponent(id));
        } else {
          location.hash = '#/edit?id=' + encodeURIComponent(id);
        }
      });
      listEl.__altDelegation = true;
    }
    if(!listEl) return;

    // Reset de filtros da UI
    State.ui.minhas=true;  // Minhas tarefas como padr√£o
    State.ui.nomeFiltro='';
    State.ui.categoriaAtividadeFiltro='todas';

    // Bot√µes principais
    var btnLogout=document.getElementById('btn-logout');
    var btnNew   =document.getElementById('btn-new');
    if(btnLogout) btnLogout.addEventListener('click', function(){ State.clear(); Router.go('#/login'); });
    if(btnNew)    btnNew.addEventListener('click', function(){ Router.go('#/new'); });

    // Menu overlay
    var btnMenu=document.getElementById('btn-menu');
    if(btnMenu){
      btnMenu.addEventListener('click', function(){
        if(UI.MenuSystem && !UI.MenuSystem.overlay){ UI.MenuSystem.init(); }
        if(UI.MenuSystem && UI.MenuSystem.open){ UI.MenuSystem.open(); }
      });
    }

    // Chips de status / minhas
    var chips=document.getElementById('chips');
    var chipMinhas=document.getElementById('chip-minhas');
    var inpFiltro =document.getElementById('filtro-usuario');

    if(inpFiltro){
      inpFiltro.addEventListener('input', function(){
        State.ui.nomeFiltro = this.value;
        var act = document.querySelector('#chips .chip.is-active[data-status]');
        var cur = (act && act.getAttribute('data-status')) || 'todas';
        UI.renderAtividades(State.cache.atividades, cur, listEl);
        
        // Atualiza contadores das categorias
        if (typeof window.atualizarContadoresCategorias === 'function') {
          window.atualizarContadoresCategorias();
        }
      });
    }

    if(chips){
      chips.addEventListener('click', function(ev){
        var el = ev.target.closest('.chip');
        if(!el) return;

        if(el.hasAttribute('data-status')){
          var statusChips = document.querySelectorAll('#chips .chip[data-status]');
          for (var i=0;i<statusChips.length;i++){ statusChips[i].classList.remove('is-active'); }
          el.classList.add('is-active');
          var status = el.getAttribute('data-status');
          UI.renderAtividades(State.cache.atividades, status, listEl);
          
          // LINHA ADICIONADA: Atualiza contadores das categorias
          if (typeof window.atualizarContadoresCategorias === 'function') {
            window.atualizarContadoresCategorias();
          }
          
          return;
        }

        if(el.id==='chip-minhas'){
          State.ui.minhas=!State.ui.minhas;
          if(State.ui.minhas){
            State.ui.nomeFiltro='';
            if(inpFiltro) inpFiltro.value='';
          }
          el.classList.toggle('is-active', State.ui.minhas);
          var act=document.querySelector('#chips .chip.is-active[data-status]');
          var cur=(act && act.getAttribute('data-status')) || 'todas';
          UI.renderAtividades(State.cache.atividades, cur, listEl);
          
          // LINHA ADICIONADA: Atualiza contadores das categorias
          if (typeof window.atualizarContadoresCategorias === 'function') {
            window.atualizarContadoresCategorias();
          }
          
          return;
        }
      });
    }

    // Toggle calend√°rio (c√≥digo original restaurado)
    var chipCalendar=document.getElementById('chip-calendar');
    if(chipCalendar){
      chipCalendar.addEventListener('click', function(){
        var wrap=document.getElementById('calendar-wrapper');
        if(!wrap) return;
        var isVisible = wrap.style.display !== 'none';

        if(!isVisible) {
          // Mostrar calend√°rio
          wrap.style.display = 'block';
          chipCalendar.classList.add('is-active');

          // Usar fun√ß√£o responsiva
          var calContainer = document.querySelector('#calendar');
          if(calContainer && !window.State.calendar) {
            window.State.calendar = window.initResponsiveCalendar('#calendar', {
              activities: State.cache.atividades || [],
              onSelectionChange: function(dates){
                State.ui.dateFilter = dates;
                var act=document.querySelector('#chips .chip.is-active[data-status]');
                var cur=(act && act.getAttribute('data-status')) || 'todas';
                UI.renderAtividades(State.cache.atividades, cur, listEl);

                if (typeof window.atualizarContadoresCategorias === 'function') {
                  window.atualizarContadoresCategorias();
                }
              }
            });
          }
          // Atualizar atividades se o calend√°rio j√° existe
          else if(window.State.calendar && window.State.calendar.setActivities) {
            window.State.calendar.setActivities(State.cache.atividades || []);
            // Re-aplica ajustes mobile
            if (window.State.calendar.adjustForMobile) {
              window.State.calendar.adjustForMobile();
            }
          }
        } else {
          // Ocultar calend√°rio
          wrap.style.display = 'none';
          chipCalendar.classList.remove('is-active');
        }
      });
    }
    // filtro din√¢mico por categoria (UI)
    function renderCategoriaAtividadeFilters(categorias){
      var container=document.getElementById('categoria-atividade-filter-container');
      if(!container || !categorias || categorias.length===0) return;

      var catFilter=document.createElement('div');
      catFilter.className='categoria-atividade-filter';

      // Fun√ß√£o para contar atividades por categoria
      function contarAtividadesPorCategoria(categoriaId) {
        if (!State.cache || !State.cache.atividades) return 0;
        
        // Aplica os mesmos filtros que est√£o ativos na UI
        var items = State.cache.atividades.slice();
        
        // Filtro de status atual
        var statusAtivo = 'todas';
        var chipStatusAtivo = document.querySelector('#chips .chip.is-active[data-status]');
        if (chipStatusAtivo) {
          statusAtivo = chipStatusAtivo.getAttribute('data-status');
        }
        
        if (statusAtivo !== 'todas') {
          items = items.filter(function(a) { 
            return a.status === statusAtivo; 
          });
        }
        
        // Filtro "Minhas tarefas"
        if (State.ui && State.ui.minhas) {
          items = items.filter(function(a) { 
            return a.uid === State.uid; 
          });
        }
        
        // Filtro por nome de usu√°rio
        if (State.ui && State.ui.nomeFiltro) {
          var q = String(State.ui.nomeFiltro || '').toLowerCase();
          items = items.filter(function(a) { 
            return String(a.usuarioNome || '').toLowerCase().indexOf(q) >= 0; 
          });
        }
        
        // Filtro por datas selecionadas no calend√°rio
        if (State.ui && State.ui.dateFilter && State.ui.dateFilter.length > 0) {
          items = items.filter(function(a) {
            if (!a.data) return false;
            var activityDate = null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(a.data)) { 
              activityDate = a.data; 
            } else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(a.data)) {
              var parts = a.data.split('/');
              var day = parts[0].padStart(2, '0');
              var month = parts[1].padStart(2, '0');
              var year = parts[2];
              activityDate = year + '-' + month + '-' + day;
            } else {
              try {
                var dateObj = new Date(a.data);
                if (!isNaN(dateObj.getTime())) {
                  var year = dateObj.getFullYear();
                  var month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                  var day = dateObj.getDate().toString().padStart(2, '0');
                  activityDate = year + '-' + month + '-' + day;
                }
              } catch(e) {}
            }
            return activityDate && State.ui.dateFilter.indexOf(activityDate) >= 0;
          });
        }
        
        // Agora filtra por categoria
        if (categoriaId === 'todas') {
          return items.length;
        } else {
          return items.filter(function(a) {
            return (a.categoriaAtividadeId || '') === categoriaId;
          }).length;
        }
      }

      // Bot√£o "Todas" com contador
      var todasCount = contarAtividadesPorCategoria('todas');
      var allBtn = document.createElement('div');
      allBtn.className = 'categoria-atividade-filter-item is-active';
      allBtn.setAttribute('data-categoria-atividade', 'todas');
      allBtn.innerHTML = '<span style="margin-right:6px;">üóÇÔ∏è</span>Todas <span class="filter-count">(' + todasCount + ')</span>';
      catFilter.appendChild(allBtn);

      // Bot√µes das categorias com contadores
      categorias.forEach(function(cat) {
        var count = contarAtividadesPorCategoria(cat.id);
        var btn = document.createElement('div');
        btn.className = 'categoria-atividade-filter-item';
        btn.setAttribute('data-categoria-atividade', cat.id);
        btn.innerHTML = '<span style="color:' + (cat.cor || '#6B7280') + ';margin-right:6px;">' + 
                        (cat.icone || '‚Ä¢') + '</span>' + UI.escape(cat.nome || '') + 
                        ' <span class="filter-count">(' + count + ')</span>';
        catFilter.appendChild(btn);
      });

      container.innerHTML = '';
      container.appendChild(catFilter);

      catFilter.addEventListener('click', function(ev) {
        var item = ev.target.closest('.categoria-atividade-filter-item');
        if (!item) return;

        catFilter.querySelectorAll('.categoria-atividade-filter-item').forEach(function(el) { 
          el.classList.remove('is-active'); 
        });
        item.classList.add('is-active');

        State.ui.categoriaAtividadeFiltro = item.getAttribute('data-categoria-atividade') || 'todas';

        var act = document.querySelector('#chips .chip.is-active[data-status]');
        var cur = (act && act.getAttribute('data-status')) || 'todas';
        UI.renderAtividades(State.cache.atividades, cur, document.getElementById('list'));
        
        // Atualiza os contadores ap√≥s aplicar o filtro
        if (typeof window.atualizarContadoresCategorias === 'function') {
          window.atualizarContadoresCategorias();
        }
      });
    }

    // Carga inicial
    UI.renderSkeleton(listEl);
    Promise.all([
      API.listMinhasAtividades(),
      API.listarCategoriasAtividades()
    ]).then(function(results){
      var atividades=results[0]||[];
      var categorias=results[1]||[];

      State.cache.atividades = atividades.map(Normalizer.activity);
      State.cache.categoriasAtividades = categorias||[];

      // status default = pendente
      var chipsStatus=document.querySelectorAll('#chips .chip[data-status]');
      for (var i=0;i<chipsStatus.length;i++){ chipsStatus[i].classList.remove('is-active'); }
      var chip=document.querySelector('#chips .chip[data-status="pendente"]');
      if(chip) chip.classList.add('is-active');

      // minhas tarefas default = ativo
      var chipMinhas=document.getElementById('chip-minhas');
      if(chipMinhas) chipMinhas.classList.add('is-active');

      renderCategoriaAtividadeFilters(State.cache.categoriasAtividades);

      UI.renderAtividades(State.cache.atividades, 'pendente', listEl);

    }).catch(function(e){
      console.error('[dash] erro ao carregar dados',e);
      UI.toast('Falha ao carregar dados','err');
      listEl.innerHTML='';
    });
  },

  initNew: function(){
    var sel        = document.getElementById('na-atr');
    var selCatAtiv = document.getElementById('na-categoria-atividade');
    var btnSave    = document.getElementById('na-save');
    var btnCancel  = document.getElementById('na-cancel');
    var msg        = document.getElementById('na-msg');

    function __parseHashParams(){
      try{
        var q=(location.hash.split('?')[1]||'');
        var out={};
        q.split('&').forEach(function(kv){
          var p=kv.split('=');
          if(p[0]) out[decodeURIComponent(p[0])]=decodeURIComponent(p[1]||'');
        });
        return out;
      }catch(e){ return {}; }
    }
    var __params=__parseHashParams();
    var __isEdit = location.hash.indexOf('#/edit')===0;
    var __editId = __isEdit ? (__params.id||'') : '';

    var __item=null;

    function __hydrate(it){
      if(!it) return;
      var t = document.getElementById('na-titulo');
      var d = document.getElementById('na-desc');
      var dt= document.getElementById('na-data');

      if(t) t.value = it.titulo || '';
      if(d) d.value = it.descricao || '';

      if (selCatAtiv && it.categoriaAtividadeId){
        setTimeout(function(){ selCatAtiv.value = it.categoriaAtividadeId || ''; }, 100);
      }

      // converter data p/ yyyy-mm-dd
      if (dt && it.data){
        var dataValue = it.data;
        if (typeof dataValue==='string' && /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(dataValue)){
          var parts=dataValue.split('/');
          var day=parts[0].padStart(2,'0');
          var month=parts[1].padStart(2,'0');
          var year=parts[2];
          if(year.length===2) year='20'+year;
          dataValue = year+'-'+month+'-'+day;
        } else if (dataValue instanceof Date || (typeof dataValue==='string' && dataValue.includes('T'))){
          var dateObj = dataValue instanceof Date ? dataValue : new Date(dataValue);
          if(!isNaN(dateObj.getTime())){
            var y=dateObj.getFullYear();
            var m=(dateObj.getMonth()+1).toString().padStart(2,'0');
            var da=dateObj.getDate().toString().padStart(2,'0');
            dataValue = y+'-'+m+'-'+da;
          }
        } else if (typeof dataValue==='string' && /^\d{4}-\d{2}-\d{2}$/.test(dataValue)){
          // ok
        } else if (typeof dataValue==='string' && dataValue.trim()){
          try{
            var dateObj=new Date(dataValue);
            if(!isNaN(dateObj.getTime())){
              var y=dateObj.getFullYear();
              var m=(dateObj.getMonth()+1).toString().padStart(2,'0');
              var da=dateObj.getDate().toString().padStart(2,'0');
              dataValue = y+'-'+m+'-'+da;
            }
          }catch(e){ dataValue=''; }
        }
        dt.value = dataValue || '';
      }
    }

    // modo edi√ß√£o: ajusta t√≠tulos e carrega item
    if(__isEdit){
      var h2 = document.querySelector('[data-view="new"] h2');
      var btnSaveEl = btnSave;
      if(h2) h2.textContent='Alterar atividade';
      if(btnSaveEl) btnSaveEl.textContent='Alterar';

      // tenta pegar do cache
      try{
        if(window.State && State.cache && Array.isArray(State.cache.atividades)){
          for(var i=0;i<State.cache.atividades.length;i++){
            var it = State.cache.atividades[i];
            if(String(it.id)===String(__editId)){ __item=it; break; }
          }
        }
      }catch(e){}

      if(__item) __hydrate(__item);
      else {
        try{
          API.getAtividadePorId(__editId).then(function(it){
            __item = Normalizer.activity(it);
            __hydrate(__item);
            try{
              var _sel = document.getElementById('na-atr');
              if(_sel && __item){
                setTimeout(function(){
                  _sel.value = (__item.atribuido_uid || __item.uid || _sel.value || '');
                }, 100);
              }
            }catch(e){}
          }).catch(function(e){
            console.warn('[edit] n√£o foi poss√≠vel obter item:', e);
            UI.toast('Erro ao carregar dados da atividade','err');
          });
        }catch(e){}
      }
    } else {
      var h2n = document.querySelector('[data-view="new"] h2');
      if(h2n) h2n.textContent='Nova atividade';
      if(btnSave) btnSave.textContent='Salvar';
    }

    // categorias
    if(selCatAtiv){
      selCatAtiv.innerHTML = '<option value="">Carregando...</option>';
      API.listarCategoriasAtividades().then(function(categorias){
        selCatAtiv.innerHTML = '<option value="">(Sem categoria)</option>';
        (categorias||[]).forEach(function(cat){
          var opt=document.createElement('option');
          opt.value = cat.id;
          opt.textContent = (cat.icone ? cat.icone+' ' : '') + cat.nome;
          selCatAtiv.appendChild(opt);
        });
        if (__isEdit && __item && __item.categoriaAtividadeId){
          selCatAtiv.value = __item.categoriaAtividadeId;
        }
      }).catch(function(e){
        console.error('[new] categories error', e);
        selCatAtiv.innerHTML = '<option value="">(Erro ao carregar)</option>';
      });
    }

    // usu√°rios
    if(sel){
      sel.innerHTML='<option value="">(carregando...)</option>';
      API.listarUsuariosAtivos().then(function(users){
        sel.innerHTML='';
        for (var i=0;i<users.length;i++){
          var u=users[i];
          var opt=document.createElement('option');
          opt.value=u.uid; opt.textContent=u.nome||u.login||u.uid;
          if(u.uid===State.uid) opt.selected=true;
          sel.appendChild(opt);
        }
        // pr√©-seleciona em edi√ß√£o
        try{
          if(__isEdit){
            var __it=null;
            if(window.State && State.cache && Array.isArray(State.cache.atividades)){
              for(var k=0;k<State.cache.atividades.length;k++){
                if(String(State.cache.atividades[k].id)===String(__editId)){ __it=State.cache.atividades[k]; break; }
              }
            }
            if(__it) sel.value = (__it.atribuido_uid || __it.uid || sel.value || '');
          }
        }catch(e){}
      }).catch(function(e){
        console.error('[new] users error',e);
        sel.innerHTML='<option>(falha)</option>';
      });
    }

    if(btnCancel) btnCancel.onclick=function(){ Router.go('#/dash'); };

    if(btnSave) btnSave.onclick=function(){
      var payload={
        titulo:(document.getElementById('na-titulo') && document.getElementById('na-titulo').value || '').trim(),
        descricao:(document.getElementById('na-desc') && document.getElementById('na-desc').value || '').trim(),
        data:(document.getElementById('na-data') && document.getElementById('na-data').value) || '',
        atribuido_uid:(sel && sel.value) || (window.State && State.uid),
        // Categoria nos dois formatos (ajuste conforme sua API)
        categoriaAtividadeId:(selCatAtiv && selCatAtiv.value) || '',
        categoria_atividade_id:(selCatAtiv && selCatAtiv.value) || '',
        categorias_ids:(selCatAtiv && selCatAtiv.value) || '',  // Compatibilidade novo sistema
        tags:''  // Tags vazias por enquanto
      };
      if(!payload.titulo){ if(msg) msg.textContent='Informe um t√≠tulo.'; return; }

      btnSave.disabled=true; btnSave.classList.add('is-loading'); if(msg) msg.textContent='';

      var promise = (__isEdit ? API.atualizar(__editId, payload) : API.criar(payload));
      promise.then(function(res){
        if(res && res.ok){
          UI.toast(__isEdit ? 'Atividade alterada!' : 'Atividade criada!');
          if (window.Router && Router.go) Router.go('#/dash'); else location.hash = '#/dash';
        } else {
          if (msg) msg.textContent = (res && res.error) || (__isEdit ? 'Falha ao alterar.' : 'Falha ao criar.');
          btnSave.disabled=false; btnSave.classList.remove('is-loading');
        }
      }).catch(function(e){
        console.error(__isEdit ? '[edit] update error' : '[new] create error', e);
        if (msg) msg.textContent = __isEdit ? 'Erro ao alterar atividade.' : 'Erro ao criar atividade.';
        btnSave.disabled=false; btnSave.classList.remove('is-loading');
      });
    };
  },

  /* ===========================
     SISTEMA DE MEMBROS - UI
     =========================== */
  initMembers: function() {
    console.log('üéØ Views.initMembers executado!');
    
    // Inicializa State se necess√°rio
    if (!window.State) {
      window.State = { 
        uid: (function() { try { return localStorage.getItem('uid'); } catch(e) { return null; } })(),
        cache: { atividades: [], membros: [] }, 
        ui: { membros: { filtros: {}, busca: '' } } 
      };
    }
    
    if (!State.cache) State.cache = { atividades: [], membros: [] };
    if (!State.ui.membros) State.ui.membros = {
      filtros: {
        status: [],
        dojos: [],
        grupos: [],
        categoria_membro: [],
        buntai: [],
        cargo: [],
        sexo: [],
        grau: [],
        usuario: []
      },
      busca: ''
    };

    var listEl = document.getElementById('members-list');
    var searchEl = document.getElementById('members-search');
    var summaryEl = document.getElementById('members-summary');
    var btnMenu = document.getElementById('btn-members-menu');
    var btnStats = document.getElementById('btn-members-stats');
    var btnLink = document.getElementById('btn-members-link');
    var btnNew = document.getElementById('btn-members-new');
    var btnFilters = document.getElementById('btn-members-filters');
    var modal = document.getElementById('members-filters-modal');
    var activeFiltersEl = document.getElementById('members-active-filters');
    var filterTagsEl = document.getElementById('members-filter-tags');

    console.log('üîç Elementos encontrados:', {
      listEl: !!listEl,
      searchEl: !!searchEl,
      btnFilters: !!btnFilters,
      btnMenu: !!btnMenu,
      btnNew: !!btnNew
    });

    if (!listEl) {
      console.error('‚ùå Elemento #members-list n√£o encontrado!');
      return;
    }

    // Bot√£o menu
    if (btnMenu) {
      btnMenu.addEventListener('click', function() {
        console.log('üîÑ Abrindo menu na tela de membros');
        if(UI.MenuSystem && !UI.MenuSystem.overlay){ UI.MenuSystem.init(); }
        if(UI.MenuSystem && UI.MenuSystem.open){ UI.MenuSystem.open(); }
      });
    }

    // Bot√£o novo membro (funcionalidade futura)
    if (btnNew) {
      btnNew.addEventListener('click', function() {
        console.log('‚ûï Bot√£o Novo Membro clicado');
        UI.toast('Funcionalidade de novo membro em desenvolvimento');
      });
    }

    // Busca em tempo real
    if (searchEl) {
      searchEl.addEventListener('input', function() {
        State.ui.membros.busca = this.value.toLowerCase();
        renderMembersList();
      });
    }

    // Nova l√≥gica de filtros
    setupMembersFilters();

    // Delega√ß√£o de eventos para a√ß√µes dos cards
    if (listEl) {
      listEl.addEventListener('click', function(ev) {
        var btn = ev.target.closest('button');
        if (!btn) return;

        var memberId = btn.getAttribute('data-member-id');
        if (!memberId) return;

        if (btn.classList.contains('btn-view')) {
          console.log('üëÅÔ∏è Visualizar membro:', memberId);
          Router.go('#/member?id=' + encodeURIComponent(memberId));
          return;
        }

        if (btn.classList.contains('btn-link')) {
          console.log('üîó Vincular membro:', memberId);
          UI.toast('Funcionalidade de vincula√ß√£o em desenvolvimento');
          return;
        }

        if (btn.classList.contains('btn-unlink')) {
          var userUid = btn.getAttribute('data-user-uid');
          console.log('üîó‚ùå Desvincular membro:', memberId, 'usu√°rio:', userUid);
          if (confirm('Tem certeza que deseja desvincular este membro?')) {
            UI.toast('Desvincula√ß√£o em desenvolvimento');
          }
          return;
        }

        if (btn.classList.contains('btn-edit')) {
          console.log('‚úèÔ∏è Editar membro:', memberId);
          UI.toast('Edi√ß√£o de membros em desenvolvimento');
          return;
        }
      });
    }

    // Carregamento inicial
    loadMembers();

    function loadMembers() {
      console.log('üì° Carregando membros...');
      
      if (listEl) renderMembersSkeleton(listEl);
      if (summaryEl) updateSummary({ total: '-', ativos: '-', vinculados: '-', naoVinculados: '-' });

      API.listMembers().then(function(members) {
        console.log('‚úÖ Membros carregados:', members.length);
        State.cache.membros = members || [];
        createDynamicFilters();
        renderMembersList();
        updateSummary();
      }).catch(function(err) {
        console.error('‚ùå Erro ao carregar membros:', err);
        UI.toast('Falha ao carregar membros', 'err');
        if (listEl) {
          listEl.innerHTML = '<div class="members-empty"><div class="members-empty-icon">üòî</div><div class="members-empty-text">Erro ao carregar membros</div></div>';
        }
      });
    }

    function setupMembersFilters() {
      // Event listeners para filtros principais
      setupMainFilters();

      // Event listeners para modal
      setupModalFilters();

      // Event listeners para busca
      if (searchEl) {
        searchEl.addEventListener('input', function() {
          State.ui.membros.busca = searchEl.value.toLowerCase().trim();
          renderMembersList();
        });
      }
    }

    function setupMainFilters() {
      var mainFiltersEl = document.getElementById('members-main-filters');
      if (!mainFiltersEl) return;

      mainFiltersEl.addEventListener('click', function(ev) {
        var chip = ev.target.closest('.chip');
        if (!chip) return;

        var filterType = null;
        var filterValue = null;

        if (chip.hasAttribute('data-status')) {
          filterType = 'status';
          filterValue = chip.getAttribute('data-status');
        } else if (chip.hasAttribute('data-dojo')) {
          filterType = 'dojos';
          filterValue = chip.getAttribute('data-dojo');
        }

        if (filterType && filterValue) {
          toggleMainFilter(filterType, filterValue, chip);
        }
      });
    }

    function setupModalFilters() {
      // Abrir modal
      if (btnFilters) {
        btnFilters.addEventListener('click', function() {
          openFiltersModal();
        });
      }

      // Fechar modal
      var closeBtn = document.getElementById('members-filters-modal-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeFiltersModal);
      }

      // Clicar fora do modal
      if (modal) {
        modal.addEventListener('click', function(ev) {
          if (ev.target === modal) closeFiltersModal();
        });
      }

      // Event listeners dos chips no modal
      if (modal) {
        modal.addEventListener('click', function(ev) {
          var chip = ev.target.closest('.chip');
          if (!chip) return;

          var filterType = chip.getAttribute('data-filter');
          var filterValue = chip.getAttribute('data-value');

          if (filterType && filterValue) {
            toggleModalFilter(filterType, filterValue, chip);
          }
        });
      }

      // Bot√µes do modal
      var btnClear = document.getElementById('btn-clear-modal-filters');
      var btnApply = document.getElementById('btn-apply-modal-filters');

      if (btnClear) {
        btnClear.addEventListener('click', clearAllModalFilters);
      }

      if (btnApply) {
        btnApply.addEventListener('click', function() {
          closeFiltersModal();
          renderMembersList();
          updateActiveFilters();
        });
      }

      // Limpar todos os filtros
      var btnClearAll = document.getElementById('btn-clear-members-filters');
      if (btnClearAll) {
        btnClearAll.addEventListener('click', clearAllFilters);
      }
    }

    function createDynamicFilters() {
      var members = State.cache.membros || [];

      createMainFilters(members);
      createModalFilters(members);
    }

    function createMainFilters(members) {
      var statusContainer = document.getElementById('members-status-container');
      var dojosContainer = document.getElementById('members-dojos-container');

      if (!statusContainer || !dojosContainer) return;

      // Extrair valores √∫nicos
      var status = [];
      var dojos = [];

      members.forEach(function(m) {
        if (m.status && status.indexOf(m.status) === -1) status.push(m.status);
        if (m.dojo && dojos.indexOf(m.dojo) === -1) dojos.push(m.dojo);
      });

      // Ordenar alfabeticamente
      status.sort();
      dojos.sort();

      // Criar chips de status
      statusContainer.innerHTML = '';
      status.forEach(function(st) {
        var chip = document.createElement('div');
        chip.className = 'chip';
        chip.setAttribute('data-status', st);
        chip.textContent = st.charAt(0).toUpperCase() + st.slice(1);
        statusContainer.appendChild(chip);
      });

      // Criar chips de dojos
      dojosContainer.innerHTML = '';
      dojos.forEach(function(dojo) {
        var chip = document.createElement('div');
        chip.className = 'chip';
        chip.setAttribute('data-dojo', dojo);
        chip.textContent = dojo;
        dojosContainer.appendChild(chip);
      });
    }

    function createModalFilters(members) {
      // Extrair todos os valores √∫nicos
      var grupos = [];
      var categoria_membro = [];
      var buntai = [];
      var cargo = [];
      var grau = [];

      members.forEach(function(m) {
        if (m.categoria_grupo && grupos.indexOf(m.categoria_grupo) === -1) grupos.push(m.categoria_grupo);
        if (m.categoria_membro && categoria_membro.indexOf(m.categoria_membro) === -1) categoria_membro.push(m.categoria_membro);
        if (m.buntai && buntai.indexOf(m.buntai) === -1) buntai.push(m.buntai);
        if (m.cargo && cargo.indexOf(m.cargo) === -1) cargo.push(m.cargo);
        if (m.grau_omitama && grau.indexOf(m.grau_omitama) === -1) grau.push(m.grau_omitama);
      });

      // Ordenar tudo
      grupos.sort();
      categoria_membro.sort();
      buntai.sort();
      cargo.sort();
      grau.sort();

      // Criar chips nos containers do modal
      createModalChips('modal-grupos-container', grupos, 'grupos');
      createModalChips('modal-categoria-membro-container', categoria_membro, 'categoria_membro');
      createModalChips('modal-buntai-container', buntai, 'buntai');
      createModalChips('modal-cargo-container', cargo, 'cargo');
      createModalChips('modal-grau-container', grau, 'grau');
    }

    function createModalChips(containerId, values, filterType) {
      var container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = '';
      values.forEach(function(value) {
        var chip = document.createElement('div');
        chip.className = 'chip';
        chip.setAttribute('data-filter', filterType);
        chip.setAttribute('data-value', value);
        chip.textContent = value;
        container.appendChild(chip);
      });
    }

    function renderMembersList() {
      console.log('üé® Renderizando lista de membros...');
      
      var members = State.cache.membros || [];
      var filtros = State.ui.membros.filtros;
      var busca = State.ui.membros.busca;

      // Aplicar filtros
      var filtered = members.filter(function(m) {
        // Aplicar todos os filtros
        if (filtros.status && filtros.status.length > 0) {
          if (filtros.status.indexOf(m.status) === -1) return false;
        }

        if (filtros.dojos && filtros.dojos.length > 0) {
          if (filtros.dojos.indexOf(m.dojo) === -1) return false;
        }

        if (filtros.grupos && filtros.grupos.length > 0) {
          if (filtros.grupos.indexOf(m.categoria_grupo) === -1) return false;
        }

        if (filtros.categoria_membro && filtros.categoria_membro.length > 0) {
          if (filtros.categoria_membro.indexOf(m.categoria_membro) === -1) return false;
        }

        if (filtros.buntai && filtros.buntai.length > 0) {
          if (filtros.buntai.indexOf(m.buntai) === -1) return false;
        }

        if (filtros.cargo && filtros.cargo.length > 0) {
          if (filtros.cargo.indexOf(m.cargo) === -1) return false;
        }

        if (filtros.sexo && filtros.sexo.length > 0) {
          var memberSexo = normalizeSexo(m.sexo);
          var hasValidSexo = false;
          for (var i = 0; i < filtros.sexo.length; i++) {
            if (filtros.sexo[i] === memberSexo) {
              hasValidSexo = true;
              break;
            }
          }
          if (!hasValidSexo) return false;
        }

        if (filtros.grau && filtros.grau.length > 0) {
          if (filtros.grau.indexOf(m.grau_omitama) === -1) return false;
        }

        if (filtros.usuario && filtros.usuario.length > 0) {
          var hasUser = !!m.usuario_uid;
          var hasValidUser = false;
          for (var i = 0; i < filtros.usuario.length; i++) {
            if ((filtros.usuario[i] === 'vinculado' && hasUser) ||
                (filtros.usuario[i] === 'nao-vinculado' && !hasUser)) {
              hasValidUser = true;
              break;
            }
          }
          if (!hasValidUser) return false;
        }

        // Busca por nome
        if (busca) {
          if (m.nome.toLowerCase().indexOf(busca) === -1) return false;
        }

        return true;
      });

      console.log('üìä Membros filtrados:', filtered.length, 'de', members.length);

      if (filtered.length === 0) {
        listEl.innerHTML = '<div class="members-empty"><div class="members-empty-icon">üîç</div><div class="members-empty-text">Nenhum membro encontrado com esses filtros</div></div>';
        return;
      }

      // Renderizar cards
      listEl.innerHTML = '';
      filtered.forEach(function(member) {
        var card = createMemberCard(member);
        listEl.appendChild(card);
      });
    }

    function createMemberCard(member) {
      var template = document.getElementById('tpl-member-card');
      if (!template) {
        console.error('‚ùå Template tpl-member-card n√£o encontrado');
        return document.createElement('div');
      }

      var html = template.innerHTML;
      
      // Dados b√°sicos
      var avatarText = member.nome.split(' ').map(function(n) { return n[0]; }).join('').substr(0, 2).toUpperCase();
      var statusClass = member.status.toLowerCase();
      var statusLabel = member.status;

      // Dados condicionais
      var hasGrau = !!(member.grau_omitama && member.grau_omitama.trim());
      var hasCargo = !!(member.cargo && member.cargo.trim());
      var hasGrupo = !!(member.categoria_grupo && member.categoria_grupo.trim());
      var hasSexo = !!(member.sexo && member.sexo.trim());
      var hasIdade = !!(member.idade && member.idade > 0);
      var hasBuntai = !!(member.buntai && member.buntai.trim());
      var hasPersonalInfo = hasSexo || hasIdade || hasBuntai;

      // Status de vincula√ß√£o
      var isLinked = !!(member.usuario_uid && member.usuario_uid.trim());
      var isUnlinked = !isLinked;
      var usuario_nome = isLinked ? (getUserNameByUid(member.usuario_uid) || member.usuario_uid) : '';

      // Sexo formatado
      var sexoLabel = '';
      if (hasSexo) {
        sexoLabel = member.sexo.toUpperCase() === 'M' ? 'Masculino' : 
                    member.sexo.toUpperCase() === 'F' ? 'Feminino' : member.sexo;
      }

      // Substitui√ß√µes
      var replacements = {
        'id': UI.escape(member.id || ''),
        'nome': UI.escape(member.nome || ''),
        'avatarText': avatarText,
        'grau_omitama': UI.escape(member.grau_omitama || ''),
        'cargo': UI.escape(member.cargo || ''),
        'dojo': UI.escape(member.dojo || ''),
        'categoria_grupo': UI.escape(member.categoria_grupo || ''),
        'status': UI.escape(member.status || ''),
        'statusClass': statusClass,
        'statusLabel': statusLabel,
        'sexoLabel': sexoLabel,
        'idade': member.idade || 0,
        'buntai': UI.escape(member.buntai || ''),
        'usuario_uid': UI.escape(member.usuario_uid || ''),
        'usuario_nome': UI.escape(usuario_nome)
      };

      // Replace all placeholders
      Object.keys(replacements).forEach(function(key) {
        var regex = new RegExp('{{' + key + '}}', 'g');
        html = html.replace(regex, replacements[key]);
      });

      // Conditional blocks
      html = toggleBlock(html, 'hasGrau', hasGrau);
      html = toggleBlock(html, 'hasCargo', hasCargo);
      html = toggleBlock(html, 'hasGrupo', hasGrupo);
      html = toggleBlock(html, 'hasSexo', hasSexo);
      html = toggleBlock(html, 'hasIdade', hasIdade);
      html = toggleBlock(html, 'hasBuntai', hasBuntai);
      html = toggleBlock(html, 'hasPersonalInfo', hasPersonalInfo);
      html = toggleBlock(html, 'isLinked', isLinked);
      html = toggleBlock(html, 'isUnlinked', isUnlinked);
      html = toggleBlock(html, 'canEdit', true); // Por enquanto todos podem editar

      var wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      return wrapper.firstElementChild;
    }

    function toggleBlock(html, blockName, show) {
      var regex = new RegExp('{{#' + blockName + '}}([\\s\\S]*?){{\\/' + blockName + '}}', 'g');
      return html.replace(regex, show ? '$1' : '');
    }

    function getUserNameByUid(uid) {
      // TODO: Implementar cache de usu√°rios
      // Por enquanto retorna o pr√≥prio UID
      return uid;
    }

    function updateSummary(custom) {
      if (!summaryEl) return;

      var stats = custom || calculateStats();
      
      var totalEl = document.getElementById('total-members');
      var activeEl = document.getElementById('active-members');
      var linkedEl = document.getElementById('linked-members');
      var unlinkedEl = document.getElementById('unlinked-members');

      if (totalEl) totalEl.textContent = stats.total;
      if (activeEl) activeEl.textContent = stats.ativos;
      if (linkedEl) linkedEl.textContent = stats.vinculados;
      if (unlinkedEl) unlinkedEl.textContent = stats.naoVinculados;
    }

    function calculateStats() {
      var members = State.cache.membros || [];
      
      var total = members.length;
      var ativos = members.filter(function(m) { return m.status.toLowerCase() === 'ativo'; }).length;
      var vinculados = members.filter(function(m) { return m.usuario_uid && m.usuario_uid.trim(); }).length;
      var naoVinculados = total - vinculados;

      return { total: total, ativos: ativos, vinculados: vinculados, naoVinculados: naoVinculados };
    }

    function renderMembersSkeleton(el) {
      el.innerHTML = '';
      el.className = 'members-loading';
      
      for (var i = 0; i < 6; i++) {
        var skeleton = document.createElement('div');
        skeleton.className = 'member-skeleton';
        el.appendChild(skeleton);
      }
      
      setTimeout(function() {
        if (el) el.className = 'row';
      }, 100);
    }

    // Fun√ß√µes auxiliares para filtros
    function toggleMainFilter(filterType, filterValue, chip) {
      var isActive = chip.classList.contains('is-active');
      var filters = State.ui.membros.filtros[filterType];

      if (isActive) {
        // Remover
        chip.classList.remove('is-active');
        var index = filters.indexOf(filterValue);
        if (index > -1) filters.splice(index, 1);
      } else {
        // Adicionar
        chip.classList.add('is-active');
        if (filters.indexOf(filterValue) === -1) {
          filters.push(filterValue);
        }
      }

      renderMembersList();
      updateActiveFilters();
    }

    function toggleModalFilter(filterType, filterValue, chip) {
      var isActive = chip.classList.contains('is-active');
      var filters = State.ui.membros.filtros[filterType];

      if (isActive) {
        chip.classList.remove('is-active');
        var index = filters.indexOf(filterValue);
        if (index > -1) filters.splice(index, 1);
      } else {
        chip.classList.add('is-active');
        if (filters.indexOf(filterValue) === -1) {
          filters.push(filterValue);
        }
      }
    }

    function openFiltersModal() {
      if (!modal) return;

      // Sincronizar estado dos chips com filtros ativos
      syncModalFilters();
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeFiltersModal() {
      if (!modal) return;

      modal.style.display = 'none';
      document.body.style.overflow = '';
    }

    function syncModalFilters() {
      if (!modal) return;

      // Limpar todos os estados ativos
      var chips = modal.querySelectorAll('.chip');
      chips.forEach(function(chip) {
        chip.classList.remove('is-active');
      });

      // Aplicar estados ativos baseados nos filtros
      var filtros = State.ui.membros.filtros;
      Object.keys(filtros).forEach(function(filterType) {
        if (filtros[filterType] && filtros[filterType].length > 0) {
          filtros[filterType].forEach(function(value) {
            var chip = modal.querySelector('.chip[data-filter="' + filterType + '"][data-value="' + value + '"]');
            if (chip) {
              chip.classList.add('is-active');
            }
          });
        }
      });
    }

    function clearAllModalFilters() {
      // Limpar chips do modal
      var chips = modal.querySelectorAll('.chip.is-active');
      chips.forEach(function(chip) {
        chip.classList.remove('is-active');
      });

      // Limpar filtros avan√ßados (manter principais)
      State.ui.membros.filtros.grupos = [];
      State.ui.membros.filtros.categoria_membro = [];
      State.ui.membros.filtros.buntai = [];
      State.ui.membros.filtros.cargo = [];
      State.ui.membros.filtros.sexo = [];
      State.ui.membros.filtros.grau = [];
      State.ui.membros.filtros.usuario = [];
    }

    function clearAllFilters() {
      // Limpar estado
      Object.keys(State.ui.membros.filtros).forEach(function(key) {
        State.ui.membros.filtros[key] = [];
      });

      // Limpar chips principais
      var mainChips = document.querySelectorAll('#members-main-filters .chip.is-active');
      mainChips.forEach(function(chip) {
        chip.classList.remove('is-active');
      });

      // Limpar modal
      if (modal) {
        var modalChips = modal.querySelectorAll('.chip.is-active');
        modalChips.forEach(function(chip) {
          chip.classList.remove('is-active');
        });
      }

      renderMembersList();
      updateActiveFilters();
    }

    function updateActiveFilters() {
      if (!activeFiltersEl || !filterTagsEl) return;

      var filtros = State.ui.membros.filtros;
      var tags = [];

      // Coletar todas as tags ativas
      Object.keys(filtros).forEach(function(filterType) {
        if (filtros[filterType] && filtros[filterType].length > 0) {
          filtros[filterType].forEach(function(value) {
            tags.push({
              type: filterType,
              value: value,
              label: getFilterLabel(filterType, value)
            });
          });
        }
      });

      if (tags.length > 0) {
        activeFiltersEl.style.display = 'block';
        renderFilterTags(tags);
      } else {
        activeFiltersEl.style.display = 'none';
      }
    }

    function getFilterLabel(filterType, value) {
      var labels = {
        'status': 'Status: ' + value,
        'dojos': 'Dojo: ' + value,
        'grupos': 'Grupo: ' + value,
        'categoria_membro': 'Categoria: ' + value,
        'buntai': 'Buntai: ' + value,
        'cargo': 'Cargo: ' + value,
        'sexo': 'Sexo: ' + (value === 'masculino' ? 'Masculino' : 'Feminino'),
        'grau': 'Grau: ' + value,
        'usuario': 'Usu√°rio: ' + (value === 'vinculado' ? 'Com usu√°rio' : 'Sem usu√°rio')
      };
      return labels[filterType] || value;
    }

    function renderFilterTags(tags) {
      if (!filterTagsEl) return;

      var html = tags.map(function(tag) {
        return '<div class="filter-tag">' +
          '<span>' + tag.label + '</span>' +
          '<button class="filter-tag-remove" data-filter-type="' + tag.type + '" data-filter-value="' + tag.value + '">&times;</button>' +
        '</div>';
      }).join('');

      filterTagsEl.innerHTML = html;

      // Event listeners para remover tags
      filterTagsEl.addEventListener('click', function(ev) {
        var removeBtn = ev.target.closest('.filter-tag-remove');
        if (!removeBtn) return;

        var filterType = removeBtn.getAttribute('data-filter-type');
        var filterValue = removeBtn.getAttribute('data-filter-value');

        removeFilter(filterType, filterValue);
      });
    }

    function removeFilter(filterType, filterValue) {
      var filters = State.ui.membros.filtros[filterType];
      if (filters) {
        var index = filters.indexOf(filterValue);
        if (index > -1) {
          filters.splice(index, 1);
        }
      }

      // Atualizar chips visuais
      updateFilterChips(filterType, filterValue, false);

      renderMembersList();
      updateActiveFilters();
    }

    function updateFilterChips(filterType, filterValue, isActive) {
      // Atualizar chip principal
      var mainChip = document.querySelector('#members-main-filters .chip[data-' + filterType.replace('s', '') + '="' + filterValue + '"]');
      if (mainChip) {
        if (isActive) {
          mainChip.classList.add('is-active');
        } else {
          mainChip.classList.remove('is-active');
        }
      }

      // Atualizar chip do modal
      var modalChip = modal.querySelector('.chip[data-filter="' + filterType + '"][data-value="' + filterValue + '"]');
      if (modalChip) {
        if (isActive) {
          modalChip.classList.add('is-active');
        } else {
          modalChip.classList.remove('is-active');
        }
      }
    }

    function normalizeSexo(sexo) {
      if (!sexo) return '';
      var sexoStr = String(sexo).toLowerCase();
      if (sexoStr === 'm' || sexoStr === 'masc' || sexoStr === 'masculino') return 'masculino';
      if (sexoStr === 'f' || sexoStr === 'fem' || sexoStr === 'feminino') return 'feminino';
      return '';
    }
  },

  /* ===========================
     SISTEMA DE MEMBRO INDIVIDUAL
     =========================== */
  initMember: function() {
    console.log('üéØ Views.initMember executado!');

    // Extrai o ID do membro da URL
    var urlParams = this.getUrlParams();
    var memberId = urlParams.id;

    if (!memberId) {
      console.error('‚ùå ID do membro n√£o fornecido');
      UI.toast('ID do membro n√£o fornecido', 'err');
      Router.go('#/members');
      return;
    }

    console.log('üîç Carregando membro ID:', memberId);

    // Elementos da view
    var loadingEl = document.getElementById('member-detail-loading');
    var errorEl = document.getElementById('member-detail-error');
    var btnBack = document.getElementById('btn-member-back');
    var btnEdit = document.getElementById('btn-member-edit');
    var btnRetry = document.getElementById('btn-member-retry');

    // Event listeners
    if (btnBack) {
      btnBack.addEventListener('click', function() {
        Router.go('#/members');
      });
    }

    if (btnRetry) {
      btnRetry.addEventListener('click', function() {
        loadMemberData();
      });
    }

    // Carrega dados do membro
    loadMemberData();

    function loadMemberData() {
      console.log('üì° Carregando dados do membro...');

      if (loadingEl) loadingEl.style.display = 'block';
      if (errorEl) errorEl.style.display = 'none';

      // Busca membro na API
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('‚úÖ Dados do membro recebidos:', result);

          if (loadingEl) loadingEl.style.display = 'none';

          if (result && result.ok && result.item) {
            renderMemberData(result.item);
          } else {
            showError('Membro n√£o encontrado');
          }
        })
        .withFailureHandler(function(err) {
          console.error('‚ùå Erro ao carregar membro:', err);
          if (loadingEl) loadingEl.style.display = 'none';
          showError('Erro ao carregar dados do membro');
        })
        .getMemberById(memberId);
    }

    function renderMemberData(member) {
      console.log('üé® Renderizando dados do membro:', member);

      // Nome e c√≥digo
      setElementText('member-detail-name', member.nome || 'Nome n√£o informado');
      setElementText('member-detail-code', '#' + (member.id || '-'));

      // Status
      var statusChip = document.getElementById('member-detail-status-chip');
      if (statusChip) {
        statusChip.textContent = getStatusLabel(member.status);
        statusChip.className = 'chip ' + getStatusClass(member.status);
      }

      // Informa√ß√µes pessoais
      setElementText('member-nome-completo', member.nome_completo || member.nome || '-');
      setOptionalField('member-sexo', member.sexo, getSexoLabel);
      setOptionalField('member-idade', member.idade);
      setOptionalField('member-data-nascimento', member.data_nascimento, formatDate);

      // Organiza√ß√£o
      setElementText('member-dojo', member.dojo || '-');
      setOptionalField('member-categoria-grupo', member.categoria_grupo);
      setOptionalField('member-categoria-membro', member.categoria_membro);
      setOptionalField('member-buntai', member.buntai);
      setOptionalField('member-cargo', member.cargo);

      // Gradua√ß√£o
      var hasGraduacao = member.grau_omitama || member.numero_seminario_basico;
      if (hasGraduacao) {
        showSection('member-graduacao-section');
        setElementText('member-grau-omitama', member.grau_omitama || '-');
        setOptionalField('member-seminario-basico', member.numero_seminario_basico);
      }

      // Contato
      var hasContato = member.telefone || member.email || member.endereco;
      if (hasContato) {
        showSection('member-contato-section');
        setOptionalField('member-telefone', member.telefone);
        setOptionalField('member-email', member.email);
        setOptionalField('member-endereco', member.endereco);
      }

      // Usu√°rio vinculado
      if (member.usuario_uid) {
        showElement('member-linked-detail');
        hideElement('member-unlinked-detail');
        setElementText('member-usuario-nome', member.usuario_nome || 'Usu√°rio vinculado');
      } else {
        hideElement('member-linked-detail');
        showElement('member-unlinked-detail');
      }

      // Metadados
      var hasMetadata = member.criado_em || member.atualizado_em;
      if (hasMetadata) {
        showSection('member-metadata-section');
        setOptionalField('member-criado-em', member.criado_em, formatDateTime);
        setOptionalField('member-atualizado-em', member.atualizado_em, formatDateTime);
      }
    }

    function setElementText(id, text) {
      var el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function setOptionalField(id, value, formatter) {
      var container = document.getElementById(id + '-container');
      var element = document.getElementById(id);

      if (value) {
        if (container) container.style.display = 'block';
        if (element) {
          element.textContent = formatter ? formatter(value) : value;
        }
      } else {
        if (container) container.style.display = 'none';
      }
    }

    function showSection(id) {
      var el = document.getElementById(id);
      if (el) el.style.display = 'block';
    }

    function showElement(id) {
      var el = document.getElementById(id);
      if (el) el.style.display = 'block';
    }

    function hideElement(id) {
      var el = document.getElementById(id);
      if (el) el.style.display = 'none';
    }

    function showError(message) {
      if (errorEl) {
        errorEl.style.display = 'block';
        var errorTextEl = errorEl.querySelector('.error-text');
        if (errorTextEl) errorTextEl.textContent = message;
      }
    }

    function getStatusLabel(status) {
      var statusStr = String(status || '').toLowerCase();
      if (statusStr === 'ativo') return 'Ativo';
      if (statusStr === 'inativo') return 'Inativo';
      return 'Indefinido';
    }

    function getStatusClass(status) {
      var statusStr = String(status || '').toLowerCase();
      if (statusStr === 'ativo') return 'ativo';
      if (statusStr === 'inativo') return 'inativo';
      return '';
    }

    function getSexoLabel(sexo) {
      if (!sexo) return '';
      var sexoStr = String(sexo).toLowerCase();
      if (sexoStr === 'm' || sexoStr === 'masc' || sexoStr === 'masculino') return 'Masculino';
      if (sexoStr === 'f' || sexoStr === 'fem' || sexoStr === 'feminino') return 'Feminino';
      return sexo;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        var date = new Date(dateStr);
        return date.toLocaleDateString('pt-BR');
      } catch (e) {
        return dateStr;
      }
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      try {
        var date = new Date(dateStr);
        return date.toLocaleString('pt-BR');
      } catch (e) {
        return dateStr;
      }
    }
  },

  // Fun√ß√£o auxiliar para extrair par√¢metros da URL
  getUrlParams: function() {
    var params = {};
    var hash = location.hash || '';
    var queryIndex = hash.indexOf('?');

    if (queryIndex === -1) return params;

    var query = hash.substring(queryIndex + 1);
    var pairs = query.split('&');

    for (var i = 0; i < pairs.length; i++) {
      var pair = pairs[i].split('=');
      if (pair.length === 2) {
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
      }
    }

    return params;
  }
};

/* ===========================
   Sistema de Menu (overlay)
   =========================== */
var MenuSystem = {
  overlay: null,
  content: null,
  isOpen: false,
  items: [],

  init: function(){
    if (this.overlay) return;
    this.createMenuHTML();
    this.setupEventListeners();
  },
  createMenuHTML: function(){
    if (document.getElementById('menu-overlay')) return;
    var menuHTML = [
      '<div class="menu-overlay" id="menu-overlay">',
        '<div class="menu-panel">',
          '<div class="menu-header">',
            '<h3 class="menu-title">Menu</h3>',
            '<button class="menu-close" id="menu-close">&times;</button>',
          '</div>',
          '<div class="menu-content" id="menu-content">',
            '<div class="menu-loading">Carregando...</div>',
          '</div>',
        '</div>',
      '</div>'
    ].join('');
    document.body.insertAdjacentHTML('beforeend', menuHTML);
    this.overlay = document.getElementById('menu-overlay');
    this.content = document.getElementById('menu-content');
  },
  setupEventListeners: function(){
    var self=this;
    var closeBtn=document.getElementById('menu-close');
    if(closeBtn){ closeBtn.addEventListener('click', function(){ self.close(); }); }
    if(this.overlay){
      this.overlay.addEventListener('click', function(e){
        if(e.target===self.overlay) self.close();
      });
    }
    document.addEventListener('keydown', function(e){
      if(e.key==='Escape' && self.isOpen) self.close();
    });
  },
  open: function(){
    if(this.isOpen) return;
    this.isOpen=true;
    if(this.overlay) this.overlay.classList.add('is-open');
    document.body.style.overflow='hidden';
    if(this.items.length===0){ this.loadMenuItems(); }
  },
  close: function(){
    if(!this.isOpen) return;
    this.isOpen=false;
    if(this.overlay) this.overlay.classList.remove('is-open');
    document.body.style.overflow='';
  },
  loadMenuItems: function(){
    var self=this;
    if(!this.content) return;
    if(typeof API==='undefined' || !API.listMenu){
      console.warn('[Menu] API n√£o dispon√≠vel, usando itens padr√£o');
      self.renderItems(self.getDefaultMenuItems());
      return;
    }
    this.content.innerHTML='<div class="menu-loading">Carregando...</div>';
    API.listMenu().then(function(items){
      // Se n√£o h√° itens da planilha, usa itens padr√£o
      if(!items || items.length === 0) {
        console.warn('[Menu] Nenhum item na planilha, usando itens padr√£o');
        items = self.getDefaultMenuItems();
      }
      self.renderItems(items);
    }).catch(function(err){
      console.error('[Menu] erro:',err);
      console.warn('[Menu] Erro ao carregar, usando itens padr√£o');
      self.renderItems(self.getDefaultMenuItems());
    });
  },
  getDefaultMenuItems: function(){
    return [
      { titulo: 'üìã Atividades', icone: 'üìã', acao: 'route', destino: '#/dash', ordem: 1 },
      { titulo: 'üë• Membros', icone: 'üë•', acao: 'route', destino: '#/members', ordem: 2 },
      { titulo: '‚ûï Nova Atividade', icone: '‚ûï', acao: 'route', destino: '#/new', ordem: 3 }
    ];
  },
  renderItems: function(items){
    var self=this;
    if(!this.content) return;
    if(!items||items.length===0){ this.content.innerHTML='<div class="menu-error">Nenhum item dispon√≠vel</div>'; return; }
    var html=[];
    for(var i=0;i<items.length;i++){
      var item=items[i];
      html.push(
        '<button class="menu-item" data-action="'+UI.escape(item.acao)+'" data-destino="'+UI.escape(item.destino)+'">'+
          '<span class="menu-item-icon">'+UI.escape(item.icone||'‚ñ´Ô∏è')+'</span>'+
          '<span class="menu-item-text">'+UI.escape(item.titulo||'')+'</span>'+
        '</button>'
      );
    }
    this.content.innerHTML=html.join('');
    var menuItems=this.content.querySelectorAll('.menu-item');
    for(var j=0;j<menuItems.length;j++){
      (function(button){
        button.addEventListener('click', function(e){
          var action=e.currentTarget.getAttribute('data-action');
          var destino=e.currentTarget.getAttribute('data-destino');
          self.handleItemClick(action,destino);
        });
      })(menuItems[j]);
    }
    this.items=items;
  },
  handleItemClick: function(action,destino){
    switch(action){
      case 'route':
        if(window.Router && Router.go){ Router.go(destino); } else { location.hash=destino; }
        break;
      case 'function':
        if(typeof window[destino]==='function'){ window[destino](); }
        else { console.error('Fun√ß√£o n√£o encontrada:', destino); UI.toast('Fun√ß√£o n√£o dispon√≠vel: '+destino,'err'); }
        break;
      case 'external':
        window.open(destino,'_blank');
        break;
      default:
        console.warn('A√ß√£o desconhecida:',action);
    }
    this.close();
  }
};
UI.MenuSystem = MenuSystem;

/* ===========================
   Calend√°rio de atividades
   =========================== */
class ActivityCalendar {
  constructor(containerSelector, options = {}) {
    this.container = document.querySelector(containerSelector);
    this.currentDate = new Date();
    this.selectedDates = new Set();
    this.activities = options.activities || [];
    this.onSelectionChange = options.onSelectionChange || (() => {});
    this.monthNames = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    if(this.container){ this.init(); }
  }
  init() {
    this.renderCalendarStructure();
    this.setupEventListeners();
    this.render();
    this.selectDefaultDates();
    
    // NOVO: Ajusta para mobile ap√≥s renderiza√ß√£o
    setTimeout(() => {
      this.adjustForMobile();
    }, 100);
    
    // NOVO: Monitora redimensionamento
    window.addEventListener('resize', () => {
      setTimeout(() => {
        this.adjustForMobile();
      }, 100);
    });
  }
  renderCalendarStructure() {
  // Detecta se precisa de layout mobile
  const isMobileLayout = this.shouldUseMobileLayout();
  
  this.container.innerHTML = `
    <div class="calendar-header">
      <div class="calendar-nav">
        <button id="prev-month" aria-label="M√™s anterior">&lt;</button>
        <span class="calendar-month-year" id="month-year"></span>
        <button id="next-month" aria-label="Pr√≥ximo m√™s">&gt;</button>
      </div>
      <div class="calendar-actions" style="display: none;">
        <button class="btn btn-small" id="clear-selection">Limpar</button>
        <button class="btn btn-small" id="select-default">Padr√£o</button>
      </div>
    </div>
    <div class="calendar-grid" id="calendar-grid">
      <div class="calendar-weekday">D</div>
      <div class="calendar-weekday">S</div>
      <div class="calendar-weekday">T</div>
      <div class="calendar-weekday">Q</div>
      <div class="calendar-weekday">Q</div>
      <div class="calendar-weekday">S</div>
      <div class="calendar-weekday">S</div>
    </div>
    <div class="calendar-summary" style="display: none;">
      <div class="calendar-legend">
        <div class="legend-item"><div class="legend-dot overdue"></div><span>Atrasadas</span></div>
        <div class="legend-item"><div class="legend-dot upcoming"></div><span>Pr√≥ximas</span></div>
        <div class="legend-item"><div class="legend-dot future"></div><span>Futuras</span></div>
      </div>
      <div id="selection-count">0 datas selecionadas</div>
    </div>
  `;
  
  // For√ßa layout responsivo se necess√°rio
  if (isMobileLayout) {
    this.container.classList.add('calendar-responsive-override');
  }
}
// Adicione este m√©todo na classe ActivityCalendar:

shouldUseMobileLayout() {
  // Detecta m√∫ltiplos indicadores de mobile
  const inIframe = (window.top !== window.self);
  const isTouch = matchMedia('(pointer: coarse)').matches || 'ontouchstart' in window;
  const screenSmall = Math.min(screen.width, screen.height) <= 480;
  const viewportWide = window.innerWidth >= 700;
  const hasForceClass = document.documentElement.classList.contains('force-mobile');
  
  return hasForceClass || (inIframe && isTouch && screenSmall && viewportWide);
}

// Adicione este m√©todo na classe ActivityCalendar para ajustar tamanho dinamicamente:

adjustForMobile() {
  const container = this.container;
  if (!container) return;
  
  if (this.shouldUseMobileLayout()) {
    // For√ßa dimens√µes m√≥veis
    container.style.width = '100%';
    container.style.maxWidth = 'none';
    container.classList.add('calendar-responsive-override');
    
    // Ajusta c√©lulas do calend√°rio para toque
    const days = container.querySelectorAll('.calendar-day');
    days.forEach(day => {
      day.style.minHeight = '48px';
      day.style.fontSize = '14px';
    });
    
    const weekdays = container.querySelectorAll('.calendar-weekday');
    weekdays.forEach(weekday => {
      weekday.style.minHeight = '36px';
      weekday.style.fontSize = '13px';
    });
  }
}

  setupEventListeners() {
    var self=this;
    document.getElementById('prev-month').addEventListener('click', function(){ self.currentDate.setMonth(self.currentDate.getMonth()-1); self.render(); });
    document.getElementById('next-month').addEventListener('click', function(){ self.currentDate.setMonth(self.currentDate.getMonth()+1); self.render(); });
    document.getElementById('clear-selection').addEventListener('click', function(){ self.clearSelection(); });
    document.getElementById('select-default').addEventListener('click', function(){ self.selectDefaultDates(); });
  }
  getDateString(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
  parseDate(dateStr){
    if(!dateStr) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(dateStr)){ const [y,m,d]=dateStr.split('-').map(Number); return new Date(y,m-1,d); }
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)){ const [d,m,y]=dateStr.split('/').map(Number); return new Date(y,m-1,d); }
    const dt=new Date(dateStr); return isNaN(dt)?null:dt;
  }
  getActivitiesForDate(date){
    var dateStr=this.getDateString(date), self=this;
    return (this.activities||[]).filter(function(a){
      var ad=self.parseDate(a.data);
      var st=String(a.status||'').toLowerCase();
      var isPending=(st?st==='pendente':true);
      return isPending && ad && self.getDateString(ad)===dateStr;
    });
  }
  getDateStatus(date){ return DateSemaforo.getDateAlert(this.getDateString(date)); }
  render(){
    var year=this.currentDate.getFullYear();
    var month=this.currentDate.getMonth();
    document.getElementById('month-year').textContent=this.monthNames[month]+' '+year;
    var grid=document.getElementById('calendar-grid');
    var existingDays=grid.querySelectorAll('.calendar-day');
    for(var i=0;i<existingDays.length;i++){ existingDays[i].remove(); }
    var firstDay=new Date(year,month,1);
    var lastDay=new Date(year,month+1,0);
    var daysInMonth=lastDay.getDate();
    var startDay=firstDay.getDay();
    var prevMonth=new Date(year,month-1,0);

    // m√™s anterior
    for(var i2=startDay-1;i2>=0;i2--){
      var day=prevMonth.getDate()-i2;
      var date=new Date(year,month-1,day);
      this.createDayElement(date,true);
    }
    // m√™s atual
    for(var day2=1;day2<=daysInMonth;day2++){
      var date2=new Date(year,month,day2);
      this.createDayElement(date2,false);
    }
    // pr√≥ximo m√™s
    var totalCells=grid.children.length-7;
    var remaining=42-totalCells;
    for(var d3=1; d3<=remaining; d3++){
      var date3=new Date(year,month+1,d3);
      this.createDayElement(date3,true);
    }
    this.updateSelectionCount();
  }
  createDayElement(date,otherMonth){
    var dayEl=document.createElement('div');
    dayEl.className='calendar-day';
    dayEl.textContent=date.getDate();
    var dateStr=this.getDateString(date);
    dayEl.dataset.date=dateStr;
    if(otherMonth) dayEl.classList.add('other-month');

    const today=new Date(); today.setHours(0,0,0,0);
    const cellDate=new Date(date.getFullYear(),date.getMonth(),date.getDate());
    if(cellDate.getTime()===today.getTime()){ dayEl.classList.add('today'); }

    // pontinhos apenas se houver pendentes
    var dayActs=this.getActivitiesForDate(date);
    if(dayActs.length>0){
      dayEl.classList.add('has-activity');
      var status=this.getDateStatus(date);
      dayEl.classList.add(status);
      dayEl.title = dayActs.length + ' atividade(s) pendente(s)';
    }

    if(this.selectedDates.has(dateStr)) dayEl.classList.add('selected');

    var self=this;
    dayEl.addEventListener('click', function(){
      self.toggleDate(dateStr);
      dayEl.classList.toggle('selected');
      self.updateSelectionCount();
      self.onSelectionChange(Array.from(self.selectedDates));
    });

    document.getElementById('calendar-grid').appendChild(dayEl);
  }
  toggleDate(dateStr){ if(this.selectedDates.has(dateStr)) this.selectedDates.delete(dateStr); else this.selectedDates.add(dateStr); }
  clearSelection(){ this.selectedDates.clear(); this.render(); this.onSelectionChange([]); }
  selectDefaultDates(){
    this.selectedDates.clear();
    const today=new Date(); today.setHours(0,0,0,0);
    for(let i=0;i<=10;i++){ const d=new Date(today); d.setDate(today.getDate()+i); this.selectedDates.add(this.getDateString(d)); }
    (this.activities||[]).forEach(a=>{
      const ad=this.parseDate(a.data); const st=String(a.status||'').toLowerCase();
      if(!ad||st!=='pendente') return;
      const cmp=new Date(ad.getFullYear(),ad.getMonth(),ad.getDate());
      if(cmp<today) this.selectedDates.add(this.getDateString(ad));
    });
    this.render();
    this.onSelectionChange(this.getSelectedDates());
  }
  updateSelectionCount(){
    var count=this.selectedDates.size;
    var text = count===1 ? '1 data selecionada' : count+' datas selecionadas';
    document.getElementById('selection-count').textContent=text;
  }
  setActivities(activities){ this.activities=activities||[]; this.render(); }
  getSelectedDates(){ return Array.from(this.selectedDates); }
  selectDates(dateStrArray){ this.selectedDates.clear(); (dateStrArray||[]).forEach(d=>this.selectedDates.add(d)); this.render(); this.onSelectionChange(this.getSelectedDates()); }
}

/* ===========================
   State exports
   =========================== */
window.UI = UI;
window.Views = Views;

// Adiciona filtro por data no State (garantia)
if(!window.State) window.State={};
if(!window.State.ui) window.State.ui={};
window.State.ui.dateFilter=[];
window.State.calendar=null;


window.atualizarContadoresCategorias = function() {
  var filterItems = document.querySelectorAll('.categoria-atividade-filter-item');
  
  filterItems.forEach(function(item) {
    var categoriaId = item.getAttribute('data-categoria-atividade');
    var count = contarAtividadesPorCategoria(categoriaId);
    var countSpan = item.querySelector('.filter-count');
    if (countSpan) {
      countSpan.textContent = '(' + count + ')';
    }
  });
  
  // Fun√ß√£o local para contar atividades
  function contarAtividadesPorCategoria(categoriaId) {
    if (!State.cache || !State.cache.atividades) return 0;
    
    var items = State.cache.atividades.slice();
    
    // Filtro de status atual
    var statusAtivo = 'todas';
    var chipStatusAtivo = document.querySelector('#chips .chip.is-active[data-status]');
    if (chipStatusAtivo) {
      statusAtivo = chipStatusAtivo.getAttribute('data-status');
    }
    
    if (statusAtivo !== 'todas') {
      items = items.filter(function(a) { 
        return a.status === statusAtivo; 
      });
    }
    
    // Filtro "Minhas tarefas"
    if (State.ui && State.ui.minhas) {
      items = items.filter(function(a) { 
        return a.uid === State.uid; 
      });
    }
    
    // Filtro por nome de usu√°rio
    if (State.ui && State.ui.nomeFiltro) {
      var q = String(State.ui.nomeFiltro || '').toLowerCase();
      items = items.filter(function(a) { 
        return String(a.usuarioNome || '').toLowerCase().indexOf(q) >= 0; 
      });
    }
    
    // Filtro por datas selecionadas no calend√°rio
    if (State.ui && State.ui.dateFilter && State.ui.dateFilter.length > 0) {
      items = items.filter(function(a) {
        if (!a.data) return false;
        var activityDate = null;
        if (/^\d{4}-\d{2}-\d{2}$/.test(a.data)) { 
          activityDate = a.data; 
        } else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(a.data)) {
          var parts = a.data.split('/');
          var day = parts[0].padStart(2, '0');
          var month = parts[1].padStart(2, '0');
          var year = parts[2];
          activityDate = year + '-' + month + '-' + day;
        } else {
          try {
            var dateObj = new Date(a.data);
            if (!isNaN(dateObj.getTime())) {
              var year = dateObj.getFullYear();
              var month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
              var day = dateObj.getDate().toString().padStart(2, '0');
              activityDate = year + '-' + month + '-' + day;
            }
          } catch(e) {}
        }
        return activityDate && State.ui.dateFilter.indexOf(activityDate) >= 0;
      });
    }
    
    // Filtra por categoria
    if (categoriaId === 'todas') {
      return items.length;
    } else {
      return items.filter(function(a) {
        return (a.categoriaAtividadeId || '') === categoriaId;
      }).length;
    }
  }
};

window.initResponsiveCalendar = function(containerId, options) {
  const container = document.querySelector(containerId);
  if (!container) return null;
  
  // For√ßa container responsivo
  const wrapper = container.closest('#calendar-wrapper');
  if (wrapper) {
    wrapper.style.width = '100%';
    wrapper.style.overflow = 'hidden';
  }
  
  // Detecta necessidade de layout mobile
  const needsMobileLayout = (function() {
    const inIframe = (window.top !== window.self);
    const isTouch = matchMedia('(pointer: coarse)').matches || 'ontouchstart' in window;
    const screenSmall = Math.min(screen.width, screen.height) <= 480;
    const viewportWide = window.innerWidth >= 700;
    const hasForceClass = document.documentElement.classList.contains('force-mobile');
    
    return hasForceClass || (inIframe && isTouch && screenSmall && viewportWide);
  })();
  
  if (needsMobileLayout) {
    container.style.width = '100%';
    container.style.maxWidth = 'none';
    container.classList.add('calendar-responsive-override');
  }
  
  // Cria calend√°rio
  const calendar = new ActivityCalendar(containerId, options);
  
  // For√ßa ajuste ap√≥s cria√ß√£o
  setTimeout(() => {
    if (calendar.adjustForMobile) {
      calendar.adjustForMobile();
    }
  }, 200);
  
  return calendar;
};

/* ===========================
   Sistema de Participa√ß√µes
   =========================== */

window.ParticipacaoSystem = {
  currentActivityId: null,
  modal: null,
  extraModal: null,

  // Fun√ß√µes helper para loading
  showLoading: function(elementId) {
    var element = document.getElementById(elementId);
    if (element) {
      element.style.display = 'flex';
    }
  },

  hideLoading: function(elementId) {
    var element = document.getElementById(elementId);
    if (element) {
      element.style.display = 'none';
    }
  },

  showElement: function(elementId) {
    var element = document.getElementById(elementId);
    if (element) {
      element.style.display = 'block';
    }
  },

  hideElement: function(elementId) {
    var element = document.getElementById(elementId);
    if (element) {
      element.style.display = 'none';
    }
  },

  setButtonLoading: function(buttonElement, loading) {
    if (loading) {
      buttonElement.classList.add('is-loading');
      buttonElement.disabled = true;
    } else {
      buttonElement.classList.remove('is-loading');
      buttonElement.disabled = false;
    }
  },

  init: function() {
    console.log('üéØ ParticipacaoSystem.init');

    // Cria o modal se n√£o existir
    if (!this.modal) {
      this.createModal();
    }

    this.setupEventListeners();
  },

  createModal: function() {
    console.log('üìÑ Criando modal de participa√ß√µes...');

    // Busca o template
    var template = document.getElementById('tpl-participacoes-modal');
    if (!template) {
      console.error('‚ùå Template tpl-participacoes-modal n√£o encontrado!');
      return;
    }

    // Cria o modal
    var modalHtml = template.innerHTML;
    var div = document.createElement('div');
    div.innerHTML = modalHtml;

    this.modal = div.firstElementChild;
    this.extraModal = div.children[1]; // segundo modal (membro extra)

    document.body.appendChild(this.modal);
    if (this.extraModal) {
      document.body.appendChild(this.extraModal);
    }

    console.log('‚úÖ Modal de participa√ß√µes criado');
  },

  setupEventListeners: function() {
    if (!this.modal) return;

    // Fechar modal principal
    var closeBtn = this.modal.querySelector('#participacoes-modal-close');
    var cancelBtn = this.modal.querySelector('#participacoes-modal-cancel');

    if (closeBtn) closeBtn.addEventListener('click', this.closeModal.bind(this));
    if (cancelBtn) cancelBtn.addEventListener('click', this.closeModal.bind(this));

    // Clicar fora do modal
    this.modal.addEventListener('click', function(ev) {
      if (ev.target === this.modal) {
        this.closeModal();
      }
    }.bind(this));

    // Abas
    var tabBtns = this.modal.querySelectorAll('.tab-btn');
    tabBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var tab = btn.getAttribute('data-tab');
        this.switchTab(tab);
      }.bind(this));
    }.bind(this));

    console.log('‚úÖ Event listeners configurados');
  },

  openModal: function(activityId) {
    console.log('üîì Abrindo modal de participa√ß√µes para atividade:', activityId);

    if (!this.modal) {
      this.init();
    }

    this.currentActivityId = activityId;

    // Busca o t√≠tulo da atividade no cache
    var atividade = this.findActivityById(activityId);
    var activityTitle = atividade ? atividade.titulo : activityId;

    // Define t√≠tulo
    var title = this.modal.querySelector('#participacoes-modal-title');
    if (title) {
      title.textContent = 'Participa√ß√µes - ' + activityTitle;
    }

    // Mostra o modal
    this.modal.style.display = 'block';

    // Abre na primeira aba (que vai carregar os dados automaticamente)
    this.switchTab('definir-alvos');
  },

  closeModal: function() {
    console.log('üîí Fechando modal de participa√ß√µes');

    if (this.modal) {
      this.modal.style.display = 'none';
    }

    this.currentActivityId = null;
  },

  switchTab: function(tabName) {
    console.log('üîÑ Mudando para aba:', tabName);

    // Evita m√∫ltiplas chamadas r√°pidas
    if (this.currentTab === tabName) {
      console.log('‚ö†Ô∏è Aba j√° est√° ativa, ignorando');
      return;
    }

    this.currentTab = tabName;

    // Remove classe active de todas as abas
    var tabBtns = this.modal.querySelectorAll('.tab-btn');
    var tabContents = this.modal.querySelectorAll('.tab-content');

    tabBtns.forEach(function(btn) {
      btn.classList.remove('active');
    });

    tabContents.forEach(function(content) {
      content.classList.remove('active');
    });

    // Ativa a aba selecionada
    var activeBtn = this.modal.querySelector('[data-tab="' + tabName + '"]');
    var activeContent = this.modal.querySelector('#content-' + tabName);

    if (activeBtn) activeBtn.classList.add('active');
    if (activeContent) activeContent.classList.add('active');

    // Carrega dados espec√≠ficos da aba
    this.loadTabData(tabName);
  },

  loadData: function() {
    console.log('üì° Carregando dados de participa√ß√£o para:', this.currentActivityId);

    if (!this.currentActivityId) {
      console.error('‚ùå currentActivityId n√£o definido!');
      return;
    }

    // Carrega estat√≠sticas b√°sicas
    API.getParticipacaoStats(this.currentActivityId)
      .then(function(result) {
        console.log('‚úÖ Estat√≠sticas carregadas:', result);
        if (result && result.stats) {
          this.updateStats(result.stats);
        } else {
          console.warn('‚ö†Ô∏è Resultado de estat√≠sticas inv√°lido:', result);
        }
      }.bind(this))
      .catch(function(error) {
        console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
        UI.toast('Sistema de participa√ß√µes em desenvolvimento', 'info');

        // Define stats zeradas como fallback
        this.updateStats({
          total: 0,
          confirmados: 0,
          participaram: 0,
          ausentes: 0
        });
      }.bind(this));
  },

  loadTabData: function(tabName) {
    console.log('üìä Carregando dados da aba:', tabName);

    switch (tabName) {
      case 'definir-alvos':
        this.loadAlvosTab();
        break;
      case 'controlar-participacoes':
        this.loadParticipacoesTab();
        break;
      case 'estatisticas':
        this.loadEstatisticasTab();
        break;
    }
  },

  loadAlvosTab: function() {
    console.log('üéØ Carregando aba de alvos...');

    // Inicializa filtros e controles
    this.setupAlvosFilters();
    this.setupAlvosEventListeners();

    // Esconde resultados inicialmente
    var alvosContainer = this.modal.querySelector('#alvos-resultados');
    if (alvosContainer) {
      alvosContainer.style.display = 'none';
    }
  },

  setupAlvosFilters: function() {
    console.log('üîß Configurando filtros de alvos...');

    // Carrega membros para extrair valores √∫nicos dos filtros
    if (!State.cache || !State.cache.membros) {
      console.warn('‚ö†Ô∏è Cache de membros n√£o dispon√≠vel - carregando...');

      // Mostra loading enquanto carrega dados para os combobox
      this.showLoading('filtros-loading');
      this.hideElement('alvos-filters-simple');
      this.hideElement('alvos-actions');

      this.loadMembrosForFilters();
      return;
    }

    var membros = State.cache.membros;
    this.createAlvosFilterChips(membros);
  },

  loadMembrosForFilters: function() {
    console.log('üì° Carregando membros para filtros...');

    API.listMembers()
      .then(function(membros) {
        console.log('‚úÖ Membros carregados para filtros:', membros.length);

        // Salva no cache se n√£o existir
        if (!State.cache) State.cache = {};
        State.cache.membros = membros;

        // Cria os filtros agora
        this.createAlvosFilterChips(membros);

        // Esconde loading e mostra filtros preenchidos
        this.hideLoading('filtros-loading');
        this.showElement('alvos-filters-simple');
        this.showElement('alvos-actions');
      }.bind(this))
      .catch(function(error) {
        console.error('‚ùå Erro ao carregar membros:', error);
        UI.toast('Erro ao carregar membros para filtros', 'err');

        // Esconde loading em caso de erro
        this.hideLoading('filtros-loading');
      }.bind(this));
  },

  createAlvosFilterChips: function(membros) {
    // Extrai valores √∫nicos
    var dojos = [];
    var status = [];
    var cargos = [];
    var categorias = [];
    var buntais = [];

    membros.forEach(function(m) {
      if (m.dojo && dojos.indexOf(m.dojo) === -1) dojos.push(m.dojo);
      if (m.status && status.indexOf(m.status) === -1) status.push(m.status);
      if (m.cargo && cargos.indexOf(m.cargo) === -1) cargos.push(m.cargo);
      if (m.categoria_grupo && categorias.indexOf(m.categoria_grupo) === -1) categorias.push(m.categoria_grupo);
      if (m.buntai && buntais.indexOf(m.buntai) === -1) buntais.push(m.buntai);
    });

    // Ordena alfabeticamente
    dojos.sort();
    status.sort();
    cargos.sort();
    categorias.sort();
    buntais.sort();

    // Popula os selects
    this.populateSelect('alvos-dojo-select', dojos);
    this.populateSelect('alvos-status-select', status);
    this.populateSelect('alvos-cargo-select', cargos);
    this.populateSelect('alvos-categoria-select', categorias);
    this.populateSelect('alvos-buntai-select', buntais);
  },

  populateSelect: function(selectId, values) {
    var select = this.modal.querySelector('#' + selectId);
    if (!select) return;

    // Mant√©m a primeira op√ß√£o (ex: "Todos os dojos")
    var firstOption = select.options[0];
    select.innerHTML = '';
    select.appendChild(firstOption);

    // Adiciona as op√ß√µes
    values.forEach(function(value) {
      var option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    });
  },

  setupAlvosEventListeners: function() {
    var self = this;

    // Busca por nome
    var searchInput = this.modal.querySelector('#alvos-busca-nome');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        console.log('üîç Busca:', this.value);
      });
    }

    // Bot√£o buscar membros
    var btnBuscar = this.modal.querySelector('#btn-buscar-membros');
    if (btnBuscar) {
      btnBuscar.addEventListener('click', function() {
        self.executarBuscaMembros();
      });
    }

    // Bot√£o limpar filtros
    var btnLimpar = this.modal.querySelector('#btn-limpar-filtros-alvos');
    if (btnLimpar) {
      btnLimpar.addEventListener('click', function() {
        self.limparFiltrosAlvos();
      });
    }

    // Bot√µes de sele√ß√£o
    var btnSelecionarTodos = this.modal.querySelector('#btn-selecionar-todos');
    var btnDesselecionar = this.modal.querySelector('#btn-desselecionar-todos');

    if (btnSelecionarTodos) {
      btnSelecionarTodos.addEventListener('click', function() {
        self.selecionarTodosMembros();
      });
    }

    if (btnDesselecionar) {
      btnDesselecionar.addEventListener('click', function() {
        self.desselecionarTodosMembros();
      });
    }

    // Bot√£o definir alvos
    var btnDefinir = this.modal.querySelector('#btn-definir-alvos');
    if (btnDefinir) {
      btnDefinir.addEventListener('click', function() {
        self.definirAlvosSelecionados();
      });
    }
  },

  executarBuscaMembros: function() {
    console.log('üîç Executando busca de membros...');

    // Mostra loading e esconde resultados
    this.showLoading('alvos-loading');
    this.hideElement('alvos-resultados');

    // Adiciona loading ao bot√£o
    var btnBuscar = document.getElementById('btn-buscar-membros');
    if (btnBuscar) {
      this.setButtonLoading(btnBuscar, true);
    }

    // Coleta filtros ativos
    var filtros = this.coletarFiltrosAtivos();
    console.log('Filtros coletados:', filtros);

    // Tenta usar API espec√≠fica, sen√£o usa listMembers com filtro local
    API.searchMembersByCriteria(filtros)
      .then(function(result) {
        if (result.ok) {
          this.renderResultadosBusca(result.items);
        } else {
          console.error('Erro na busca:', result.error);
          UI.toast('Erro ao buscar membros', 'err');
        }

        // Remove loading
        this.hideLoading('alvos-loading');
        this.showElement('alvos-resultados');
        if (btnBuscar) {
          this.setButtonLoading(btnBuscar, false);
        }
      }.bind(this))
      .catch(function(error) {
        console.warn('API searchMembersByCriteria falhou, usando fallback:', error);
        this.executarBuscaComFallback(filtros);
      }.bind(this));
  },

  executarBuscaComFallback: function(filtros) {
    console.log('üîÑ Usando busca com fallback...');

    var btnBuscar = document.getElementById('btn-buscar-membros');

    // Usa listMembers e filtra localmente
    API.listMembers()
      .then(function(membros) {
        var resultados = this.filtrarMembrosLocalmente(membros, filtros);
        this.renderResultadosBusca(resultados);

        // Remove loading
        this.hideLoading('alvos-loading');
        this.showElement('alvos-resultados');
        if (btnBuscar) {
          this.setButtonLoading(btnBuscar, false);
        }
      }.bind(this))
      .catch(function(error) {
        console.error('‚ùå Fallback tamb√©m falhou:', error);
        UI.toast('Erro ao buscar membros', 'err');
      });
  },

  filtrarMembrosLocalmente: function(membros, filtros) {
    console.log('üîç Filtrando', membros.length, 'membros localmente...');

    return membros.filter(function(membro) {
      // Filtro por dojo
      if (filtros.dojo && filtros.dojo.length > 0) {
        if (!membro.dojo || filtros.dojo.indexOf(membro.dojo) === -1) {
          return false;
        }
      }

      // Filtro por status
      if (filtros.status && filtros.status.length > 0) {
        if (!membro.status || filtros.status.indexOf(membro.status) === -1) {
          return false;
        }
      }

      // Filtro por cargo
      if (filtros.cargo && filtros.cargo.length > 0) {
        if (!membro.cargo || filtros.cargo.indexOf(membro.cargo) === -1) {
          return false;
        }
      }

      // Filtro por categoria_grupo
      if (filtros.categoria_grupo && filtros.categoria_grupo.length > 0) {
        if (!membro.categoria_grupo || filtros.categoria_grupo.indexOf(membro.categoria_grupo) === -1) {
          return false;
        }
      }

      // Filtro por buntai
      if (filtros.buntai && filtros.buntai.length > 0) {
        if (!membro.buntai || filtros.buntai.indexOf(membro.buntai) === -1) {
          return false;
        }
      }

      // Filtro por nome
      if (filtros.nome) {
        var nome = filtros.nome.toLowerCase();
        if (!membro.nome || membro.nome.toLowerCase().indexOf(nome) === -1) {
          return false;
        }
      }

      return true;
    });
  },

  coletarFiltrosAtivos: function() {
    var filtros = {};

    // Coleta valores dos selects
    var dojoSelect = this.modal.querySelector('#alvos-dojo-select');
    var statusSelect = this.modal.querySelector('#alvos-status-select');
    var cargoSelect = this.modal.querySelector('#alvos-cargo-select');
    var categoriaSelect = this.modal.querySelector('#alvos-categoria-select');
    var buntaiSelect = this.modal.querySelector('#alvos-buntai-select');

    if (dojoSelect && dojoSelect.value) {
      filtros.dojo = [dojoSelect.value];
    }

    if (statusSelect && statusSelect.value) {
      filtros.status = [statusSelect.value];
    }

    if (cargoSelect && cargoSelect.value) {
      filtros.cargo = [cargoSelect.value];
    }

    if (categoriaSelect && categoriaSelect.value) {
      filtros.categoria_grupo = [categoriaSelect.value];
    }

    if (buntaiSelect && buntaiSelect.value) {
      filtros.buntai = [buntaiSelect.value];
    }

    // Busca por nome
    var searchInput = this.modal.querySelector('#alvos-busca-nome');
    if (searchInput && searchInput.value.trim()) {
      filtros.nome = searchInput.value.trim();
    }

    return filtros;
  },

  renderResultadosBusca: function(membros) {
    console.log('üé® Renderizando resultados:', membros.length, 'membros');

    var container = this.modal.querySelector('#alvos-resultados');
    var lista = this.modal.querySelector('#alvos-lista');
    var count = this.modal.querySelector('#alvos-count');

    if (!container || !lista || !count) return;

    count.textContent = membros.length + ' membros encontrados';
    container.style.display = 'block';

    if (membros.length === 0) {
      lista.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--muted);">Nenhum membro encontrado com os filtros aplicados.</div>';
      return;
    }

    var html = '';
    membros.forEach(function(membro) {
      html += this.renderMembroItem(membro);
    }.bind(this));

    lista.innerHTML = html;

    // Adiciona event listeners para checkboxes
    this.setupMembrosCheckboxes();
    this.atualizarContadorSelecionados();
  },

  renderMembroItem: function(membro) {
    var detalhes = [];
    if (membro.dojo) detalhes.push(membro.dojo);
    if (membro.cargo) detalhes.push(membro.cargo);
    if (membro.categoria_grupo) detalhes.push(membro.categoria_grupo);

    return '<div class="alvo-item" data-member-id="' + membro.id + '">' +
      '<input type="checkbox" class="alvo-checkbox" data-member-id="' + membro.id + '">' +
      '<div class="alvo-info">' +
        '<div class="alvo-nome">' + membro.nome + '</div>' +
        '<div class="alvo-detalhes">' + detalhes.join(' ‚Ä¢ ') + '</div>' +
      '</div>' +
    '</div>';
  },

  setupMembrosCheckboxes: function() {
    var checkboxes = this.modal.querySelectorAll('.alvo-checkbox');
    checkboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        var item = checkbox.closest('.alvo-item');
        item.classList.toggle('selected', checkbox.checked);
        this.atualizarContadorSelecionados();
      }.bind(this));
    }.bind(this));
  },

  atualizarContadorSelecionados: function() {
    var selecionados = this.modal.querySelectorAll('.alvo-checkbox:checked').length;
    var countEl = this.modal.querySelector('#alvos-selecionados');
    if (countEl) {
      countEl.textContent = selecionados + ' selecionados';
    }
  },

  selecionarTodosMembros: function() {
    var checkboxes = this.modal.querySelectorAll('.alvo-checkbox');
    checkboxes.forEach(function(checkbox) {
      checkbox.checked = true;
      checkbox.closest('.alvo-item').classList.add('selected');
    });
    this.atualizarContadorSelecionados();
  },

  desselecionarTodosMembros: function() {
    var checkboxes = this.modal.querySelectorAll('.alvo-checkbox');
    checkboxes.forEach(function(checkbox) {
      checkbox.checked = false;
      checkbox.closest('.alvo-item').classList.remove('selected');
    });
    this.atualizarContadorSelecionados();
  },

  limparFiltrosAlvos: function() {
    // Reseta todos os selects para primeira op√ß√£o
    var selects = this.modal.querySelectorAll('.filter-select');
    selects.forEach(function(select) {
      select.selectedIndex = 0;
    });

    // Limpa busca por nome
    var searchInput = this.modal.querySelector('#alvos-busca-nome');
    if (searchInput) {
      searchInput.value = '';
    }

    // Esconde resultados
    var container = this.modal.querySelector('#alvos-resultados');
    if (container) {
      container.style.display = 'none';
    }

    console.log('‚úÖ Filtros de alvos limpos');
  },

  definirAlvosSelecionados: function() {
    var checkboxes = this.modal.querySelectorAll('.alvo-checkbox:checked');
    var memberIds = [];

    checkboxes.forEach(function(checkbox) {
      memberIds.push(checkbox.getAttribute('data-member-id'));
    });

    if (memberIds.length === 0) {
      UI.toast('Selecione pelo menos um membro', 'warn');
      return;
    }

    console.log('üéØ Definindo alvos:', memberIds);

    API.defineTargets(this.currentActivityId, memberIds)
      .then(function(result) {
        if (result.ok) {
          console.log('‚úÖ Alvos definidos usando m√©todo:', result.method);

          // S√≥ salva em cache se for modo desenvolvimento
          if (result.method === 'dev_mode') {
            sessionStorage.setItem('activity_targets_' + this.currentActivityId, JSON.stringify(memberIds));
            console.log('üíæ Alvos salvos em cache (modo desenvolvimento):', memberIds.length, 'membros');
            UI.toast('Alvos definidos (modo desenvolvimento)', 'success');
          } else if (result.method === 'direct_save') {
            console.log('üìã Alvos gravados diretamente na planilha:', result.created, 'membros');
            UI.toast('Alvos gravados na planilha!', 'success');
            // Tamb√©m salva em cache para uso local
            sessionStorage.setItem('activity_targets_' + this.currentActivityId, JSON.stringify(memberIds));
          } else if (result.method === 'original') {
            console.log('üìã Alvos gravados pelo m√©todo original:', result.created, 'membros');
            UI.toast('Alvos definidos com sucesso!', 'success');
            sessionStorage.setItem('activity_targets_' + this.currentActivityId, JSON.stringify(memberIds));
          }

          // this.switchTab('controlar-participacoes'); // Comentado - mant√©m na aba atual
        } else {
          UI.toast('Erro ao definir alvos: ' + result.error, 'err');
        }
      }.bind(this))
      .catch(function(error) {
        console.error('Erro ao definir alvos:', error);
        UI.toast('Erro ao definir alvos', 'err');
      });
  },

  loadParticipacoesTab: function() {
    console.log('‚úÖ Carregando aba de participa√ß√µes...');

    // Mostra loading
    this.showLoading('participacoes-loading');
    this.hideElement('participacoes-resumo');
    this.hideElement('participacoes-lista');

    // Carrega participa√ß√µes e membros em paralelo
    Promise.all([
      API.listParticipacoes(this.currentActivityId),
      API.listMembers()
    ])
    .then(function(results) {
      var participacoes = results[0];
      var membros = results[1];

      console.log('‚úÖ Participa√ß√µes carregadas:', participacoes);
      console.log('‚úÖ Membros carregados:', membros);

      // Enriquece participa√ß√µes com nomes dos membros
      var participacoesEnriquecidas = this.enrichParticipacoes(participacoes.items, membros);

      this.renderParticipacoes(participacoesEnriquecidas);
      this.setupParticipacoesEvents();

      // Carrega e atualiza estat√≠sticas do resumo
      API.getParticipacaoStats(this.currentActivityId)
        .then(function(statsResult) {
          if (statsResult && statsResult.stats) {
            this.updateStats(statsResult.stats);
          }
        }.bind(this))
        .catch(function(error) {
          console.error('‚ùå Erro ao carregar stats do resumo:', error);
        });

      // Esconde loading e mostra conte√∫do
      this.hideLoading('participacoes-loading');
      this.showElement('participacoes-resumo');
      this.showElement('participacoes-lista');
    }.bind(this))
    .catch(function(error) {
      console.error('‚ùå Erro ao carregar participa√ß√µes:', error);
      UI.toast('Erro ao carregar participa√ß√µes', 'err');

      // Esconde loading em caso de erro
      this.hideLoading('participacoes-loading');
    }.bind(this));
  },

  loadEstatisticasTab: function() {
    console.log('üìä Carregando aba de estat√≠sticas...');

    // Mostra loading
    this.showLoading('estatisticas-loading');
    this.hideElement('stats-grid');
    this.hideElement('stats-breakdown');

    API.getParticipacaoStats(this.currentActivityId)
      .then(function(result) {
        console.log('‚úÖ Estat√≠sticas detalhadas carregadas:', result);
        this.renderEstatisticas(result.stats);

        // Esconde loading e mostra conte√∫do
        this.hideLoading('estatisticas-loading');
        this.showElement('stats-grid');
        this.showElement('stats-breakdown');
      }.bind(this))
      .catch(function(error) {
        console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
        UI.toast('Erro ao carregar estat√≠sticas', 'err');

        // Esconde loading em caso de erro
        this.hideLoading('estatisticas-loading');
      }.bind(this));
  },

  updateStats: function(stats) {
    console.log('üìä Atualizando estat√≠sticas:', stats);

    // Atualiza resumo na aba de participa√ß√µes
    this.setElementText('resumo-total', stats.total);
    this.setElementText('resumo-confirmados', stats.confirmados);
    this.setElementText('resumo-participaram', stats.participaram);
    this.setElementText('resumo-ausentes', stats.ausentes);
  },

  enrichParticipacoes: function(participacoes, membros) {
    console.log('üîó Enriquecendo participa√ß√µes com dados dos membros...');

    if (!participacoes || !membros) {
      console.warn('‚ö†Ô∏è Dados insuficientes para enriquecer participa√ß√µes');
      return participacoes || [];
    }

    // Cria mapa de membros por ID para busca r√°pida
    var membrosMap = {};
    membros.forEach(function(membro) {
      membrosMap[membro.id] = membro;
    });

    // Enriquece cada participa√ß√£o com dados do membro
    var participacoesEnriquecidas = participacoes.map(function(participacao) {
      var memberId = participacao.memberId || participacao.id_membro;
      var membro = membrosMap[memberId] || membrosMap[String(memberId)];

      console.log('üîç Processando participa√ß√£o:', {
        memberId: memberId,
        participacao: participacao,
        participou: participacao.participou,
        chegou_tarde: participacao.chegou_tarde,
        saiu_cedo: participacao.saiu_cedo
      });

      if (membro) {
        return Object.assign({}, participacao, {
          memberNome: membro.nome || membro.nomeCompleto || membro.name || ('Membro ' + memberId),
          memberDojo: membro.dojo || 'N/A',
          memberEmail: membro.email || '',
          memberStatus: membro.status || ''
        });
      } else {
        console.warn('‚ö†Ô∏è Membro n√£o encontrado para ID:', memberId);
        return Object.assign({}, participacao, {
          memberNome: 'Membro ' + memberId,
          memberDojo: 'N/A'
        });
      }
    });

    console.log('‚úÖ Participa√ß√µes enriquecidas:', participacoesEnriquecidas.length);
    return participacoesEnriquecidas;
  },

  renderParticipacoes: function(participacoes) {
    console.log('üé® Renderizando lista de participa√ß√µes:', participacoes);

    var lista = this.modal.querySelector('#participacoes-lista');
    if (!lista) return;

    if (!participacoes || participacoes.length === 0) {
      lista.innerHTML = '<div class="empty-state"><p>Nenhuma participa√ß√£o definida ainda.</p><p>Use a aba "Definir Alvos" para come√ßar.</p></div>';
      return;
    }

    var html = '';
    participacoes.forEach(function(p) {
      html += this.renderParticipacaoItem(p);
    }.bind(this));

    lista.innerHTML = html;
  },

  renderParticipacaoItem: function(participacao) {
    // Suporte para diferentes formatos de dados (backend vs mock)
    var memberId = participacao.memberId || participacao.id_membro;

    // Tenta v√°rias maneiras de obter o nome
    var memberNome = participacao.memberNome || participacao.nome || participacao.nomeCompleto;

    // Se ainda n√£o tem nome, busca no cache de membros
    if (!memberNome || memberNome.startsWith('Membro ')) {
      var cachedMembers = sessionStorage.getItem('cached_members');
      if (cachedMembers) {
        try {
          var members = JSON.parse(cachedMembers);
          var foundMember = members.find(function(m) {
            return m.id === memberId || m.id === String(memberId);
          });
          if (foundMember) {
            memberNome = foundMember.nome || foundMember.nomeCompleto || foundMember.name;
            console.log('üîç Nome encontrado no cache:', memberNome, 'para membro', memberId);
          }
        } catch (e) {
          console.warn('Erro ao buscar no cache:', e);
        }
      }
    }

    // Se ainda n√£o tem nome, usa fallback
    if (!memberNome) {
      memberNome = 'Membro ' + memberId;
    }

    console.log('üë§ Renderizando participa√ß√£o:', {memberId, memberNome, participacao});

    // L√™ valores diretamente da participa√ß√£o
    var confirmacao = participacao.confirmacao || participacao.confirmou || 'pendente';
    var participou = participacao.participou || ''; // Campo direto da planilha
    var chegouTarde = String(participacao.chegou_tarde || '').toLowerCase() === 'sim';
    var saiuCedo = String(participacao.saiu_cedo || '').toLowerCase() === 'sim';
    var observacoes = participacao.observacoes || participacao.justificativa || '';
    var isTarget = participacao.isTarget || false;
    var isExtra = participacao.isExtra || false;

    console.log('üîç Valores da planilha:', {
      'participacao.participou': participacao.participou,
      'participacao.chegou_tarde': participacao.chegou_tarde,
      'participacao.saiu_cedo': participacao.saiu_cedo,
      'confirmacao': confirmacao
    });

    console.log('üîç Estados dos checkboxes calculados:', {
      participou: participou,
      participouSim: participou === 'sim',
      chegouTarde: chegouTarde,
      saiuCedo: saiuCedo
    });

    var confirmacaoClass = '';
    var confirmacaoText = '';

    if (confirmacao === 'sim' || confirmacao === 'confirmou') {
      confirmacaoClass = 'sim';
      confirmacaoText = 'Confirmou';
    } else if (confirmacao === 'nao' || confirmacao === 'recusou') {
      confirmacaoClass = 'nao';
      confirmacaoText = 'Recusou';
    } else {
      confirmacaoClass = 'pendente';
      confirmacaoText = 'Pendente';
    }

    // N√£o usar tipo chip - removido conforme solicitado

    var participouChecked = participou === 'sim' ? ' checked' : '';
    var chegouTardeChecked = chegouTarde ? ' checked' : '';
    var saiuCedoChecked = saiuCedo ? ' checked' : '';
    var mostrarDetalhes = participou === 'sim' ? ' style="display: flex;"' : ' style="display: none;"';

    return '<div class="participacao-item-novo" data-member-id="' + memberId + '"' +
      ' data-initial-participou="' + (participou === 'sim') + '"' +
      ' data-initial-chegou-tarde="' + chegouTarde + '"' +
      ' data-initial-saiu-cedo="' + saiuCedo + '"' +
      ' data-initial-observacoes="' + (observacoes || '').replace(/"/g, '&quot;') + '"' +
    '>' +

      '<div class="participacao-linha-1">' +
        '<span class="participacao-nome-principal">' + memberNome + '</span>' +
        '<span class="confirmacao-chip ' + confirmacaoClass + '">' + confirmacaoText + '</span>' +
      '</div>' +

      '<div class="participacao-linha-2">' +
        '<label class="checkbox-participou">' +
          '<input type="checkbox" data-field="participacao"' + participouChecked + '> Participou' +
        '</label>' +
        '<div class="participacao-detalhes-inline"' + mostrarDetalhes + '>' +
          '<label class="checkbox-detalhe">' +
            '<input type="checkbox" data-field="chegou_tarde"' + chegouTardeChecked + '> Chegou tarde' +
          '</label>' +
          '<label class="checkbox-detalhe">' +
            '<input type="checkbox" data-field="saiu_cedo"' + saiuCedoChecked + '> Saiu cedo' +
          '</label>' +
        '</div>' +
      '</div>' +

      '<div class="participacao-linha-3">' +
        '<textarea placeholder="Observa√ß√µes..." data-field="observacoes">' + observacoes + '</textarea>' +
      '</div>' +

    '</div>';
  },

  setupParticipacoesEvents: function() {
    var lista = this.modal.querySelector('#participacoes-lista');
    if (!lista) return;

    // Event delegation para checkboxes de participa√ß√£o
    lista.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' && e.target.getAttribute('data-field') === 'participacao') {
        var participacaoItem = e.target.closest('.participacao-item-novo');
        var detalhesSection = participacaoItem.querySelector('.participacao-detalhes-inline');

        if (e.target.checked) {
          // Mostra op√ß√µes de chegou tarde/saiu cedo
          detalhesSection.style.display = 'flex';
        } else {
          // Esconde op√ß√µes e desmarca checkboxes
          detalhesSection.style.display = 'none';
          var checkboxesConcluded = detalhesSection.querySelectorAll('input[type="checkbox"]');
          checkboxesConcluded.forEach(function(cb) {
            cb.checked = false;
          });
        }
      }
    });

    // Event delegation para outros checkboxes e textarea
    lista.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox' || e.target.tagName === 'TEXTAREA') {
        var participacaoItem = e.target.closest('.participacao-item-novo');

        // Verifica se h√° alguma altera√ß√£o nos dados
        var hasChanges = this.checkIfParticipacaoChanged(participacaoItem);

        if (hasChanges) {
          participacaoItem.classList.add('modified');
        } else {
          participacaoItem.classList.remove('modified');
        }
      }
    }.bind(this));

    // Event listener para o bot√£o salvar
    var btnSalvar = this.modal.querySelector('#btn-salvar-participacoes');
    if (btnSalvar) {
      btnSalvar.addEventListener('click', function() {
        this.salvarAlteracoesParticipacoes();
      }.bind(this));
    }
  },

  checkIfParticipacaoChanged: function(participacaoItem) {
    // Coleta os valores atuais dos campos
    var participouChecked = participacaoItem.querySelector('[data-field="participacao"]').checked;
    var chegouTardeChecked = participacaoItem.querySelector('[data-field="chegou_tarde"]').checked;
    var saiuCedoChecked = participacaoItem.querySelector('[data-field="saiu_cedo"]').checked;
    var observacoes = participacaoItem.querySelector('[data-field="observacoes"]').value.trim();

    // Valores iniciais (salvos como data attributes quando renderiza)
    var initialParticipou = participacaoItem.getAttribute('data-initial-participou') === 'true';
    var initialChegouTarde = participacaoItem.getAttribute('data-initial-chegou-tarde') === 'true';
    var initialSaiuCedo = participacaoItem.getAttribute('data-initial-saiu-cedo') === 'true';
    var initialObservacoes = participacaoItem.getAttribute('data-initial-observacoes') || '';

    // Verifica se h√° mudan√ßas
    return (
      participouChecked !== initialParticipou ||
      chegouTardeChecked !== initialChegouTarde ||
      saiuCedoChecked !== initialSaiuCedo ||
      observacoes !== initialObservacoes
    );
  },

  salvarAlteracoesParticipacoes: function() {
    console.log('üíæ Salvando todas as participa√ß√µes...');

    var lista = this.modal.querySelector('#participacoes-lista');
    var todosItens = lista.querySelectorAll('.participacao-item-novo');

    if (todosItens.length === 0) {
      UI.toast('Nenhuma participa√ß√£o para salvar', 'info');
      return;
    }

    console.log('üìù Salvando', todosItens.length, 'participa√ß√µes (modificadas e n√£o modificadas)');

    var promises = [];

    todosItens.forEach(function(item) {
      var memberId = item.getAttribute('data-member-id');
      var dados = this.coletarDadosParticipacao(item);

      console.log('üíæ Salvando participa√ß√£o:', {memberId, dados});

      // Usa API para marcar participa√ß√£o
      var promise = API.markParticipacao(this.currentActivityId, memberId, dados)
        .then(function(result) {
          if (result.ok) {
            // Remove classe modified e atualiza valores iniciais para todos
            item.classList.remove('modified');
            this.atualizarValoresIniciais(item, dados);
            return {memberId, success: true};
          } else {
            return {memberId, success: false, error: result.error};
          }
        }.bind(this))
        .catch(function(error) {
          console.error('Erro ao salvar participa√ß√£o do membro', memberId, ':', error);
          return {memberId, success: false, error: error};
        });

      promises.push(promise);
    }.bind(this));

    Promise.all(promises)
      .then(function(results) {
        var sucessos = results.filter(function(r) { return r.success; }).length;
        var erros = results.filter(function(r) { return !r.success; }).length;

        if (erros === 0) {
          UI.toast('Todas as participa√ß√µes foram salvas!', 'success');
        } else if (sucessos > 0) {
          UI.toast(sucessos + ' participa√ß√µes salvas, ' + erros + ' falharam', 'warning');
        } else {
          UI.toast('Erro ao salvar participa√ß√µes', 'err');
        }

        console.log('‚úÖ Resultado do salvamento:', {sucessos, erros});
      })
      .catch(function(error) {
        console.error('‚ùå Erro geral no salvamento:', error);
        UI.toast('Erro ao salvar altera√ß√µes', 'err');
      });
  },

  coletarDadosParticipacao: function(item) {
    var participou = item.querySelector('[data-field="participacao"]').checked;

    return {
      participou: participou ? 'sim' : 'nao',
      // Se n√£o participou, for√ßa chegou_tarde e saiu_cedo como 'nao'
      chegou_tarde: participou && item.querySelector('[data-field="chegou_tarde"]').checked ? 'sim' : 'nao',
      saiu_cedo: participou && item.querySelector('[data-field="saiu_cedo"]').checked ? 'sim' : 'nao',
      observacoes: item.querySelector('[data-field="observacoes"]').value.trim()
    };
  },

  atualizarValoresIniciais: function(item, dados) {
    item.setAttribute('data-initial-participou', dados.participou === 'sim');
    item.setAttribute('data-initial-chegou-tarde', dados.chegou_tarde === 'sim');
    item.setAttribute('data-initial-saiu-cedo', dados.saiu_cedo === 'sim');
    item.setAttribute('data-initial-observacoes', dados.observacoes);
  },

  renderEstatisticas: function(stats) {
    console.log('üìä Renderizando estat√≠sticas:', stats);

    this.setElementText('stat-total-participantes', stats.total);
    this.setElementText('stat-percentual', stats.percentualParticipacao + '%');
    this.setElementText('stat-confirmaram', stats.confirmados);
    this.setElementText('stat-recusaram', stats.recusados);
    this.setElementText('stat-presentes', stats.participaram);
    this.setElementText('stat-ausentes-stat', stats.ausentes);
    this.setElementText('stat-pendentes', stats.pendentes);
  },

  setElementText: function(id, text) {
    var el = this.modal.querySelector('#' + id);
    if (el) el.textContent = text || '-';
  },

  findActivityById: function(activityId) {
    if (!State.cache || !State.cache.atividades) return null;

    for (var i = 0; i < State.cache.atividades.length; i++) {
      if (State.cache.atividades[i].id === activityId) {
        return State.cache.atividades[i];
      }
    }
    return null;
  }
};

// Fun√ß√£o global para abrir modal de participa√ß√µes
function openParticipacaoModal(activityId) {
  console.log('üöÄ openParticipacaoModal chamada para:', activityId);

  if (!window.ParticipacaoSystem) {
    console.error('‚ùå ParticipacaoSystem n√£o dispon√≠vel - tentando inicializar...');

    // Tenta inicializar na hora
    if (window.ParticipacaoSystem) {
      window.ParticipacaoSystem.init();
    } else {
      UI.toast('Sistema de participa√ß√µes n√£o dispon√≠vel', 'err');
      return;
    }
  }

  // Verifica se o modal foi criado
  if (!ParticipacaoSystem.modal) {
    console.log('üîÑ Modal n√£o existe, criando...');
    ParticipacaoSystem.init();
  }

  ParticipacaoSystem.openModal(activityId);
}

// Fun√ß√£o para debug manual
window.debugParticipacaoSystem = function() {
  console.log('üîç Debug ParticipacaoSystem:');
  console.log('- window.ParticipacaoSystem:', !!window.ParticipacaoSystem);
  console.log('- ParticipacaoSystem.modal:', !!ParticipacaoSystem?.modal);
  console.log('- Template tpl-participacoes-modal:', !!document.getElementById('tpl-participacoes-modal'));

  if (window.ParticipacaoSystem) {
    console.log('üîÑ For√ßando inicializa√ß√£o...');
    ParticipacaoSystem.init();
  }
};

// Inicializa o sistema quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîÑ DOMContentLoaded - Inicializando ParticipacaoSystem');
  setTimeout(function() {
    if (window.ParticipacaoSystem) {
      console.log('‚úÖ ParticipacaoSystem encontrado, inicializando...');
      ParticipacaoSystem.init();
    } else {
      console.error('‚ùå ParticipacaoSystem n√£o encontrado!');
    }
  }, 100);
});

/* ===========================
   Sistema de Calend√°rio Modal
   =========================== */

window.CalendarModal = {
  modal: null,
  activeFilters: ['overdue', 'today'], // Filtros padr√£o
  onApply: null,
  currentDate: new Date(),
  selectedDates: new Set(),

  init: function() {
    console.log('üîß Inicializando CalendarModal...');
    this.modal = document.getElementById('calendar-modal');
    if (!this.modal) {
      console.error('‚ùå Modal de calend√°rio n√£o encontrado!');
      return;
    }

    console.log('‚úÖ Modal encontrado:', this.modal);
    this.setupEventListeners();
    this.initCalendar();
    this.updateFilterDisplay();
    console.log('‚úÖ CalendarModal inicializado com sucesso');
  },

  setupEventListeners: function() {
    var self = this;

    // Fechar modal
    var closeBtn = document.getElementById('calendar-modal-close');
    var cancelBtn = document.getElementById('calendar-modal-cancel');
    if (closeBtn) closeBtn.addEventListener('click', function() { self.close(); });
    if (cancelBtn) cancelBtn.addEventListener('click', function() { self.close(); });

    // Bot√µes de filtro
    var filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var filter = btn.getAttribute('data-filter');
        self.toggleFilter(filter, btn);
      });
    });

    // Navega√ß√£o do calend√°rio
    var prevBtn = document.getElementById('cal-prev-month');
    var nextBtn = document.getElementById('cal-next-month');
    if (prevBtn) prevBtn.addEventListener('click', function() { self.previousMonth(); });
    if (nextBtn) nextBtn.addEventListener('click', function() { self.nextMonth(); });

    // A√ß√µes
    var clearBtn = document.getElementById('cal-clear-selection');
    var applyBtn = document.getElementById('calendar-modal-apply');
    if (clearBtn) clearBtn.addEventListener('click', function() { self.clearAllFilters(); });
    if (applyBtn) applyBtn.addEventListener('click', function() { self.apply(); });

    // Sele√ß√£o personalizada
    var customBtn = document.getElementById('cal-select-custom');
    if (customBtn) customBtn.addEventListener('click', function() { self.enableCustomSelection(); });
  },

  toggleFilter: function(filter, button) {
    var index = this.activeFilters.indexOf(filter);

    if (filter === 'all') {
      // Limpar todos os outros filtros
      this.activeFilters = ['all'];
      this.selectedDates.clear();
    } else {
      // Remover 'all' se estiver ativo
      var allIndex = this.activeFilters.indexOf('all');
      if (allIndex > -1) this.activeFilters.splice(allIndex, 1);

      if (index > -1) {
        this.activeFilters.splice(index, 1);
      } else {
        this.activeFilters.push(filter);
      }
    }

    this.updateFilterDisplay();
    this.updateSelectionSummary();
  },

  updateFilterDisplay: function() {
    var buttons = document.querySelectorAll('.filter-btn');
    var self = this;

    buttons.forEach(function(btn) {
      var filter = btn.getAttribute('data-filter');
      if (self.activeFilters.indexOf(filter) > -1) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  },

  getFilterDates: function() {
    var dates = new Set();
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    var self = this;

    this.activeFilters.forEach(function(filter) {
      switch(filter) {
        case 'overdue':
          // Adiciona todas as datas antes de hoje
          for (var i = 1; i <= 365; i++) {
            var date = new Date(today);
            date.setDate(today.getDate() - i);
            dates.add(self.formatDate(date));
          }
          break;

        case 'today':
          dates.add(self.formatDate(today));
          break;

        case '10days':
          for (var i = 1; i <= 10; i++) {
            var date = new Date(today);
            date.setDate(today.getDate() + i);
            dates.add(self.formatDate(date));
          }
          break;

        case '30days':
          for (var i = 1; i <= 30; i++) {
            var date = new Date(today);
            date.setDate(today.getDate() + i);
            dates.add(self.formatDate(date));
          }
          break;

        case 'all':
          return null; // Sem filtro
      }
    });

    // Adicionar datas selecionadas manualmente
    this.selectedDates.forEach(function(date) {
      dates.add(date);
    });

    return dates.size > 0 ? Array.from(dates) : null;
  },

  formatDate: function(date) {
    return date.getFullYear() + '-' +
           String(date.getMonth() + 1).padStart(2, '0') + '-' +
           String(date.getDate()).padStart(2, '0');
  },

  updateSelectionSummary: function() {
    var summary = document.getElementById('cal-selection-count');
    if (!summary) return;

    var text = '';
    if (this.activeFilters.indexOf('all') > -1) {
      text = 'Todas as datas (sem filtro)';
    } else if (this.activeFilters.length === 0 && this.selectedDates.size === 0) {
      text = 'Nenhum filtro ativo';
    } else {
      var parts = [];
      if (this.activeFilters.indexOf('overdue') > -1) parts.push('Atrasados');
      if (this.activeFilters.indexOf('today') > -1) parts.push('Hoje');
      if (this.activeFilters.indexOf('10days') > -1) parts.push('10 dias');
      if (this.activeFilters.indexOf('30days') > -1) parts.push('30 dias');
      if (this.selectedDates.size > 0) parts.push(this.selectedDates.size + ' datas espec√≠ficas');

      text = 'Filtros ativos: ' + parts.join(', ');
    }

    summary.textContent = text;
  },

  clearAllFilters: function() {
    this.activeFilters = [];
    this.selectedDates.clear();
    this.updateFilterDisplay();
    this.updateSelectionSummary();
    this.renderCalendar();
  },

  enableCustomSelection: function() {
    // Limpar filtros padr√µes para permitir sele√ß√£o manual
    this.activeFilters = [];
    this.updateFilterDisplay();
    this.updateSelectionSummary();
    this.renderCalendar();
  },

  initCalendar: function() {
    this.renderCalendar();
  },

  renderCalendar: function() {
    var year = this.currentDate.getFullYear();
    var month = this.currentDate.getMonth();

    document.getElementById('cal-month-year').textContent =
      this.getMonthName(month) + ' ' + year;

    var grid = document.getElementById('cal-grid');
    var existingDays = grid.querySelectorAll('.calendar-day');
    existingDays.forEach(function(day) { day.remove(); });

    var firstDay = new Date(year, month, 1);
    var lastDay = new Date(year, month + 1, 0);
    var daysInMonth = lastDay.getDate();
    var startDay = firstDay.getDay();

    // Dias do m√™s anterior
    var prevMonth = new Date(year, month - 1, 0);
    for (var i = startDay - 1; i >= 0; i--) {
      var day = prevMonth.getDate() - i;
      var date = new Date(year, month - 1, day);
      this.createDayElement(date, true);
    }

    // Dias do m√™s atual
    for (var day = 1; day <= daysInMonth; day++) {
      var date = new Date(year, month, day);
      this.createDayElement(date, false);
    }

    // Dias do pr√≥ximo m√™s
    var totalCells = grid.querySelectorAll('.calendar-day').length;
    var nextMonthDays = 42 - totalCells;
    for (var day = 1; day <= nextMonthDays; day++) {
      var date = new Date(year, month + 1, day);
      this.createDayElement(date, true);
    }
  },

  createDayElement: function(date, otherMonth) {
    var dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    dayEl.textContent = date.getDate();

    var dateStr = this.formatDate(date);
    dayEl.setAttribute('data-date', dateStr);

    if (otherMonth) dayEl.classList.add('other-month');

    // Marcar hoje
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    var cellDate = new Date(date);
    cellDate.setHours(0, 0, 0, 0);
    if (cellDate.getTime() === today.getTime()) {
      dayEl.classList.add('today');
    }

    // Status da data (atrasado, pr√≥ximo, etc.)
    var status = this.getDateStatus(date);
    if (status !== 'normal') {
      dayEl.classList.add(status);
    }

    // Selecionado manualmente
    if (this.selectedDates.has(dateStr)) {
      dayEl.classList.add('selected');
    }

    // Event listener para sele√ß√£o manual
    var self = this;
    dayEl.addEventListener('click', function() {
      if (self.selectedDates.has(dateStr)) {
        self.selectedDates.delete(dateStr);
        dayEl.classList.remove('selected');
      } else {
        self.selectedDates.add(dateStr);
        dayEl.classList.add('selected');
      }
      self.updateSelectionSummary();
    });

    document.getElementById('cal-grid').appendChild(dayEl);
  },

  getDateStatus: function(date) {
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    var checkDate = new Date(date);
    checkDate.setHours(0, 0, 0, 0);

    var diffDays = Math.ceil((checkDate - today) / (1000 * 60 * 60 * 24));

    if (diffDays < 0) return 'overdue';
    if (diffDays === 0) return 'today';
    if (diffDays <= 7) return 'upcoming';
    return 'future';
  },

  getMonthName: function(month) {
    var names = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    return names[month];
  },

  previousMonth: function() {
    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
    this.renderCalendar();
  },

  nextMonth: function() {
    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
    this.renderCalendar();
  },

  show: function(callback) {
    console.log('üìÖ Mostrando modal de calend√°rio...');
    this.onApply = callback;

    if (!this.modal) {
      console.error('‚ùå Modal n√£o encontrado!');
      return;
    }

    this.modal.style.display = 'block';
    console.log('‚úÖ Modal display definido para block');

    // Verificar se o conte√∫do do modal foi inserido
    var modalContent = this.modal.querySelector('.modal-content');
    console.log('üì¶ Modal content encontrado:', modalContent);

    if (!modalContent) {
      console.error('‚ùå Modal content n√£o encontrado! HTML atual:', this.modal.innerHTML);
    }

    // Inicializar modal na primeira exibi√ß√£o
    if (!this.modal.querySelector('.calendar-day')) {
      console.log('üîÑ Inicializando calend√°rio...');
      this.init();
    }
  },

  close: function() {
    this.modal.style.display = 'none';
  },

  apply: function() {
    var dates = this.getFilterDates();
    if (this.onApply) {
      this.onApply(dates);
    }
    this.close();
  }
};

// Tamb√©m inicializa quando o window carrega (backup)
window.addEventListener('load', function() {
  console.log('üîÑ Window load - Verificando ParticipacaoSystem');
  if (window.ParticipacaoSystem && !window.ParticipacaoSystem.modal) {
    console.log('‚úÖ Inicializando ParticipacaoSystem como backup');
    ParticipacaoSystem.init();
  }
});
</script>